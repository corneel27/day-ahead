{% extends "base.html" %}
{% block selectie %}{% endblock %}
{% block content %}

<!-- Help System CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='config_help.css') }}">

<!-- Home Assistant Entity Search CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='config_ha_entities.css') }}">

<div class="config-container">
  <input type="hidden" id="current_menu" name="current_menu" value="settings">
  
  <!-- Tab Selection -->
  <div class="selector-container">
    <div class="spacer">
      <div class="select setting">
        <button id="tab-options" class="btn chosen btn_mid tab-button" data-tab="options">Options</button>
        <button id="tab-secrets" class="btn btn_mid tab-button" data-tab="secrets">Secrets</button>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="spacer">
      <div class="select action">
        <span style="display:block; float:left; padding:10px"><b>JSON Editor</b></span>
        <button id="btn-save" class="btn btn_mid" title="Save changes">
          <img src="static/update.png" alt="save" border="0" style="display:inline-block; height:1em; width:auto;" />
        </button>
        <button id="btn-cancel" class="btn btn_mid" title="Cancel changes">
          <img src="static/cancel.png" alt="cancel" border="0" style="display:inline-block; height:1em; width:auto;" />
        </button>
      </div>
    </div>
  </div>

  <!-- Message Area -->
  <div id="message-area" class="message" style="display:none;"></div>

  <!-- Unsaved Changes Warning -->
  <div id="unsaved-warning" class="warning-banner" style="display:none;">
    ⚠️ You have unsaved changes. Click Save to persist your changes.
  </div>

  <div class="clear"></div>

  <!-- Options Editor -->
  <div id="editor-options" class="editor-panel" style="display:block;">
    <div class="options-ui">
      <!-- Options Sub-tabs -->
      <div class="options-tabs">
        <button class="option-tab-btn active" data-option-tab="general">General</button>
        <button class="option-tab-btn" data-option-tab="database">Database</button>
        <button class="option-tab-btn" data-option-tab="dashboard">Dashboard</button>
        <button class="option-tab-btn" data-option-tab="prices">Prices</button>
        <button class="option-tab-btn" data-option-tab="optimisations">Optimisations</button>
        <button class="option-tab-btn" data-option-tab="reports">Reports</button>
        <button class="option-tab-btn" data-option-tab="scheduler">Scheduler</button>
      </div>
      
      <!-- General Options -->
      <div id="options-general" class="option-tab-content" style="display:block;">
        <div class="option-section">
          <h4>General Configuration</h4>
          <div class="options-list">
            <!-- General options will be dynamically added here -->
          </div>
        </div>
      </div>
      
      <!-- Optimisations Options -->
      <div id="options-optimisations" class="option-tab-content" style="display:none;">
        <div class="option-section">
          <h4>Optimisation Configuration</h4>
          
          <!-- Optimisation Sub-tabs -->
          <div class="optimisation-tabs">
            <button class="optimisation-tab-btn active" data-optimisation-tab="solar">Solar</button>
            <button class="optimisation-tab-btn" data-optimisation-tab="battery">Battery</button>
            <button class="optimisation-tab-btn" data-optimisation-tab="ev">Electric Vehicle</button>
            <button class="optimisation-tab-btn" data-optimisation-tab="machine">Machine</button>
            <button class="optimisation-tab-btn" data-optimisation-tab="boiler">Boiler</button>
            <button class="optimisation-tab-btn" data-optimisation-tab="heating">Heating</button>
          </div>
          
          <!-- Solar Optimisations -->
          <div id="optimisations-solar" class="optimisation-tab-content" style="display:block;">
            <div class="optimisations-header">
              <button id="btn-add-solar" class="btn btn-add">+ Add Solar Optimisation</button>
            </div>
            <div id="solar-list" class="optimisations-list">
              <!-- Solar optimisations will be dynamically added here -->
            </div>
          </div>
          
          <!-- Battery Optimisations -->
          <div id="optimisations-battery" class="optimisation-tab-content" style="display:none;">
            <div class="optimisations-header">
              <button id="btn-add-battery" class="btn btn-add">+ Add Battery Optimisation</button>
            </div>
            <div id="battery-list" class="optimisations-list">
              <!-- Battery optimisations will be dynamically added here -->
            </div>
          </div>
          
          <!-- Electric Vehicle Optimisations -->
          <div id="optimisations-ev" class="optimisation-tab-content" style="display:none;">
            <div class="optimisations-header">
              <button id="btn-add-ev" class="btn btn-add">+ Add EV Optimisation</button>
            </div>
            <div id="ev-list" class="optimisations-list">
              <!-- EV optimisations will be dynamically added here -->
            </div>
          </div>
          
          <!-- Machine Optimisations -->
          <div id="optimisations-machine" class="optimisation-tab-content" style="display:none;">
            <div class="optimisations-header">
              <button id="btn-add-machine" class="btn btn-add">+ Add Machine Optimisation</button>
            </div>
            <div id="machine-list" class="optimisations-list">
              <!-- Machine optimisations will be dynamically added here -->
            </div>
          </div>
          
          <!-- Boiler Optimisation -->
          <div id="optimisations-boiler" class="optimisation-tab-content" style="display:none;">
            <div class="optimisations-header">
              <span class="optimisation-note">Configure water heater/boiler optimisation</span>
            </div>
            <div id="boiler-config" class="optimisations-list">
              <!-- Boiler configuration will be dynamically added here -->
            </div>
          </div>
          
          <!-- Heating Optimisation -->
          <div id="optimisations-heating" class="optimisation-tab-content" style="display:none;">
            <div class="optimisations-header">
              <span class="optimisation-note">Configure heating system optimisation</span>
            </div>
            <div id="heating-config" class="optimisations-list">
              <!-- Heating configuration will be dynamically added here -->
            </div>
          </div>
        </div>
      </div>
      
      <!-- Database Options -->
      <div id="options-database" class="option-tab-content" style="display:none;">
        <div class="option-section">
          <h4>Database Configuration</h4>
          <div class="options-list">
            <!-- Database options will be dynamically added here -->
          </div>
        </div>
      </div>
      
      <!-- Dashboard Options -->
      <div id="options-dashboard" class="option-tab-content" style="display:none;">
        <div class="option-section">
          <h4>Dashboard Configuration</h4>
          <div class="options-list">
            <!-- Dashboard options will be dynamically added here -->
          </div>
        </div>
      </div>

      <!-- Prices Options -->
      <div id="options-prices" class="option-tab-content" style="display:none;">
        <div class="option-section">
          <h4>Prices Configuration</h4>
          <p class="form-help">Configure energy pricing, taxes, and supplier costs</p>
          
          <div class="prices-section">
            <h5>Invoice Settings</h5>
            <div class="form-row">
              <div class="form-group">
                <label for="prices-last-invoice" data-help-category="prices" data-help-field="last_invoice">Last Invoice Date:</label>
                <input type="date" id="prices-last-invoice" class="form-input">
              </div>
              
              <div class="form-group">
                <label for="prices-tax-refund" data-help-category="prices" data-help-field="tax_refund">Tax Refund:</label>
                <select id="prices-tax-refund" class="form-input">
                  <option value="False">False</option>
                  <option value="True">True</option>
                </select>
              </div>
            </div>
          </div>

          <div class="prices-section">
            <h5>Regular Tariffs</h5>
            <div class="form-row">
              <div class="form-group">
                <label for="prices-regular-high" data-help-category="prices" data-help-field="regular_high">Regular High (€/kWh):</label>
                <input type="number" id="prices-regular-high" class="form-input" 
                       placeholder="0.50" step="0.01">
              </div>
              
              <div class="form-group">
                <label for="prices-regular-low" data-help-category="prices" data-help-field="regular_low">Regular Low (€/kWh):</label>
                <input type="number" id="prices-regular-low" class="form-input" 
                       placeholder="0.40" step="0.01">
              </div>
            </div>
            
            <div class="form-group">
              <label for="prices-switch-to-low" data-help-category="prices" data-help-field="switch_to_low">Switch to Low (hour):</label>
              <p class="form-help">Hour when switching to low tariff (0-23)</p>
              <input type="number" id="prices-switch-to-low" class="form-input" 
                     placeholder="23" min="0" max="23">
            </div>
          </div>

          <div class="prices-section">
            <h5>Energy Taxes</h5>
            <p class="form-help">Date-based tax rates (format: YYYY-MM-DD: rate)</p>
            
            <div class="form-group">
              <label for="prices-energy-taxes-consumption" data-help-category="prices" data-help-field="energy_taxes_consumption">Energy Taxes Consumption:</label>
              <div class="json-field-container">
                <textarea id="prices-energy-taxes-consumption" class="form-input json-textarea" rows="4" 
                          placeholder='{"2022-01-01": 0.06729, "2023-01-01": 0.12599}'></textarea>
                <button class="btn btn-secondary btn-json-edit" onclick="openJSONEditor('prices-energy-taxes-consumption', 'Energy Taxes Consumption')">
                  <span class="material-icons">edit</span> Edit
                </button>
              </div>
            </div>
            
            <div class="form-group">
              <label for="prices-energy-taxes-production" data-help-category="prices" data-help-field="energy_taxes_production">Energy Taxes Production:</label>
              <div class="json-field-container">
                <textarea id="prices-energy-taxes-production" class="form-input json-textarea" rows="4" 
                          placeholder='{"2022-01-01": 0.06729, "2023-01-01": 0.12599}'></textarea>
                <button class="btn btn-secondary btn-json-edit" onclick="openJSONEditor('prices-energy-taxes-production', 'Energy Taxes Production')">
                  <span class="material-icons">edit</span> Edit
                </button>
              </div>
            </div>
          </div>

          <div class="prices-section">
            <h5>Supplier Costs</h5>
            <p class="form-help">Date-based supplier costs (format: YYYY-MM-DD: cost)</p>
            
            <div class="form-group">
              <label for="prices-cost-supplier-consumption" data-help-category="prices" data-help-field="cost_supplier_consumption">Cost Supplier Consumption:</label>
              <div class="json-field-container">
                <textarea id="prices-cost-supplier-consumption" class="form-input json-textarea" rows="4" 
                          placeholder='{"2022-01-01": 0.002, "2023-03-01": 0.018}'></textarea>
                <button class="btn btn-secondary btn-json-edit" onclick="openJSONEditor('prices-cost-supplier-consumption', 'Cost Supplier Consumption')">
                  <span class="material-icons">edit</span> Edit
                </button>
              </div>
            </div>
            
            <div class="form-group">
              <label for="prices-cost-supplier-production" data-help-category="prices" data-help-field="cost_supplier_production">Cost Supplier Production:</label>
              <div class="json-field-container">
                <textarea id="prices-cost-supplier-production" class="form-input json-textarea" rows="4" 
                          placeholder='{"2022-01-01": 0.002, "2023-03-01": 0.018}'></textarea>
                <button class="btn btn-secondary btn-json-edit" onclick="openJSONEditor('prices-cost-supplier-production', 'Cost Supplier Production')">
                  <span class="material-icons">edit</span> Edit
                </button>
              </div>
            </div>
          </div>

          <div class="prices-section">
            <h5>VAT Rates</h5>
            <p class="form-help">Date-based VAT percentages (format: YYYY-MM-DD: percentage)</p>
            
            <div class="form-group">
              <label for="prices-vat-consumption" data-help-category="prices" data-help-field="vat_consumption">VAT Consumption (%):</label>
              <div class="json-field-container">
                <textarea id="prices-vat-consumption" class="form-input json-textarea" rows="3" 
                          placeholder='{"2022-01-01": 21, "2022-07-01": 9}'></textarea>
                <button class="btn btn-secondary btn-json-edit" onclick="openJSONEditor('prices-vat-consumption', 'VAT Consumption')">
                  <span class="material-icons">edit</span> Edit
                </button>
              </div>
            </div>
            
            <div class="form-group">
              <label for="prices-vat-production" data-help-category="prices" data-help-field="vat_production">VAT Production (%):</label>
              <div class="json-field-container">
                <textarea id="prices-vat-production" class="form-input json-textarea" rows="3" 
                          placeholder='{"2022-01-01": 21, "2022-07-01": 9}'></textarea>
                <button class="btn btn-secondary btn-json-edit" onclick="openJSONEditor('prices-vat-production', 'VAT Production')">
                  <span class="material-icons">edit</span> Edit
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Reports Options -->
      <div id="options-reports" class="option-tab-content" style="display:none;">
        <div class="option-section">
          <h4>Reports Configuration</h4>
          <p class="form-help">Configure Home Assistant entities for energy reporting and tracking</p>
          
          <div class="report-section">
            <h5>Grid Entities</h5>
            <div class="report-entity-group">
              <label>Grid Consumption Entities:</label>
              <div id="report-grid-consumption-list" class="report-entity-list"></div>
              <button type="button" class="btn btn-add-small" onclick="addReportEntity('grid-consumption', 'sensor')">+ Add Entity</button>
            </div>
            
            <div class="report-entity-group">
              <label>Grid Production Entities:</label>
              <div id="report-grid-production-list" class="report-entity-list"></div>
              <button type="button" class="btn btn-add-small" onclick="addReportEntity('grid-production', 'sensor')">+ Add Entity</button>
            </div>
          </div>

          <div class="report-section">
            <h5>Solar Production Entities</h5>
            <div class="report-entity-group">
              <label>Solar Production AC Entities:</label>
              <div id="report-solar-ac-list" class="report-entity-list"></div>
              <button type="button" class="btn btn-add-small" onclick="addReportEntity('solar-ac', 'sensor')">+ Add Entity</button>
            </div>
            
            <div class="report-entity-group">
              <label>Solar Production DC Entities:</label>
              <div id="report-solar-dc-list" class="report-entity-list"></div>
              <button type="button" class="btn btn-add-small" onclick="addReportEntity('solar-dc', 'sensor')">+ Add Entity</button>
            </div>
          </div>

          <div class="report-section">
            <h5>Device Consumption Entities</h5>
            <div class="report-entity-group">
              <label>Electric Vehicle Consumption Entities:</label>
              <div id="report-ev-consumption-list" class="report-entity-list"></div>
              <button type="button" class="btn btn-add-small" onclick="addReportEntity('ev-consumption', 'sensor')">+ Add Entity</button>
            </div>
            
            <div class="report-entity-group">
              <label>Heat Pump (WP) Consumption Entities:</label>
              <div id="report-wp-consumption-list" class="report-entity-list"></div>
              <button type="button" class="btn btn-add-small" onclick="addReportEntity('wp-consumption', 'sensor')">+ Add Entity</button>
            </div>
            
            <div class="report-entity-group">
              <label>Boiler Consumption Entities:</label>
              <div id="report-boiler-consumption-list" class="report-entity-list"></div>
              <button type="button" class="btn btn-add-small" onclick="addReportEntity('boiler-consumption', 'sensor')">+ Add Entity</button>
            </div>

            <div class="report-entity-group">
              <label>Machine Consumption Entities:</label>
              <div id="report-machine-consumption-list" class="report-entity-list"></div>
              <button type="button" class="btn btn-add-small" onclick="addReportEntity('machine-consumption', 'sensor')">+ Add Entity</button>
            </div>
          </div>

          <div class="report-section">
            <h5>Battery Entities</h5>
            <div class="report-entity-group">
              <label>Battery Consumption Entities:</label>
              <div id="report-battery-consumption-list" class="report-entity-list"></div>
              <button type="button" class="btn btn-add-small" onclick="addReportEntity('battery-consumption', 'sensor')">+ Add Entity</button>
            </div>
            
            <div class="report-entity-group">
              <label>Battery Production Entities:</label>
              <div id="report-battery-production-list" class="report-entity-list"></div>
              <button type="button" class="btn btn-add-small" onclick="addReportEntity('battery-production', 'sensor')">+ Add Entity</button>
            </div>
          </div>

          <div class="report-section">
            <h5>CO2 Intensity</h5>
            <div class="report-entity-group">
              <label>CO2 Intensity Entities:</label>
              <div id="report-co2-intensity-list" class="report-entity-list"></div>
              <button type="button" class="btn btn-add-small" onclick="addReportEntity('co2-intensity', 'sensor')">+ Add Entity</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Scheduler Options -->
      <div id="options-scheduler" class="option-tab-content" style="display:none;">
        <div class="option-section">
          <h4>Task Scheduler Configuration</h4>
          <p class="form-help">Schedule tasks at specific times. Time format: "HHMM" (e.g., "0955") or use "xx" for wildcards (e.g., "xx00" = every hour at :00)</p>
          
          <div class="form-group">
            <label for="scheduler-active">Scheduler Active:</label>
            <select id="scheduler-active" class="form-input">
              <option value="True">True</option>
              <option value="False">False</option>
            </select>
          </div>

          <div class="form-section-header" style="margin-top: 20px;">
            <h4>Scheduled Tasks</h4>
            <button id="btn-add-scheduler-task" class="btn btn-add" style="float: right; margin-top: -5px;">+ Add Task</button>
          </div>
          
          <table class="scheduler-table">
            <thead>
              <tr>
                <th>Time</th>
                <th>Task</th>
                <th style="width: 60px;"></th>
              </tr>
            </thead>
            <tbody id="scheduler-tasks-tbody">
              <!-- Scheduler tasks will be added here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Secrets Editor -->
  <div id="editor-secrets" class="editor-panel" style="display:none;">
    <div class="secrets-ui">
      <div class="secrets-header">
        <button id="btn-add-secret" class="btn btn-add">+ Add New Secret</button>
      </div>
      
      <div id="secrets-list" class="secrets-list">
        <!-- Secrets will be dynamically added here -->
      </div>
      
      <!-- Add/Edit Secret Modal -->
      <div id="secret-modal" class="modal" style="display:none;">
        <div class="modal-content">
          <div class="modal-header">
            <h3 id="modal-title">Add Secret</h3>
            <span class="close">&times;</span>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label for="secret-key">Key:</label>
              <input type="text" id="secret-key" class="form-input" placeholder="Enter secret key">
            </div>
            <div class="form-group">
              <label for="secret-value">Value:</label>
              <input type="password" id="secret-value" class="form-input" placeholder="Enter secret value">
              <div class="toggle-visibility">
                <input type="checkbox" id="toggle-secret-visibility">
                <label for="toggle-secret-visibility">Show value</label>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button id="btn-save-secret" class="btn btn-primary">Save</button>
            <button id="btn-cancel-secret" class="btn btn-secondary">Cancel</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Add/Edit Solar Modal -->
  <div id="solar-modal" class="modal" style="display:none;">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h3 id="solar-modal-title">Add Solar Panel</h3>
        <span class="close solar-close">&times;</span>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="solar-name" data-help-category="solar" data-help-field="name">Name:</label>
          <input type="text" id="solar-name" class="form-input" placeholder="e.g., woning, garage">
        </div>
        <div class="form-group">
          <label for="solar-entity-pv-switch" data-help-category="solar" data-help-field="entity_pv_switch">Entity PV Switch:</label>
          <input type="text" id="solar-entity-pv-switch" class="form-input" placeholder="input_boolean.pv_xxx_aan_uit">
        </div>
        
        <div class="form-section-header">
          <h4>Strings Configuration</h4>
          <p class="form-help">Add multiple strings or leave empty to use direct configuration</p>
        </div>
        
        <div id="solar-strings-container" class="strings-container-scrollable">
          <!-- Strings will be added here -->
        </div>
        
        <button id="btn-add-string" class="btn btn-add">+ Add String</button>
        
        <div class="form-section-header" style="margin-top: 20px;">
          <h4>Direct Configuration (used if no strings)</h4>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="solar-tilt" data-help-category="solar" data-help-field="tilt">Tilt (degrees):</label>
            <input type="number" id="solar-tilt" class="form-input" placeholder="e.g., 45" step="1">
          </div>
          <div class="form-group">
            <label for="solar-orientation" data-help-category="solar" data-help-field="orientation">Orientation (degrees):</label>
            <input type="number" id="solar-orientation" class="form-input" placeholder="e.g., 5" step="1">
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="solar-capacity" data-help-category="solar" data-help-field="capacity">Capacity (kWp):</label>
            <input type="number" id="solar-capacity" class="form-input" placeholder="e.g., 3.3" step="0.1">
          </div>
          <div class="form-group">
            <label for="solar-yield" data-help-category="solar" data-help-field="yield">Yield:</label>
            <input type="number" id="solar-yield" class="form-input" placeholder="e.g., 0.0065" step="0.0001">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="btn-save-solar" class="btn btn-primary">Save</button>
        <button id="btn-cancel-solar" class="btn btn-secondary">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Add/Edit Battery Modal -->
  <div id="battery-modal" class="modal" style="display:none;">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h3 id="battery-modal-title">Add Battery</h3>
        <span class="close battery-close">&times;</span>
      </div>
      <div class="modal-body">
        <!-- Battery Tabs -->
        <div class="battery-tabs">
          <button class="battery-tab-btn active" data-tab="battery-general">General</button>
          <button class="battery-tab-btn" data-tab="battery-power">Power & Efficiency</button>
          <button class="battery-tab-btn" data-tab="battery-stages">Charge/Discharge Stages</button>
          <button class="battery-tab-btn" data-tab="battery-reduced-hours">Reduced Hours</button>
          <button class="battery-tab-btn" data-tab="battery-control">Control Entities</button>
          <button class="battery-tab-btn" data-tab="battery-solar">DC Solar Panels</button>
        </div>

        <!-- General Tab -->
        <div id="battery-general" class="battery-tab-content active">
          <div class="form-group">
            <label for="battery-name" data-help-category="battery" data-help-field="name">Name:</label>
            <input type="text" id="battery-name" class="form-input" placeholder="e.g., Accu1">
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="battery-entity-level" data-help-category="battery" data-help-field="entity_level">Entity Actual Level:</label>
              <input type="text" id="battery-entity-level" class="form-input" placeholder="sensor.battery_soc">
            </div>
            <div class="form-group">
              <label for="battery-capacity" data-help-category="battery" data-help-field="capacity">Capacity (kWh):</label>
              <input type="number" id="battery-capacity" class="form-input" placeholder="e.g., 28" step="0.1">
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="battery-upper-limit" data-help-category="battery" data-help-field="upper_limit">Upper Limit (%):</label>
              <input type="number" id="battery-upper-limit" class="form-input" placeholder="e.g., 98" step="1">
            </div>
            <div class="form-group">
              <label for="battery-lower-limit" data-help-category="battery" data-help-field="lower_limit">Lower Limit (%):</label>
              <input type="number" id="battery-lower-limit" class="form-input" placeholder="e.g., 21" step="1">
            </div>
            <div class="form-group">
              <label for="battery-optimal-lower" data-help-category="battery" data-help-field="optimal_lower">Optimal Lower Level (%):</label>
              <input type="number" id="battery-optimal-lower" class="form-input" placeholder="e.g., 21" step="1">
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="battery-entity-min-soc" data-help-category="battery" data-help-field="entity_min_soc">Entity Min SOC End Opt:</label>
              <input type="text" id="battery-entity-min-soc" class="form-input" placeholder="input_number.min_soc_einde_opt">
            </div>
            <div class="form-group">
              <label for="battery-entity-max-soc" data-help-category="battery" data-help-field="entity_max_soc">Entity Max SOC End Opt:</label>
              <input type="text" id="battery-entity-max-soc" class="form-input" placeholder="input_number.max_soc_einde_opt">
            </div>
          </div>
        </div>

        <!-- Power & Efficiency Tab -->
        <div id="battery-power" class="battery-tab-content">
          <div class="form-section-header">
            <h4>Power Settings</h4>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="battery-minimum-power" data-help-category="battery" data-help-field="minimum_power">Minimum Power (W):</label>
              <input type="number" id="battery-minimum-power" class="form-input" placeholder="e.g., 1000" step="1">
            </div>
            <div class="form-group">
              <label for="battery-cycle-cost" data-help-category="battery" data-help-field="cycle_cost">Cycle Cost (€):</label>
              <input type="number" id="battery-cycle-cost" class="form-input" placeholder="e.g., 0.01" step="0.001">
            </div>
          </div>
          
          <div class="form-section-header" style="margin-top: 20px;">
            <h4>DC to Battery Conversion</h4>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="battery-dc-to-bat-eff" data-help-category="battery" data-help-field="dc_to_bat_efficiency">DC to Battery Efficiency:</label>
              <input type="number" id="battery-dc-to-bat-eff" class="form-input" placeholder="e.g., 0.93" step="0.01">
            </div>
            <div class="form-group">
              <label for="battery-dc-to-bat-power" data-help-category="battery" data-help-field="dc_to_bat_power">DC to Battery Max Power (W):</label>
              <input type="number" id="battery-dc-to-bat-power" class="form-input" placeholder="e.g., 7500" step="1">
            </div>
          </div>
          
          <div class="form-section-header" style="margin-top: 20px;">
            <h4>Battery to DC Conversion</h4>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="battery-bat-to-dc-eff" data-help-category="battery" data-help-field="bat_to_dc_efficiency">Battery to DC Efficiency:</label>
              <input type="number" id="battery-bat-to-dc-eff" class="form-input" placeholder="e.g., 0.93" step="0.01">
            </div>
            <div class="form-group">
              <label for="battery-bat-to-dc-power" data-help-category="battery" data-help-field="bat_to_dc_power">Battery to DC Max Power (W):</label>
              <input type="number" id="battery-bat-to-dc-power" class="form-input" placeholder="e.g., 7500" step="1">
            </div>
          </div>
        </div>

        <!-- Charge/Discharge Stages Tab -->
        <div id="battery-stages" class="battery-tab-content">
          <div class="form-section-header">
            <h4>Charge Stages</h4>
            <p class="form-help">Power (W) and efficiency pairs for charging</p>
          </div>
          <div id="battery-charge-stages-container" class="stages-container-scrollable">
            <!-- Charge stages will be added here -->
          </div>
          <button id="btn-add-charge-stage" class="btn btn-add">+ Add Charge Stage</button>
          
          <div class="form-section-header" style="margin-top: 30px;">
            <h4>Discharge Stages</h4>
            <p class="form-help">Power (W) and efficiency pairs for discharging</p>
          </div>
          <div id="battery-discharge-stages-container" class="stages-container-scrollable">
            <!-- Discharge stages will be added here -->
          </div>
          <button id="btn-add-discharge-stage" class="btn btn-add">+ Add Discharge Stage</button>
        </div>

        <!-- Reduced Hours Tab -->
        <div id="battery-reduced-hours" class="battery-tab-content">
          <div class="form-section-header">
            <h4>Reduced Hours</h4>
            <p class="form-help">Hour (0-23) and power limit pairs. Define hours where battery power is limited.</p>
          </div>
          <div id="battery-reduced-hours-container" class="reduced-hours-container">
            <!-- Reduced hours will be added here -->
          </div>
          <button id="btn-add-reduced-hour" class="btn btn-add">+ Add Reduced Hour</button>
        </div>

        <!-- Control Entities Tab -->
        <div id="battery-control" class="battery-tab-content">
          <div class="form-section-header">
            <h4>Control Entities</h4>
            <p class="form-help">Home Assistant entities used to control and monitor the battery system</p>
          </div>
          
          <div class="form-group">
            <label for="battery-entity-power-feedin" data-help-category="battery" data-help-field="entity_power_feedin">Entity Set Power Feedin:</label>
            <input type="text" id="battery-entity-power-feedin" class="form-input" placeholder="input_number.feedin_grid">
          </div>
          
          <div class="form-group">
            <label for="battery-entity-operating-mode" data-help-category="battery" data-help-field="entity_operating_mode">Entity Set Operating Mode:</label>
            <input type="text" id="battery-entity-operating-mode" class="form-input" placeholder="input_select.ess_operating_mode">
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="battery-entity-stop-inverter" data-help-category="battery" data-help-field="entity_stop_inverter">Entity Stop Inverter:</label>
              <input type="text" id="battery-entity-stop-inverter" class="form-input" placeholder="input_datetime.stop_victron">
            </div>
            <div class="form-group">
              <label for="battery-entity-balance-switch" data-help-category="battery" data-help-field="entity_balance_switch">Entity Balance Switch:</label>
              <input type="text" id="battery-entity-balance-switch" class="form-input" placeholder="input_boolean.balanceer_grid">
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="battery-entity-from-battery" data-help-category="battery" data-help-field="entity_from_battery">Entity From Battery:</label>
              <input type="text" id="battery-entity-from-battery" class="form-input" placeholder="input_number.from_battery">
            </div>
            <div class="form-group">
              <label for="battery-entity-from-pv" data-help-category="battery" data-help-field="entity_from_pv">Entity From PV:</label>
              <input type="text" id="battery-entity-from-pv" class="form-input" placeholder="input_number.from_pv">
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="battery-entity-from-ac" data-help-category="battery" data-help-field="entity_from_ac">Entity From AC:</label>
              <input type="text" id="battery-entity-from-ac" class="form-input" placeholder="input_number.from_ac">
            </div>
            <div class="form-group">
              <label for="battery-entity-calculated-soc" data-help-category="battery" data-help-field="entity_calculated_soc">Entity Calculated SOC:</label>
              <input type="text" id="battery-entity-calculated-soc" class="form-input" placeholder="input_number.calculated_soc">
            </div>
          </div>
        </div>

        <!-- DC Solar Panels Tab -->
        <div id="battery-solar" class="battery-tab-content">
          <div class="form-section-header">
            <h4>DC-Connected Solar Panels</h4>
            <p class="form-help">Solar panels connected to the battery DC side</p>
          </div>
          
          <div id="battery-solar-list-container" class="optimisation-list">
            <!-- DC solar panels will be listed here -->
          </div>
          <button id="btn-add-battery-solar" class="btn btn-add">+ Add DC Solar Panel</button>
        </div>
      </div>
      <div class="modal-footer">
        <button id="btn-save-battery" class="btn btn-primary">Save</button>
        <button id="btn-cancel-battery" class="btn btn-secondary">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Add/Edit EV Modal -->
  <div id="ev-modal" class="modal" style="display:none;">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h3 id="ev-modal-title">Add Electric Vehicle</h3>
        <span class="close ev-close">&times;</span>
      </div>
      <div class="modal-body">
        <!-- EV Tabs -->
        <div class="ev-tabs">
          <button class="ev-tab-btn active" data-tab="ev-general">General</button>
          <button class="ev-tab-btn" data-tab="ev-charging-control">Charging Control</button>
          <button class="ev-tab-btn" data-tab="ev-charge-stages">Charge Stages</button>
          <button class="ev-tab-btn" data-tab="ev-scheduler">Charge Scheduler</button>
        </div>

        <!-- General Tab -->
        <div id="ev-general" class="ev-tab-content active">
          <div class="form-group">
            <label for="ev-name" data-help-category="ev" data-help-field="name">Name:</label>
            <input type="text" id="ev-name" class="form-input" placeholder="e.g., Golf GTE">
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="ev-capacity" data-help-category="ev" data-help-field="capacity">Capacity (kWh):</label>
              <input type="number" id="ev-capacity" class="form-input" placeholder="e.g., 6.3" step="0.1">
            </div>
            <div class="form-group">
              <label for="ev-charge-three-phase" data-help-category="ev" data-help-field="charge_three_phase">Charge Three Phase:</label>
              <select id="ev-charge-three-phase" class="form-input">
                <option value="False">False</option>
                <option value="True">True</option>
              </select>
            </div>
          </div>
          
          <div class="form-section-header" style="margin-top: 20px;">
            <h4>Vehicle Entities</h4>
          </div>
          
          <div class="form-group">
            <label for="ev-entity-position" data-help-category="ev" data-help-field="entity_position">Entity Position:</label>
            <input type="text" id="ev-entity-position" class="form-input" placeholder="device_tracker.vehicle_position">
          </div>
          
          <div class="form-group">
            <label for="ev-entity-max-amperage" data-help-category="ev" data-help-field="entity_max_amperage">Entity Max Amperage:</label>
            <input type="text" id="ev-entity-max-amperage" class="form-input" placeholder="sensor.charger_max_ampere">
          </div>
          
          <div class="form-group">
            <label for="ev-entity-actual-level" data-help-category="ev" data-help-field="entity_actual_level">Entity Actual Level:</label>
            <input type="text" id="ev-entity-actual-level" class="form-input" placeholder="sensor.battery_level">
          </div>
          
          <div class="form-group">
            <label for="ev-entity-plugged-in" data-help-category="ev" data-help-field="entity_plugged_in">Entity Plugged In:</label>
            <input type="text" id="ev-entity-plugged-in" class="form-input" placeholder="binary_sensor.external_power">
          </div>
        </div>

        <!-- Charging Control Tab -->
        <div id="ev-charging-control" class="ev-tab-content">
          <div class="form-section-header">
            <h4>Charging Control</h4>
            <p class="form-help">Configure charging control entities</p>
          </div>
          
          <div class="form-group">
            <label for="ev-charge-switch" data-help-category="ev" data-help-field="charge_switch">Charge Switch:</label>
            <input type="text" id="ev-charge-switch" class="form-input" placeholder="switch.charging">
          </div>
          
          <div class="form-group">
            <label for="ev-entity-set-charging-ampere" data-help-category="ev" data-help-field="entity_set_charging_ampere">Entity Set Charging Ampere:</label>
            <input type="text" id="ev-entity-set-charging-ampere" class="form-input" placeholder="input_number.set_charging_ampere">
          </div>
          
          <div class="form-group">
            <label for="ev-entity-stop-charging" data-help-category="ev" data-help-field="entity_stop_charging">Entity Stop Charging:</label>
            <input type="text" id="ev-entity-stop-charging" class="form-input" placeholder="input_datetime.stop_charging">
          </div>
        </div>

        <!-- Charge Stages Tab -->
        <div id="ev-charge-stages" class="ev-tab-content">
          <div class="form-section-header">
            <h4>Charge Stages</h4>
            <p class="form-help">Ampere and efficiency pairs for charging</p>
          </div>
          <div id="ev-charge-stages-container" class="stages-container-scrollable">
            <!-- Charge stages will be added here -->
          </div>
          <button id="btn-add-ev-charge-stage" class="btn btn-add">+ Add Charge Stage</button>
        </div>

        <!-- Charge Scheduler Tab -->
        <div id="ev-scheduler" class="ev-tab-content">
          <div class="form-section-header">
            <h4>Charge Scheduler</h4>
            <p class="form-help">Configure automatic charging schedule</p>
          </div>
          
          <div class="form-group">
            <label for="ev-scheduler-entity-set-level" data-help-category="ev" data-help-field="scheduler_entity_set_level">Entity Set Level:</label>
            <input type="text" id="ev-scheduler-entity-set-level" class="form-input" placeholder="input_number.desired_charge_level">
          </div>
          
          <div class="form-group">
            <label for="ev-scheduler-level-margin" data-help-category="ev" data-help-field="scheduler_level_margin">Level Margin (%):</label>
            <input type="number" id="ev-scheduler-level-margin" class="form-input" placeholder="e.g., 1" step="1">
          </div>
          
          <div class="form-group">
            <label for="ev-scheduler-entity-ready-datetime" data-help-category="ev" data-help-field="scheduler_entity_ready_datetime">Entity Ready Datetime:</label>
            <input type="text" id="ev-scheduler-entity-ready-datetime" class="form-input" placeholder="input_datetime.ready_time">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="btn-save-ev" class="btn btn-primary">Save</button>
        <button id="btn-cancel-ev" class="btn btn-secondary">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Add/Edit Machine Modal -->
  <div id="machine-modal" class="modal" style="display:none;">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h3 id="machine-modal-title">Add Machine</h3>
        <span class="close machine-close">&times;</span>
      </div>
      <div class="modal-body">
        <!-- Machine Tabs -->
        <div class="machine-tabs">
          <button class="machine-tab-btn active" data-tab="machine-general">General</button>
          <button class="machine-tab-btn" data-tab="machine-programs">Programs</button>
          <button class="machine-tab-btn" data-tab="machine-entities">Control Entities</button>
        </div>

        <!-- General Tab -->
        <div id="machine-general" class="machine-tab-content active">
          <div class="form-group">
            <label for="machine-name" data-help-category="machine" data-help-field="name">Name:</label>
            <input type="text" id="machine-name" class="form-input" placeholder="e.g., wasmachine">
          </div>
        </div>

        <!-- Programs Tab -->
        <div id="machine-programs" class="machine-tab-content">
          <div class="form-section-header">
            <h4>Machine Programs</h4>
            <p class="form-help">Define programs with power consumption patterns (watts per interval)</p>
          </div>
          <div id="machine-programs-container" class="programs-container">
            <!-- Programs will be added here -->
          </div>
          <button id="btn-add-machine-program" class="btn btn-add">+ Add Program</button>
        </div>

        <!-- Control Entities Tab -->
        <div id="machine-entities" class="machine-tab-content">
          <div class="form-section-header">
            <h4>Control Entities</h4>
            <p class="form-help">Configure Home Assistant entities for machine control</p>
          </div>
          
          <div class="form-group">
            <label for="machine-entity-start-window" data-help-category="machine" data-help-field="entity_start_window">Entity Start Window:</label>
            <input type="text" id="machine-entity-start-window" class="form-input" placeholder="input_datetime.start_window_wasmachine">
          </div>
          
          <div class="form-group">
            <label for="machine-entity-end-window" data-help-category="machine" data-help-field="entity_end_window">Entity End Window:</label>
            <input type="text" id="machine-entity-end-window" class="form-input" placeholder="input_datetime.end_window_wasmachine">
          </div>
          
          <div class="form-group">
            <label for="machine-entity-selected-program" data-help-category="machine" data-help-field="entity_selected_program">Entity Selected Program:</label>
            <input type="text" id="machine-entity-selected-program" class="form-input" placeholder="input_select.program_wasmachine">
          </div>
          
          <div class="form-group">
            <label for="machine-entity-calculated-start" data-help-category="machine" data-help-field="entity_calculated_start">Entity Calculated Start:</label>
            <input type="text" id="machine-entity-calculated-start" class="form-input" placeholder="input_datetime.calculated_start_wasmachine">
          </div>
          
          <div class="form-group">
            <label for="machine-entity-calculated-end" data-help-category="machine" data-help-field="entity_calculated_end">Entity Calculated End:</label>
            <input type="text" id="machine-entity-calculated-end" class="form-input" placeholder="input_datetime.calculated_stop_wasmachine">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="btn-save-machine" class="btn btn-primary">Save</button>
        <button id="btn-cancel-machine" class="btn btn-secondary">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Add/Edit Machine Program Modal -->
  <div id="machine-program-modal" class="modal" style="display:none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="machine-program-modal-title">Add Program</h3>
        <span class="close machine-program-close">&times;</span>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="machine-program-name" data-help-category="machine" data-help-field="program_name">Program Name:</label>
          <input type="text" id="machine-program-name" class="form-input" placeholder="e.g., eco, normal, intensive">
        </div>
        
        <div class="form-group">
          <label for="machine-program-power" data-help-category="machine" data-help-field="program_power">Power Pattern (Watts):</label>
          <p class="form-help">Comma-separated power values for each time interval (e.g., 2000, 1500, 500, 400, 200, 300)</p>
          <input type="text" id="machine-program-power" class="form-input" placeholder="2000, 1500, 500, 400, 200, 300">
        </div>
      </div>
      <div class="modal-footer">
        <button id="btn-save-machine-program" class="btn btn-primary">Save</button>
        <button id="btn-cancel-machine-program" class="btn btn-secondary">Cancel</button>
      </div>
    </div>
  </div>

  <!-- JSON Date-Value Editor Modal -->
  <div id="json-editor-modal" class="modal" style="display:none;">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h3 id="json-editor-modal-title">Edit Date-Value Pairs</h3>
        <span class="close json-editor-close">&times;</span>
      </div>
      <div class="modal-body">
        <div class="form-section-header">
          <h4 id="json-editor-subtitle"></h4>
          <p class="form-help">Add or edit date-value pairs. Dates should be in YYYY-MM-DD format.</p>
        </div>
        
        <div id="json-entries-container" class="json-entries-container">
          <!-- Date-value entries will be added here -->
        </div>
        
        <button id="btn-add-json-entry" class="btn btn-add">+ Add Entry</button>
      </div>
      <div class="modal-footer">
        <button id="btn-save-json-editor" class="btn btn-primary">Save</button>
        <button id="btn-cancel-json-editor" class="btn btn-secondary">Cancel</button>
      </div>
    </div>
  </div>
</div>

<script>
  // State management
  let currentTab = 'options';
  let currentOptionTab = 'general'; // Track current options sub-tab
  let currentOptimisationTab = 'solar'; // Track current optimisation sub-tab
  let originalData = {
    options: null,
    secrets: null
  };
  let currentData = {
    options: null,
    secrets: null
  };
  let editingSecretKey = null; // Track which secret is being edited
  let editingSolarIndex = null; // Track which solar panel is being edited
  let solarStrings = []; // Track strings in solar modal
  let editingBatteryIndex = null; // Track which battery is being edited
  let batteryChargeStages = []; // Track charge stages in battery modal
  let batteryDischargeStages = []; // Track discharge stages in battery modal
  let batteryReducedHours = {}; // Track reduced hours in battery modal
  let batterySolarPanels = []; // Track DC solar panels in battery modal
  let editingBatterySolarIndex = null; // Track which DC solar panel is being edited (nested in battery)
  let solarModalContext = 'main'; // Track context: 'main' or 'battery' to avoid interference
  let editingEVIndex = null; // Track which EV is being edited
  let evChargeStages = []; // Track charge stages in EV modal
  let editingMachineIndex = null; // Track which machine is being edited
  let machinePrograms = []; // Track programs in machine modal
  let editingMachineProgramIndex = null; // Track which program is being edited
  let jsonEditorTargetField = null; // Track which JSON field is being edited
  let jsonEditorEntries = []; // Track date-value pairs in JSON editor

  // DOM elements
  const tabButtons = document.querySelectorAll('.tab-button');
  const editorOptions = document.getElementById('editor-options');
  const editorSecrets = document.getElementById('editor-secrets');
  const messageArea = document.getElementById('message-area');
  const unsavedWarning = document.getElementById('unsaved-warning');
  const btnSave = document.getElementById('btn-save');
  const btnCancel = document.getElementById('btn-cancel');
  
  // Options UI elements
  const optionTabButtons = document.querySelectorAll('.option-tab-btn');
  
  // Secrets UI elements
  const secretsList = document.getElementById('secrets-list');
  const secretModal = document.getElementById('secret-modal');
  const btnAddSecret = document.getElementById('btn-add-secret');
  const btnSaveSecret = document.getElementById('btn-save-secret');
  const btnCancelSecret = document.getElementById('btn-cancel-secret');
  const secretKeyInput = document.getElementById('secret-key');
  const secretValueInput = document.getElementById('secret-value');
  const toggleVisibility = document.getElementById('toggle-secret-visibility');
  const modalTitle = document.getElementById('modal-title');
  const modalClose = document.querySelector('.close');

  // Load data from API
  async function loadData() {
    try {
      // Load both options and secrets in parallel
      const [optionsResponse, secretsResponse] = await Promise.all([
        fetch('/api/settings/options.json'),
        fetch('/api/settings/secrets.json')
      ]);
      
      if (!optionsResponse.ok) throw new Error('Failed to load options');
      if (!secretsResponse.ok) throw new Error('Failed to load secrets');
      
      // Parse both responses
      originalData.options = await optionsResponse.json();
      originalData.secrets = await secretsResponse.json();
      
      currentData.options = JSON.parse(JSON.stringify(originalData.options));
      currentData.secrets = JSON.parse(JSON.stringify(originalData.secrets));
      
      // Render both UIs after both are loaded
      renderOptionsUI();
      renderSecretsList();

      checkForUnsavedChanges(); // Initial check
    } catch (error) {
      showMessage('Error loading data: ' + error.message, 'error');
    }
  }

  // Render options UI (placeholder for now)
  function renderOptionsUI() {
    renderOptimisationsOptions();
    renderGeneralOptions();
    renderDatabaseOptions();
    renderDashboardOptions();
    loadSchedulerConfiguration();
  }

  // Render Optimisations tab options
  function renderOptimisationsOptions() {
    renderSolarOptimisations();
    renderBatteryOptimisations();
    renderEVOptimisations();
    renderMachineOptimisations();
    renderBoilerConfig();
    renderHeatingConfig();
  }

  // Render Solar optimisations list
  function renderSolarOptimisations() {
    const container = document.getElementById('solar-list');
    container.innerHTML = '';
    
    // Get solar optimisations from top-level "solar" key
    const solarOptimisations = getOptionValue(['solar']) || [];
    
    if (solarOptimisations.length === 0) {
      container.innerHTML = '<div class="empty-state">No solar optimisations configured. Click the button above to add one.</div>';
      return;
    }
    
    // Render each solar optimisation
    solarOptimisations.forEach((opt, index) => {
      const item = createOptimisationItem(opt, index, 'solar');
      container.appendChild(item);
    });
  }

  // Render Battery optimisations list
  function renderBatteryOptimisations() {
    const container = document.getElementById('battery-list');
    container.innerHTML = '';
    
    // Get battery optimisations from top-level "battery" key
    const batteryOptimisations = getOptionValue(['battery']) || [];
    
    if (batteryOptimisations.length === 0) {
      container.innerHTML = '<div class="empty-state">No battery optimisations configured. Click the button above to add one.</div>';
      return;
    }
    
    batteryOptimisations.forEach((opt, index) => {
      const item = createOptimisationItem(opt, index, 'battery');
      container.appendChild(item);
    });
  }

  // Render Electric Vehicle optimisations list
  function renderEVOptimisations() {
    const container = document.getElementById('ev-list');
    container.innerHTML = '';
    
    // Get EV optimisations from top-level "electric vehicle" key
    const evOptimisations = getOptionValue(['electric vehicle']) || [];
    
    if (evOptimisations.length === 0) {
      container.innerHTML = '<div class="empty-state">No electric vehicle optimisations configured. Click the button above to add one.</div>';
      return;
    }
    
    evOptimisations.forEach((opt, index) => {
      const item = createOptimisationItem(opt, index, 'ev');
      container.appendChild(item);
    });
  }

  // Render Machine optimisations list
  function renderMachineOptimisations() {
    const container = document.getElementById('machine-list');
    container.innerHTML = '';
    
    // Get machine optimisations from top-level "machines" key
    const machineOptimisations = getOptionValue(['machines']) || [];
    
    if (machineOptimisations.length === 0) {
      container.innerHTML = '<div class="empty-state">No machine optimisations configured. Click the button above to add one.</div>';
      return;
    }
    
    machineOptimisations.forEach((opt, index) => {
      const item = createOptimisationItem(opt, index, 'machine');
      container.appendChild(item);
    });
  }

  // Render Boiler configuration
  function renderBoilerConfig() {
    const container = document.getElementById('boiler-config');
    container.innerHTML = '';
    
    // Get boiler configuration from top-level "boiler" key
    const boilerConfig = getOptionValue(['boiler']) || {};
    
    // Create boiler configuration form
    const boilerGroup = createOptionGroup('Boiler Configuration', [
      createCheckboxOption('Boiler Present', ['boiler', 'boiler present'], 'Enable boiler optimisation'),
      createTextOption('Entity Actual Temperature', ['boiler', 'entity actual temp.'], 'Home Assistant sensor for actual temperature'),
      createTextOption('Entity Setpoint', ['boiler', 'entity setpoint'], 'Home Assistant sensor for setpoint temperature'),
      createTextOption('Entity Hysterese', ['boiler', 'entity hysterese'], 'Home Assistant sensor for hysteresis'),
      createNumberOption('COP (Coefficient of Performance)', ['boiler', 'cop'], 'Heat pump efficiency coefficient'),
      createNumberOption('Cooling Rate (°C/hour)', ['boiler', 'cooling rate'], 'Temperature drop per hour when not heating'),
      createNumberOption('Volume (liters)', ['boiler', 'volume'], 'Water tank volume in liters'),
      createNumberOption('Heating Allowed Below (°C)', ['boiler', 'heating allowed below'], 'Maximum temperature to start heating'),
      createNumberOption('Electric Power (Watts)', ['boiler', 'elec. power'], 'Electrical power consumption'),
      createTextOption('Activate Service', ['boiler', 'activate service'], 'Home Assistant service type (e.g., "press")'),
      createTextOption('Activate Entity', ['boiler', 'activate entity'], 'Home Assistant entity to activate heating')
    ]);
    
    container.appendChild(boilerGroup);
  }

  // Render Heating configuration
  function renderHeatingConfig() {
    const container = document.getElementById('heating-config');
    container.innerHTML = '';
    
    // Get heating configuration from top-level "heating" key
    const heatingConfig = getOptionValue(['heating']) || {};
    
    // Basic heating settings
    const basicGroup = createOptionGroup('Heating Configuration', [
      createCheckboxOption('Heater Present', ['heating', 'heater present'], 'Enable heating optimisation'),
      createTextOption('Entity HP Enabled', ['heating', 'entity hp enabled'], 'Home Assistant binary sensor for heat pump status'),
      createNumberOption('Degree Days Factor', ['heating', 'degree days factor'], 'Factor for degree days calculation'),
      createSelectOption('Adjustment Method', ['heating', 'adjustment'], ['on/off', 'power', 'heating curve'], 'Heating adjustment method'),
      createTextOption('Entity Adjust Heating Curve', ['heating', 'entity adjust heating curve'], 'Home Assistant entity for heating curve adjustment'),
      createNumberOption('Adjustment Factor', ['heating', 'adjustment factor'], 'Factor for heating curve adjustment')
    ]);
    
    container.appendChild(basicGroup);
    
    // Heating stages
    const stagesGroup = createHeatingStagesGroup();
    container.appendChild(stagesGroup);
  }

  // Create heating stages configuration group
  function createHeatingStagesGroup() {
    const group = document.createElement('div');
    group.className = 'option-group';
    
    const header = document.createElement('div');
    header.className = 'option-group-header';
    header.textContent = 'Heating Stages (Power/COP pairs)';
    group.appendChild(header);
    
    const content = document.createElement('div');
    content.className = 'option-group-content';
    
    // Get current stages
    const stages = getOptionValue(['heating', 'stages']) || [];
    
    // Container for stages
    const stagesContainer = document.createElement('div');
    stagesContainer.className = 'heating-stages-container';
    stagesContainer.id = 'heating-stages-list';
    
    renderHeatingStages(stagesContainer, stages);
    
    content.appendChild(stagesContainer);
    
    // Add stage button
    const addButton = document.createElement('button');
    addButton.className = 'btn btn-add';
    addButton.textContent = '+ Add Stage';
    addButton.addEventListener('click', () => {
      const currentStages = getOptionValue(['heating', 'stages']) || [];
      currentStages.push({ "max_power": 0, "cop": 1 });
      setOptionValue(['heating', 'stages'], currentStages);
      renderHeatingStages(stagesContainer, currentStages);
    });
    
    content.appendChild(addButton);
    group.appendChild(content);
    
    return group;
  }

  // Render heating stages
  function renderHeatingStages(container, stages) {
    container.innerHTML = '';
    
    if (stages.length === 0) {
      container.innerHTML = '<div class="empty-state">No heating stages configured. Click "Add Stage" to add one.</div>';
      return;
    }
    
    stages.forEach((stage, index) => {
      const stageItem = document.createElement('div');
      stageItem.className = 'heating-stage-item';
      
      stageItem.innerHTML = `
        <div class="stage-header">
          <span class="stage-number">Stage ${index + 1}</span>
          <button class="btn-icon btn-delete-stage" data-index="${index}" title="Delete stage">
            <span class="material-icons">delete</span>
          </button>
        </div>
        <div class="stage-fields">
          <div class="stage-field">
            <label>Max Power (W)</label>
            <input type="number" 
                   class="stage-input" 
                   value="${stage.max_power || 0}" 
                   data-index="${index}"
                   data-field="max_power"
                   step="1"
                   placeholder="Watts">
          </div>
          <div class="stage-field">
            <label>COP</label>
            <input type="number" 
                   class="stage-input" 
                   value="${stage.cop || 1}" 
                   data-index="${index}"
                   data-field="cop"
                   step="0.1"
                   placeholder="Coefficient">
          </div>
        </div>
      `;
      
      // Add event listeners
      const powerInput = stageItem.querySelector('[data-field="max_power"]');
      const copInput = stageItem.querySelector('[data-field="cop"]');
      const deleteBtn = stageItem.querySelector('.btn-delete-stage');
      
      powerInput.addEventListener('change', (e) => {
        const currentStages = getOptionValue(['heating', 'stages']) || [];
        currentStages[index].max_power = parseFloat(e.target.value) || 0;
        setOptionValue(['heating', 'stages'], currentStages);
      });
      
      copInput.addEventListener('change', (e) => {
        const currentStages = getOptionValue(['heating', 'stages']) || [];
        currentStages[index].cop = parseFloat(e.target.value) || 1;
        setOptionValue(['heating', 'stages'], currentStages);
      });
      
      deleteBtn.addEventListener('click', () => {
        if (confirm('Are you sure you want to delete this stage?')) {
          const currentStages = getOptionValue(['heating', 'stages']) || [];
          currentStages.splice(index, 1);
          setOptionValue(['heating', 'stages'], currentStages);
          renderHeatingStages(container, currentStages);
        }
      });
      
      container.appendChild(stageItem);
    });
  }

  // Create an optimisation item in the list
  function createOptimisationItem(optimisation, index, type) {
    const item = document.createElement('div');
    item.className = 'optimisation-item';
    
    const name = optimisation.name || `${type.charAt(0).toUpperCase() + type.slice(1)} ${index + 1}`;
    const enabled = optimisation.enabled !== false; // Default to true if not specified
    
    item.innerHTML = `
      <div class="optimisation-item-header">
        <div class="optimisation-item-title">
          <span class="optimisation-name">${name}</span>
          <span class="optimisation-status ${enabled ? 'enabled' : 'disabled'}">${enabled ? 'Enabled' : 'Disabled'}</span>
        </div>
        <div class="optimisation-item-actions">
          <button class="btn-icon btn-edit" data-type="${type}" data-index="${index}" title="Edit">
            <span class="material-icons">edit</span>
          </button>
          <button class="btn-icon btn-delete" data-type="${type}" data-index="${index}" title="Delete">
            <span class="material-icons">delete</span>
          </button>
        </div>
      </div>
    `;
    
    // Add event listeners
    const editBtn = item.querySelector('.btn-edit');
    const deleteBtn = item.querySelector('.btn-delete');
    
    editBtn.addEventListener('click', () => editOptimisation(type, index));
    deleteBtn.addEventListener('click', () => deleteOptimisation(type, index));
    
    return item;
  }

  // Placeholder functions for optimisation CRUD operations
  function editOptimisation(type, index) {
    if (type === 'solar') {
      openSolarModal(index);
    } else if (type === 'battery') {
      openBatteryModal(index);
    } else if (type === 'ev') {
      openEVModal(index);
    } else if (type === 'machine') {
      openMachineModal(index);
    } else {
      // TODO: Implement edit modal for other types
      console.log(`Edit ${type} optimisation at index ${index}`);
    }
  }

  function deleteOptimisation(type, index) {
    if (!confirm(`Are you sure you want to delete this ${type} optimisation?`)) {
      return;
    }
    
    // Map type to correct data key
    const dataKey = type === 'ev' ? 'electric vehicle' : type === 'machine' ? 'machines' : type;
    
    const optimisations = getOptionValue([dataKey]) || [];
    optimisations.splice(index, 1);
    setOptionValue([dataKey], optimisations);
    
    // Re-render the specific list
    switch(type) {
      case 'solar': renderSolarOptimisations(); break;
      case 'battery': renderBatteryOptimisations(); break;
      case 'ev': renderEVOptimisations(); break;
      case 'machine': renderMachineOptimisations(); break;
    }
  }

  // Solar modal functions
  function openSolarModal(index = null) {
    solarModalContext = 'main';
    editingSolarIndex = index;
    const modal = document.getElementById('solar-modal');
    const title = document.getElementById('solar-modal-title');
    
    if (index === null) {
      // Adding new solar panel
      title.textContent = 'Add Solar Panel';
      document.getElementById('solar-name').value = '';
      document.getElementById('solar-entity-pv-switch').value = '';
      document.getElementById('solar-tilt').value = '';
      document.getElementById('solar-orientation').value = '';
      document.getElementById('solar-capacity').value = '';
      document.getElementById('solar-yield').value = '';
      solarStrings = [];
      renderSolarStrings();
    } else {
      // Editing existing solar panel
      title.textContent = 'Edit Solar Panel';
      const solarArray = getOptionValue(['solar']) || [];
      const solar = solarArray[index];
      
      document.getElementById('solar-name').value = solar.name || '';
      document.getElementById('solar-entity-pv-switch').value = solar['entity pv switch'] || '';
      document.getElementById('solar-tilt').value = solar.tilt || '';
      document.getElementById('solar-orientation').value = solar.orientation || '';
      document.getElementById('solar-capacity').value = solar.capacity || '';
      document.getElementById('solar-yield').value = solar.yield || '';
      solarStrings = solar.strings || [];
      renderSolarStrings();
    }
    
    clearSolarValidationErrors();
    attachSolarFieldListeners();
    modal.style.display = 'block';
  }

  function closeSolarModal() {
    // Check if we're in battery context
    if (solarModalContext === 'battery') {
      closeSolarModalFromBatteryContext();
      return;
    }
    
    const modal = document.getElementById('solar-modal');
    modal.style.display = 'none';
    modal.classList.remove('modal-nested');
    clearSolarValidationErrors();
    editingSolarIndex = null;
    solarStrings = [];
    solarModalContext = 'main';
  }

  function saveSolarPanel() {
    // Check if we're in battery context
    if (solarModalContext === 'battery') {
      saveBatterySolar();
      return;
    }
    
    // Clear any existing error messages
    clearSolarValidationErrors();
    
    const name = document.getElementById('solar-name').value.trim();
    const entityPvSwitch = document.getElementById('solar-entity-pv-switch').value.trim();
    const tilt = document.getElementById('solar-tilt').value;
    const orientation = document.getElementById('solar-orientation').value;
    const capacity = document.getElementById('solar-capacity').value;
    const yieldValue = document.getElementById('solar-yield').value;
    
    let hasErrors = false;
    
    // Validate name
    if (!name) {
      showFieldError('solar-name', 'Name is required');
      hasErrors = true;
    }
    
    // Validate entity PV switch
    if (!entityPvSwitch) {
      showFieldError('solar-entity-pv-switch', 'Entity PV Switch is required');
      hasErrors = true;
    }
    
    // Check if we have strings or direct configuration
    if (solarStrings.length > 0) {
      // Validate all strings
      solarStrings.forEach((string, index) => {
        const stringItem = document.querySelectorAll('.string-item')[index];
        if (stringItem) {
          if (!string.tilt && string.tilt !== 0) {
            showStringFieldError(stringItem, 'tilt', 'Required');
            hasErrors = true;
          }
          if (!string.orientation && string.orientation !== 0) {
            showStringFieldError(stringItem, 'orientation', 'Required');
            hasErrors = true;
          }
          if (!string.capacity) {
            showStringFieldError(stringItem, 'capacity', 'Required');
            hasErrors = true;
          }
          if (!string.yield) {
            showStringFieldError(stringItem, 'yield', 'Required');
            hasErrors = true;
          }
        }
      });
    } else {
      // Validate direct configuration fields
      if (!tilt && tilt !== '0') {
        showFieldError('solar-tilt', 'Tilt is required');
        hasErrors = true;
      }
      if (!orientation && orientation !== '0') {
        showFieldError('solar-orientation', 'Orientation is required');
        hasErrors = true;
      }
      if (!capacity) {
        showFieldError('solar-capacity', 'Capacity is required');
        hasErrors = true;
      }
      if (!yieldValue) {
        showFieldError('solar-yield', 'Yield is required');
        hasErrors = true;
      }
    }
    
    if (hasErrors) {
      return;
    }
    
    const solarPanel = {
      name: name,
      'entity pv switch': entityPvSwitch
    };
    
    // Add strings if they exist
    if (solarStrings.length > 0) {
      solarPanel.strings = solarStrings;
    } else {
      // Add direct properties if no strings
      solarPanel.tilt = parseFloat(tilt);
      solarPanel.orientation = parseFloat(orientation);
      solarPanel.capacity = parseFloat(capacity);
      solarPanel.yield = parseFloat(yieldValue);
    }
    
    const solarArray = getOptionValue(['solar']) || [];
    
    if (editingSolarIndex === null) {
      // Adding new
      solarArray.push(solarPanel);
    } else {
      // Editing existing
      solarArray[editingSolarIndex] = solarPanel;
    }
    
    setOptionValue(['solar'], solarArray);
    closeSolarModal();
    renderSolarOptimisations();
  }

  function showFieldError(fieldId, message) {
    const field = document.getElementById(fieldId);
    if (field) {
      field.classList.add('field-error');
      const formGroup = field.closest('.form-group');
      if (formGroup) {
        let errorMsg = formGroup.querySelector('.error-message');
        if (!errorMsg) {
          errorMsg = document.createElement('div');
          errorMsg.className = 'error-message';
          formGroup.appendChild(errorMsg);
        }
        errorMsg.textContent = message;
      }
    }
  }

  function showStringFieldError(stringItem, fieldName, message) {
    const input = stringItem.querySelector(`[data-field="${fieldName}"]`);
    if (input) {
      input.classList.add('field-error');
      const fieldContainer = input.closest('.string-field');
      if (fieldContainer) {
        let errorMsg = fieldContainer.querySelector('.error-message');
        if (!errorMsg) {
          errorMsg = document.createElement('div');
          errorMsg.className = 'error-message';
          fieldContainer.appendChild(errorMsg);
        }
        errorMsg.textContent = message;
      }
    }
  }

  function clearSolarValidationErrors() {
    // Clear field errors
    const modal = document.getElementById('solar-modal');
    if (modal) {
      modal.querySelectorAll('.field-error').forEach(field => {
        field.classList.remove('field-error');
      });
      modal.querySelectorAll('.error-message').forEach(msg => {
        msg.remove();
      });
    }
  }

  function attachSolarFieldListeners() {
    // Clear errors when user starts typing
    const fields = [
      'solar-name',
      'solar-entity-pv-switch',
      'solar-tilt',
      'solar-orientation',
      'solar-capacity',
      'solar-yield'
    ];
    
    fields.forEach(fieldId => {
      const field = document.getElementById(fieldId);
      if (field) {
        field.addEventListener('input', function() {
          this.classList.remove('field-error');
          const formGroup = this.closest('.form-group');
          if (formGroup) {
            const errorMsg = formGroup.querySelector('.error-message');
            if (errorMsg) {
              errorMsg.remove();
            }
          }
        });
      }
    });
  }

  function renderSolarStrings() {
    const container = document.getElementById('solar-strings-container');
    container.innerHTML = '';
    
    if (solarStrings.length === 0) {
      container.innerHTML = '<div class="empty-state-small">No strings configured</div>';
      return;
    }
    
    solarStrings.forEach((string, index) => {
      const stringItem = document.createElement('div');
      stringItem.className = 'string-item';
      
      stringItem.innerHTML = `
        <div class="string-header">
          <span class="string-number">String ${index + 1}</span>
          <button class="btn-icon btn-delete-string" data-index="${index}" title="Delete string">
            <span class="material-icons">delete</span>
          </button>
        </div>
        <div class="string-fields">
          <div class="string-field">
            <label>Tilt (°)</label>
            <input type="number" class="string-input" value="${string.tilt || 0}" data-index="${index}" data-field="tilt" step="1">
          </div>
          <div class="string-field">
            <label>Orientation (°)</label>
            <input type="number" class="string-input" value="${string.orientation || 0}" data-index="${index}" data-field="orientation" step="1">
          </div>
          <div class="string-field">
            <label>Capacity (kWp)</label>
            <input type="number" class="string-input" value="${string.capacity || 0}" data-index="${index}" data-field="capacity" step="0.1">
          </div>
          <div class="string-field">
            <label>Yield</label>
            <input type="number" class="string-input" value="${string.yield || 0}" data-index="${index}" data-field="yield" step="0.0001">
          </div>
        </div>
      `;
      
      // Add event listeners
      const inputs = stringItem.querySelectorAll('.string-input');
      inputs.forEach(input => {
        input.addEventListener('change', (e) => {
          const idx = parseInt(e.target.dataset.index);
          const field = e.target.dataset.field;
          solarStrings[idx][field] = parseFloat(e.target.value) || 0;
        });
        
        // Clear error on input
        input.addEventListener('input', (e) => {
          const stringField = e.target.closest('.string-field');
          stringField.classList.remove('field-error');
          const existingError = stringField.querySelector('.error-message');
          if (existingError) {
            existingError.remove();
          }
        });
      });
      
      const deleteBtn = stringItem.querySelector('.btn-delete-string');
      deleteBtn.addEventListener('click', () => {
        solarStrings.splice(index, 1);
        renderSolarStrings();
      });
      
      container.appendChild(stringItem);
    });
  }

  function addSolarString() {
    solarStrings.push({
      tilt: 0,
      orientation: 0,
      capacity: 0,
      yield: 0
    });
    renderSolarStrings();
  }

  // Battery modal functions
  function openBatteryModal(index = null) {
    editingBatteryIndex = index;
    const modal = document.getElementById('battery-modal');
    const title = document.getElementById('battery-modal-title');
    
    if (index === null) {
      // Adding new battery
      title.textContent = 'Add Battery';
      clearBatteryForm();
      batteryChargeStages = [{power: 0, efficiency: 1}];
      batteryDischargeStages = [{power: 0, efficiency: 1}];
      batteryReducedHours = {};
      batterySolarPanels = [];
    } else {
      // Editing existing battery
      title.textContent = 'Edit Battery';
      const batteryArray = getOptionValue(['battery']) || [];
      const battery = batteryArray[index];
      
      populateBatteryForm(battery);
      batteryChargeStages = battery['charge stages'] || [{power: 0, efficiency: 1}];
      batteryDischargeStages = battery['discharge stages'] || [{power: 0, efficiency: 1}];
      batteryReducedHours = battery['reduced hours'] || {};
      batterySolarPanels = battery['solar'] || [];
    }
    
    renderBatteryChargeStages();
    renderBatteryDischargeStages();
    renderBatteryReducedHours();
    renderBatterySolarList();
    
    // Reset to first tab
    switchBatteryTab('battery-general');
    
    modal.style.display = 'block';
  }

  function switchBatteryTab(tabId) {
    // Hide all battery tab contents
    document.querySelectorAll('.battery-tab-content').forEach(content => {
      content.classList.remove('active');
    });
    
    // Remove active class from all battery tab buttons
    document.querySelectorAll('.battery-tab-btn').forEach(btn => {
      btn.classList.remove('active');
    });
    
    // Show selected tab content
    const selectedContent = document.getElementById(tabId);
    if (selectedContent) {
      selectedContent.classList.add('active');
    }
    
    // Add active class to selected button
    const selectedBtn = document.querySelector(`.battery-tab-btn[data-tab="${tabId}"]`);
    if (selectedBtn) {
      selectedBtn.classList.add('active');
    }
  }

  function closeBatteryModal() {
    document.getElementById('battery-modal').style.display = 'none';
    editingBatteryIndex = null;
    batteryChargeStages = [];
    batteryDischargeStages = [];
    batteryReducedHours = {};
    batterySolarPanels = [];
  }

  function clearBatteryForm() {
    const fields = [
      'battery-name', 'battery-entity-level', 'battery-capacity',
      'battery-upper-limit', 'battery-lower-limit', 'battery-optimal-lower',
      'battery-entity-min-soc', 'battery-entity-max-soc',
      'battery-minimum-power', 'battery-cycle-cost',
      'battery-dc-to-bat-eff', 'battery-dc-to-bat-power',
      'battery-bat-to-dc-eff', 'battery-bat-to-dc-power',
      'battery-entity-power-feedin', 'battery-entity-operating-mode',
      'battery-entity-stop-inverter', 'battery-entity-balance-switch',
      'battery-entity-from-battery', 'battery-entity-from-pv',
      'battery-entity-from-ac', 'battery-entity-calculated-soc'
    ];
    
    fields.forEach(fieldId => {
      const field = document.getElementById(fieldId);
      if (field) field.value = '';
    });
  }

  function populateBatteryForm(battery) {
    document.getElementById('battery-name').value = battery.name || '';
    document.getElementById('battery-entity-level').value = battery['entity actual level'] || '';
    document.getElementById('battery-capacity').value = battery.capacity || '';
    document.getElementById('battery-upper-limit').value = battery['upper limit'] || '';
    document.getElementById('battery-lower-limit').value = battery['lower limit'] || '';
    document.getElementById('battery-optimal-lower').value = battery['optimal lower level'] || '';
    document.getElementById('battery-entity-min-soc').value = battery['entity min soc end opt'] || '';
    document.getElementById('battery-entity-max-soc').value = battery['entity max soc end opt'] || '';
    document.getElementById('battery-minimum-power').value = battery['minimum power'] || '';
    document.getElementById('battery-cycle-cost').value = battery['cycle cost'] || '';
    document.getElementById('battery-dc-to-bat-eff').value = battery['dc_to_bat efficiency'] || '';
    document.getElementById('battery-dc-to-bat-power').value = battery['dc_to_bat max power'] || '';
    document.getElementById('battery-bat-to-dc-eff').value = battery['bat_to_dc efficiency'] || '';
    document.getElementById('battery-bat-to-dc-power').value = battery['bat_to_dc max power'] || '';
    document.getElementById('battery-entity-power-feedin').value = battery['entity set power feedin'] || '';
    document.getElementById('battery-entity-operating-mode').value = battery['entity set operating mode'] || '';
    document.getElementById('battery-entity-stop-inverter').value = battery['entity stop inverter'] || '';
    document.getElementById('battery-entity-balance-switch').value = battery['entity balance switch'] || '';
    document.getElementById('battery-entity-from-battery').value = battery['entity from battery'] || '';
    document.getElementById('battery-entity-from-pv').value = battery['entity from pv'] || '';
    document.getElementById('battery-entity-from-ac').value = battery['entity from ac'] || '';
    document.getElementById('battery-entity-calculated-soc').value = battery['entity calculated soc'] || '';
  }

  function saveBattery() {
    const battery = {
      name: document.getElementById('battery-name').value.trim(),
      'entity actual level': document.getElementById('battery-entity-level').value.trim(),
      capacity: parseFloat(document.getElementById('battery-capacity').value) || 0,
      'upper limit': parseFloat(document.getElementById('battery-upper-limit').value) || 0,
      'lower limit': parseFloat(document.getElementById('battery-lower-limit').value) || 0,
      'optimal lower level': parseFloat(document.getElementById('battery-optimal-lower').value) || 0,
      'entity min soc end opt': document.getElementById('battery-entity-min-soc').value.trim(),
      'entity max soc end opt': document.getElementById('battery-entity-max-soc').value.trim(),
      'charge stages': batteryChargeStages,
      'discharge stages': batteryDischargeStages,
      'reduced hours': batteryReducedHours,
      'minimum power': parseFloat(document.getElementById('battery-minimum-power').value) || 0,
      'dc_to_bat efficiency': parseFloat(document.getElementById('battery-dc-to-bat-eff').value) || 0,
      'dc_to_bat max power': parseFloat(document.getElementById('battery-dc-to-bat-power').value) || 0,
      'bat_to_dc efficiency': parseFloat(document.getElementById('battery-bat-to-dc-eff').value) || 0,
      'bat_to_dc max power': parseFloat(document.getElementById('battery-bat-to-dc-power').value) || 0,
      'cycle cost': parseFloat(document.getElementById('battery-cycle-cost').value) || 0,
      'entity set power feedin': document.getElementById('battery-entity-power-feedin').value.trim(),
      'entity set operating mode': document.getElementById('battery-entity-operating-mode').value.trim(),
      'entity stop inverter': document.getElementById('battery-entity-stop-inverter').value.trim(),
      'entity balance switch': document.getElementById('battery-entity-balance-switch').value.trim(),
      'entity from battery': document.getElementById('battery-entity-from-battery').value.trim(),
      'entity from pv': document.getElementById('battery-entity-from-pv').value.trim(),
      'entity from ac': document.getElementById('battery-entity-from-ac').value.trim(),
      'entity calculated soc': document.getElementById('battery-entity-calculated-soc').value.trim()
    };
    
    // Add solar panels if any
    if (batterySolarPanels.length > 0) {
      battery.solar = batterySolarPanels;
    }
    
    const batteryArray = getOptionValue(['battery']) || [];
    
    if (editingBatteryIndex === null) {
      // Adding new
      batteryArray.push(battery);
    } else {
      // Editing existing
      batteryArray[editingBatteryIndex] = battery;
    }
    
    setOptionValue(['battery'], batteryArray);
    closeBatteryModal();
    renderBatteryOptimisations();
  }

  function renderBatteryChargeStages() {
    const container = document.getElementById('battery-charge-stages-container');
    container.innerHTML = '';
    
    batteryChargeStages.forEach((stage, index) => {
      const stageItem = document.createElement('div');
      stageItem.className = 'stage-item-compact';
      
      stageItem.innerHTML = `
        <span class="stage-label">Stage ${index + 1}</span>
        <label class="stage-inline-label">Power (W):</label>
        <input type="number" class="stage-inline-input" value="${stage.power || 0}" data-index="${index}" data-field="power" step="1">
        <label class="stage-inline-label">Efficiency:</label>
        <input type="number" class="stage-inline-input" value="${stage.efficiency || 1}" data-index="${index}" data-field="efficiency" step="0.001" min="0" max="1">
        <button class="btn-icon-small btn-delete-stage" title="Delete stage">×</button>
      `;
      
      const inputs = stageItem.querySelectorAll('.stage-inline-input');
      inputs.forEach(input => {
        input.addEventListener('change', (e) => {
          const idx = parseInt(e.target.dataset.index);
          const field = e.target.dataset.field;
          batteryChargeStages[idx][field] = parseFloat(e.target.value) || 0;
        });
      });
      
      const deleteBtn = stageItem.querySelector('.btn-delete-stage');
      deleteBtn.addEventListener('click', () => {
        batteryChargeStages.splice(index, 1);
        renderBatteryChargeStages();
      });
      
      container.appendChild(stageItem);
    });
  }

  function renderBatteryDischargeStages() {
    const container = document.getElementById('battery-discharge-stages-container');
    container.innerHTML = '';
    
    batteryDischargeStages.forEach((stage, index) => {
      const stageItem = document.createElement('div');
      stageItem.className = 'stage-item-compact';
      
      stageItem.innerHTML = `
        <span class="stage-label">Stage ${index + 1}</span>
        <label class="stage-inline-label">Power (W):</label>
        <input type="number" class="stage-inline-input" value="${stage.power || 0}" data-index="${index}" data-field="power" step="1">
        <label class="stage-inline-label">Efficiency:</label>
        <input type="number" class="stage-inline-input" value="${stage.efficiency || 1}" data-index="${index}" data-field="efficiency" step="0.001" min="0" max="1">
        <button class="btn-icon-small btn-delete-stage" title="Delete stage">×</button>
      `;
      
      const inputs = stageItem.querySelectorAll('.stage-inline-input');
      inputs.forEach(input => {
        input.addEventListener('change', (e) => {
          const idx = parseInt(e.target.dataset.index);
          const field = e.target.dataset.field;
          batteryDischargeStages[idx][field] = parseFloat(e.target.value) || 0;
        });
      });
      
      const deleteBtn = stageItem.querySelector('.btn-delete-stage');
      deleteBtn.addEventListener('click', () => {
        batteryDischargeStages.splice(index, 1);
        renderBatteryDischargeStages();
      });

      container.appendChild(stageItem);
    });
  }  function renderBatteryReducedHours() {
    const container = document.getElementById('battery-reduced-hours-container');
    container.innerHTML = '';
    
    const hours = Object.keys(batteryReducedHours).sort((a, b) => parseInt(a) - parseInt(b));
    
    if (hours.length === 0) {
      container.innerHTML = '<div class="empty-state-small">No reduced hours configured</div>';
      return;
    }
    
    hours.forEach(hour => {
      const hourItem = document.createElement('div');
      hourItem.className = 'reduced-hour-item';
      
      hourItem.innerHTML = `
        <div class="reduced-hour-fields">
          <div class="reduced-hour-field">
            <label>Hour (0-23)</label>
            <input type="number" class="hour-input" value="${hour}" min="0" max="23" step="1">
          </div>
          <div class="reduced-hour-field">
            <label>Power Limit (W)</label>
            <input type="number" class="power-input" value="${batteryReducedHours[hour]}" step="1">
          </div>
          <button class="btn-icon btn-delete-hour" title="Delete">
            <span class="material-icons">delete</span>
          </button>
        </div>
      `;
      
      const hourInput = hourItem.querySelector('.hour-input');
      const powerInput = hourItem.querySelector('.power-input');
      const deleteBtn = hourItem.querySelector('.btn-delete-hour');
      
      hourInput.addEventListener('change', (e) => {
        const oldHour = hour;
        const newHour = e.target.value;
        const power = batteryReducedHours[oldHour];
        delete batteryReducedHours[oldHour];
        batteryReducedHours[newHour] = power;
        renderBatteryReducedHours();
      });
      
      powerInput.addEventListener('change', (e) => {
        batteryReducedHours[hour] = parseFloat(e.target.value) || 0;
      });
      
      deleteBtn.addEventListener('click', () => {
        delete batteryReducedHours[hour];
        renderBatteryReducedHours();
      });
      
      container.appendChild(hourItem);
    });
  }

  function addBatteryChargeStage() {
    batteryChargeStages.push({power: 0, efficiency: 1});
    renderBatteryChargeStages();
  }

  function addBatteryDischargeStage() {
    batteryDischargeStages.push({power: 0, efficiency: 1});
    renderBatteryDischargeStages();
  }

  function addBatteryReducedHour() {
    // Find first unused hour
    for (let h = 0; h < 24; h++) {
      if (!batteryReducedHours.hasOwnProperty(h.toString())) {
        batteryReducedHours[h.toString()] = 0;
        renderBatteryReducedHours();
        return;
      }
    }
    alert('All hours are already configured');
  }

  function renderBatterySolarList() {
    const container = document.getElementById('battery-solar-list-container');
    container.innerHTML = '';
    
    if (batterySolarPanels.length === 0) {
      container.innerHTML = '<div class="empty-state">No DC solar panels configured.</div>';
      return;
    }
    
    batterySolarPanels.forEach((solar, index) => {
      const item = document.createElement('div');
      item.className = 'optimisation-item';
      
      const name = solar.name || `Solar ${index + 1}`;
      
      item.innerHTML = `
        <div class="optimisation-item-header">
          <div class="optimisation-item-title">
            <span class="optimisation-name">${name}</span>
          </div>
          <div class="optimisation-item-actions">
            <button class="btn-icon btn-edit-battery-solar" data-index="${index}" title="Edit">
              <span class="material-icons">edit</span>
            </button>
            <button class="btn-icon btn-delete-battery-solar" data-index="${index}" title="Delete">
              <span class="material-icons">delete</span>
            </button>
          </div>
        </div>
      `;
      
      const editBtn = item.querySelector('.btn-edit-battery-solar');
      const deleteBtn = item.querySelector('.btn-delete-battery-solar');
      
      editBtn.addEventListener('click', () => openBatterySolarModal(index));
      deleteBtn.addEventListener('click', () => deleteBatterySolar(index));
      
      container.appendChild(item);
    });
  }

  function openBatterySolarModal(index = null) {
    solarModalContext = 'battery';
    editingBatterySolarIndex = index;
    const modal = document.getElementById('solar-modal');
    const title = document.getElementById('solar-modal-title');
    
    // Add nested class for higher z-index since it's opened from battery modal
    modal.classList.add('modal-nested');
    
    if (index === null) {
      // Adding new DC solar panel
      title.textContent = 'Add DC Solar Panel';
      document.getElementById('solar-name').value = '';
      document.getElementById('solar-entity-pv-switch').value = '';
      document.getElementById('solar-tilt').value = '';
      document.getElementById('solar-orientation').value = '';
      document.getElementById('solar-capacity').value = '';
      document.getElementById('solar-yield').value = '';
      solarStrings = [];
      renderSolarStrings();
    } else {
      // Editing existing DC solar panel
      title.textContent = 'Edit DC Solar Panel';
      const solar = batterySolarPanels[index];
      
      document.getElementById('solar-name').value = solar.name || '';
      document.getElementById('solar-entity-pv-switch').value = solar['entity pv switch'] || '';
      document.getElementById('solar-tilt').value = solar.tilt || '';
      document.getElementById('solar-orientation').value = solar.orientation || '';
      document.getElementById('solar-capacity').value = solar.capacity || '';
      document.getElementById('solar-yield').value = solar.yield || '';
      solarStrings = solar.strings || [];
      renderSolarStrings();
    }
    
    clearSolarValidationErrors();
    attachSolarFieldListeners();
    modal.style.display = 'block';
  }

  function saveBatterySolar() {
    // Clear any existing error messages
    clearSolarValidationErrors();
    
    const name = document.getElementById('solar-name').value.trim();
    const entityPvSwitch = document.getElementById('solar-entity-pv-switch').value.trim();
    const tilt = document.getElementById('solar-tilt').value;
    const orientation = document.getElementById('solar-orientation').value;
    const capacity = document.getElementById('solar-capacity').value;
    const yieldValue = document.getElementById('solar-yield').value;
    
    let hasErrors = false;
    
    // Validate common fields
    if (!name) {
      showFieldError('solar-name', 'Name is required');
      hasErrors = true;
    }
    if (!entityPvSwitch) {
      showFieldError('solar-entity-pv-switch', 'Entity PV Switch is required');
      hasErrors = true;
    }
    
    // Determine mode and validate accordingly
    const hasStrings = solarStrings.length > 0;
    
    if (hasStrings) {
      // Validate all strings
      solarStrings.forEach((string, index) => {
        if (!string.tilt && string.tilt !== 0) {
          showStringFieldError(index, 'tilt', 'Tilt is required');
          hasErrors = true;
        }
        if (!string.orientation && string.orientation !== 0) {
          showStringFieldError(index, 'orientation', 'Orientation is required');
          hasErrors = true;
        }
        if (!string.capacity && string.capacity !== 0) {
          showStringFieldError(index, 'capacity', 'Capacity is required');
          hasErrors = true;
        }
        if (!string.yield && string.yield !== 0) {
          showStringFieldError(index, 'yield', 'Yield is required');
          hasErrors = true;
        }
      });
    } else {
      // Validate direct configuration fields
      if (!tilt && tilt !== '0') {
        showFieldError('solar-tilt', 'Tilt is required');
        hasErrors = true;
      }
      if (!orientation && orientation !== '0') {
        showFieldError('solar-orientation', 'Orientation is required');
        hasErrors = true;
      }
      if (!capacity && capacity !== '0') {
        showFieldError('solar-capacity', 'Capacity is required');
        hasErrors = true;
      }
      if (!yieldValue && yieldValue !== '0') {
        showFieldError('solar-yield', 'Yield is required');
        hasErrors = true;
      }
    }
    
    if (hasErrors) {
      return;
    }
    
    // Build solar panel object
    const solar = {
      name: name,
      'entity pv switch': entityPvSwitch
    };
    
    if (hasStrings) {
      solar.strings = solarStrings;
    } else {
      solar.tilt = parseFloat(tilt) || 0;
      solar.orientation = parseFloat(orientation) || 0;
      solar.capacity = parseFloat(capacity) || 0;
      solar.yield = parseFloat(yieldValue) || 0;
    }
    
    if (editingBatterySolarIndex === null) {
      // Adding new
      batterySolarPanels.push(solar);
    } else {
      // Editing existing
      batterySolarPanels[editingBatterySolarIndex] = solar;
    }
    
    closeSolarModalFromBatteryContext();
    renderBatterySolarList();
  }

  function deleteBatterySolar(index) {
    if (!confirm('Are you sure you want to delete this DC solar panel?')) {
      return;
    }
    
    batterySolarPanels.splice(index, 1);
    renderBatterySolarList();
  }

  function closeSolarModalFromBatteryContext() {
    const modal = document.getElementById('solar-modal');
    modal.style.display = 'none';
    modal.classList.remove('modal-nested');
    clearSolarValidationErrors();
    editingBatterySolarIndex = null;
    solarStrings = [];
    solarModalContext = 'main';
  }

  // EV modal functions
  function openEVModal(index = null) {
    editingEVIndex = index;
    const modal = document.getElementById('ev-modal');
    const title = document.getElementById('ev-modal-title');
    
    if (index === null) {
      // Adding new EV
      title.textContent = 'Add Electric Vehicle';
      clearEVForm();
      evChargeStages = [{ampere: 0, efficiency: 1}];
    } else {
      // Editing existing EV
      title.textContent = 'Edit Electric Vehicle';
      const evArray = getOptionValue(['electric vehicle']) || [];
      const ev = evArray[index];
      
      populateEVForm(ev);
      evChargeStages = ev['charge stages'] || [{ampere: 0, efficiency: 1}];
    }
    
    renderEVChargeStages();
    
    // Reset to first tab
    switchEVTab('ev-general');
    
    modal.style.display = 'block';
  }

  function switchEVTab(tabId) {
    // Hide all EV tab contents
    document.querySelectorAll('.ev-tab-content').forEach(content => {
      content.classList.remove('active');
    });
    
    // Remove active class from all EV tab buttons
    document.querySelectorAll('.ev-tab-btn').forEach(btn => {
      btn.classList.remove('active');
    });
    
    // Show selected tab content
    const selectedContent = document.getElementById(tabId);
    if (selectedContent) {
      selectedContent.classList.add('active');
    }
    
    // Add active class to selected button
    const selectedBtn = document.querySelector(`.ev-tab-btn[data-tab="${tabId}"]`);
    if (selectedBtn) {
      selectedBtn.classList.add('active');
    }
  }

  function closeEVModal() {
    document.getElementById('ev-modal').style.display = 'none';
    editingEVIndex = null;
    evChargeStages = [];
  }

  function clearEVForm() {
    const fields = [
      'ev-name', 'ev-capacity', 'ev-charge-three-phase',
      'ev-entity-position', 'ev-entity-max-amperage',
      'ev-entity-actual-level', 'ev-entity-plugged-in',
      'ev-charge-switch', 'ev-entity-set-charging-ampere', 'ev-entity-stop-charging',
      'ev-scheduler-entity-set-level', 'ev-scheduler-level-margin', 'ev-scheduler-entity-ready-datetime'
    ];
    
    fields.forEach(fieldId => {
      const field = document.getElementById(fieldId);
      if (field) {
        if (field.tagName === 'SELECT') {
          field.value = 'False';
        } else {
          field.value = '';
        }
      }
    });
  }

  function populateEVForm(ev) {
    document.getElementById('ev-name').value = ev.name || '';
    document.getElementById('ev-capacity').value = ev.capacity || '';
    document.getElementById('ev-charge-three-phase').value = ev['charge three phase'] || 'False';
    document.getElementById('ev-entity-position').value = ev['entity position'] || '';
    document.getElementById('ev-entity-max-amperage').value = ev['entity max amperage'] || '';
    document.getElementById('ev-entity-actual-level').value = ev['entity actual level'] || '';
    document.getElementById('ev-entity-plugged-in').value = ev['entity plugged in'] || '';
    document.getElementById('ev-charge-switch').value = ev['charge switch'] || '';
    document.getElementById('ev-entity-set-charging-ampere').value = ev['entity set charging ampere'] || '';
    document.getElementById('ev-entity-stop-charging').value = ev['entity stop charging'] || '';
    
    // Charge scheduler fields
    const scheduler = ev['charge scheduler'] || {};
    document.getElementById('ev-scheduler-entity-set-level').value = scheduler['entity set level'] || '';
    document.getElementById('ev-scheduler-level-margin').value = scheduler['level margin'] || '';
    document.getElementById('ev-scheduler-entity-ready-datetime').value = scheduler['entity ready datetime'] || '';
  }

  function saveEV() {
    const ev = {
      name: document.getElementById('ev-name').value.trim(),
      capacity: parseFloat(document.getElementById('ev-capacity').value) || 0,
      'charge three phase': document.getElementById('ev-charge-three-phase').value,
      'entity position': document.getElementById('ev-entity-position').value.trim(),
      'entity max amperage': document.getElementById('ev-entity-max-amperage').value.trim(),
      'charge stages': evChargeStages,
      'entity actual level': document.getElementById('ev-entity-actual-level').value.trim(),
      'entity plugged in': document.getElementById('ev-entity-plugged-in').value.trim(),
      'charge scheduler': {
        'entity set level': document.getElementById('ev-scheduler-entity-set-level').value.trim(),
        'level margin': parseFloat(document.getElementById('ev-scheduler-level-margin').value) || 0,
        'entity ready datetime': document.getElementById('ev-scheduler-entity-ready-datetime').value.trim()
      },
      'charge switch': document.getElementById('ev-charge-switch').value.trim(),
      'entity set charging ampere': document.getElementById('ev-entity-set-charging-ampere').value.trim(),
      'entity stop charging': document.getElementById('ev-entity-stop-charging').value.trim()
    };
    
    const evArray = getOptionValue(['electric vehicle']) || [];
    
    if (editingEVIndex === null) {
      // Adding new
      evArray.push(ev);
    } else {
      // Editing existing
      evArray[editingEVIndex] = ev;
    }
    
    setOptionValue(['electric vehicle'], evArray);
    closeEVModal();
    renderEVOptimisations();
  }

  function renderEVChargeStages() {
    const container = document.getElementById('ev-charge-stages-container');
    container.innerHTML = '';
    
    evChargeStages.forEach((stage, index) => {
      const stageItem = document.createElement('div');
      stageItem.className = 'stage-item-compact';
      
      stageItem.innerHTML = `
        <span class="stage-label">Stage ${index + 1}</span>
        <label class="stage-inline-label">Ampere (A):</label>
        <input type="number" class="stage-inline-input" value="${stage.ampere || 0}" data-index="${index}" data-field="ampere" step="1">
        <label class="stage-inline-label">Efficiency:</label>
        <input type="number" class="stage-inline-input" value="${stage.efficiency || 1}" data-index="${index}" data-field="efficiency" step="0.01" min="0" max="1">
        <button class="btn-icon-small btn-delete-stage" title="Delete stage">×</button>
      `;
      
      const inputs = stageItem.querySelectorAll('.stage-inline-input');
      inputs.forEach(input => {
        input.addEventListener('change', (e) => {
          const idx = parseInt(e.target.dataset.index);
          const field = e.target.dataset.field;
          evChargeStages[idx][field] = parseFloat(e.target.value) || 0;
        });
      });
      
      const deleteBtn = stageItem.querySelector('.btn-delete-stage');
      deleteBtn.addEventListener('click', () => {
        evChargeStages.splice(index, 1);
        renderEVChargeStages();
      });
      
      container.appendChild(stageItem);
    });
  }

  function addEVChargeStage() {
    evChargeStages.push({ampere: 0, efficiency: 1});
    renderEVChargeStages();
  }

  // ===== MACHINE MODAL FUNCTIONS =====
  
  function openMachineModal(index = null) {
    editingMachineIndex = index;
    const modal = document.getElementById('machine-modal');
    const title = document.getElementById('machine-modal-title');
    
    // Clear form and reset programs
    clearMachineForm();
    machinePrograms = [];
    
    if (index !== null) {
      // Edit mode
      title.textContent = 'Edit Machine';
      const machines = currentData.options['machines'] || [];
      if (machines[index]) {
        populateMachineForm(machines[index]);
      }
    } else {
      // Add mode
      title.textContent = 'Add Machine';
    }
    
    // Switch to General tab
    switchMachineTab('machine-general');
    
    modal.style.display = 'block';
  }
  
  function switchMachineTab(tabId) {
    // Hide all machine tab contents
    document.querySelectorAll('.machine-tab-content').forEach(content => {
      content.classList.remove('active');
    });
    
    // Remove active class from all machine tab buttons
    document.querySelectorAll('.machine-tab-btn').forEach(btn => {
      btn.classList.remove('active');
    });
    
    // Show selected tab content
    document.getElementById(tabId).classList.add('active');
    
    // Add active class to selected tab button
    document.querySelector(`.machine-tab-btn[data-tab="${tabId}"]`).classList.add('active');
  }
  
  function closeMachineModal() {
    document.getElementById('machine-modal').style.display = 'none';
    editingMachineIndex = null;
    machinePrograms = [];
    clearMachineForm();
  }
  
  function clearMachineForm() {
    document.getElementById('machine-name').value = '';
    document.getElementById('machine-entity-start-window').value = '';
    document.getElementById('machine-entity-end-window').value = '';
    document.getElementById('machine-entity-selected-program').value = '';
    document.getElementById('machine-entity-calculated-start').value = '';
    document.getElementById('machine-entity-calculated-end').value = '';
    document.getElementById('machine-programs-container').innerHTML = '';
  }
  
  function populateMachineForm(machine) {
    document.getElementById('machine-name').value = machine.name || '';
    document.getElementById('machine-entity-start-window').value = machine['entity start window'] || '';
    document.getElementById('machine-entity-end-window').value = machine['entity end window'] || '';
    document.getElementById('machine-entity-selected-program').value = machine['entity selected program'] || '';
    document.getElementById('machine-entity-calculated-start').value = machine['entity calculated start'] || '';
    document.getElementById('machine-entity-calculated-end').value = machine['entity calculated end'] || '';
    
    // Load programs
    machinePrograms = machine.programs ? JSON.parse(JSON.stringify(machine.programs)) : [];
    renderMachinePrograms();
  }
  
  function saveMachine() {
    const machine = {
      name: document.getElementById('machine-name').value.trim(),
      programs: JSON.parse(JSON.stringify(machinePrograms)),
      'entity start window': document.getElementById('machine-entity-start-window').value.trim(),
      'entity end window': document.getElementById('machine-entity-end-window').value.trim(),
      'entity selected program': document.getElementById('machine-entity-selected-program').value.trim(),
      'entity calculated start': document.getElementById('machine-entity-calculated-start').value.trim(),
      'entity calculated end': document.getElementById('machine-entity-calculated-end').value.trim()
    };
    
    // Initialize machines array if it doesn't exist
    if (!currentData.options['machines']) {
      currentData.options['machines'] = [];
    }
    
    if (editingMachineIndex !== null) {
      // Edit existing machine
      currentData.options['machines'][editingMachineIndex] = machine;
    } else {
      // Add new machine
      currentData.options['machines'].push(machine);
    }
    
    markAsModified();
    renderOptimisations();
    closeMachineModal();
  }
  
  function renderMachinePrograms() {
    const container = document.getElementById('machine-programs-container');
    container.innerHTML = '';
    
    machinePrograms.forEach((program, index) => {
      const programDiv = document.createElement('div');
      programDiv.className = 'stage-item';
      
      const powerPreview = program.power && program.power.length > 0 
        ? `${program.power.length} intervals: [${program.power.slice(0, 3).join(', ')}${program.power.length > 3 ? '...' : ''}]`
        : 'No power pattern';
      
      programDiv.innerHTML = `
        <div class="stage-info">
          <strong>${program.name || 'Unnamed'}</strong>
          <span class="stage-detail">${powerPreview}</span>
        </div>
        <div class="stage-actions">
          <button class="btn-icon" onclick="editMachineProgram(${index})" title="Edit">
            <span class="material-icons">edit</span>
          </button>
          <button class="btn-icon" onclick="deleteMachineProgram(${index})" title="Delete">
            <span class="material-icons">delete</span>
          </button>
        </div>
      `;
      
      container.appendChild(programDiv);
    });
  }
  
  function addMachineProgram() {
    editingMachineProgramIndex = null;
    openMachineProgramModal();
  }
  
  function editMachineProgram(index) {
    editingMachineProgramIndex = index;
    openMachineProgramModal(machinePrograms[index]);
  }
  
  function deleteMachineProgram(index) {
    if (confirm('Are you sure you want to delete this program?')) {
      machinePrograms.splice(index, 1);
      renderMachinePrograms();
    }
  }
  
  function openMachineProgramModal(program = null) {
    const modal = document.getElementById('machine-program-modal');
    const title = document.getElementById('machine-program-modal-title');
    
    // Add nested class for higher z-index since it's opened from machine modal
    modal.classList.add('modal-nested');
    
    if (program) {
      title.textContent = 'Edit Program';
      document.getElementById('machine-program-name').value = program.name || '';
      document.getElementById('machine-program-power').value = program.power ? program.power.join(', ') : '';
    } else {
      title.textContent = 'Add Program';
      document.getElementById('machine-program-name').value = '';
      document.getElementById('machine-program-power').value = '';
    }
    
    modal.style.display = 'block';
  }
  
  function closeMachineProgramModal() {
    const modal = document.getElementById('machine-program-modal');
    modal.style.display = 'none';
    modal.classList.remove('modal-nested');
    editingMachineProgramIndex = null;
  }
  
  function saveMachineProgram() {
    const name = document.getElementById('machine-program-name').value.trim();
    const powerStr = document.getElementById('machine-program-power').value.trim();
    
    // Parse power pattern
    let power = [];
    if (powerStr) {
      power = powerStr.split(',').map(p => parseFloat(p.trim())).filter(p => !isNaN(p));
    }
    
    const program = {
      name: name,
      power: power
    };
    
    if (editingMachineProgramIndex !== null) {
      // Edit existing program
      machinePrograms[editingMachineProgramIndex] = program;
    } else {
      // Add new program
      machinePrograms.push(program);
    }
    
    renderMachinePrograms();
    closeMachineProgramModal();
  }

  // ===== REPORT CONFIGURATION FUNCTIONS =====
  
  function loadReportConfiguration() {
    const report = currentData.options.report || {};
    
    // Define the mapping between list IDs and report keys
    const entityMappings = {
      'grid-consumption': 'entities grid consumption',
      'grid-production': 'entities grid production',
      'solar-ac': 'entities solar production ac',
      'solar-dc': 'entities solar production dc',
      'ev-consumption': 'entities ev consumption',
      'wp-consumption': 'entities wp consumption',
      'boiler-consumption': 'entities boiler consumption',
      'machine-consumption': 'entities machine consumption',
      'battery-consumption': 'entities battery consumption',
      'battery-production': 'entities battery production',
      'co2-intensity': 'entity co2-intensity'
    };
    
    // Load each entity list
    for (const [listId, reportKey] of Object.entries(entityMappings)) {
      const entities = report[reportKey] || [];
      // Handle single entity (co2-intensity) vs array of entities
      const entityArray = Array.isArray(entities) ? entities : (entities ? [entities] : []);
      renderReportEntityList(listId, entityArray);
    }
  }
  
  function renderReportEntityList(listId, entities) {
    const listContainer = document.getElementById(`report-${listId}-list`);
    listContainer.innerHTML = '';
    
    if (entities.length === 0) {
      const emptyMsg = document.createElement('div');
      emptyMsg.className = 'report-entity-empty';
      emptyMsg.textContent = 'No entities configured';
      listContainer.appendChild(emptyMsg);
      return;
    }
    
    entities.forEach((entity, index) => {
      const entityItem = document.createElement('div');
      entityItem.className = 'report-entity-item';
      
      const entityInput = document.createElement('input');
      entityInput.type = 'text';
      entityInput.className = 'form-input-small';
      entityInput.value = entity;
      entityInput.dataset.listId = listId;
      entityInput.dataset.index = index;
      entityInput.addEventListener('change', updateReportEntity);
      
      const deleteBtn = document.createElement('button');
      deleteBtn.type = 'button';
      deleteBtn.className = 'btn btn-delete-small';
      deleteBtn.innerHTML = '×';
      deleteBtn.title = 'Remove entity';
      deleteBtn.onclick = () => removeReportEntity(listId, index);
      
      entityItem.appendChild(entityInput);
      entityItem.appendChild(deleteBtn);
      listContainer.appendChild(entityItem);
      
      // Attach HA entity autocomplete to the input
      if (window.haEntitySearch) {
        window.haEntitySearch.attachAutocomplete(entityInput, 'sensor');
      }
    });
  }
  
  function addReportEntity(listId, domain) {
    // Get current entities
    const entities = getReportEntities(listId);
    entities.push('');
    
    // Save and re-render
    saveReportEntities(listId, entities);
    renderReportEntityList(listId, entities);
    markAsModified();
    
    // Focus on the new input
    const listContainer = document.getElementById(`report-${listId}-list`);
    const inputs = listContainer.querySelectorAll('input');
    if (inputs.length > 0) {
      inputs[inputs.length - 1].focus();
    }
  }
  
  function removeReportEntity(listId, index) {
    const entities = getReportEntities(listId);
    entities.splice(index, 1);
    saveReportEntities(listId, entities);
    renderReportEntityList(listId, entities);
    markAsModified();
  }
  
  function updateReportEntity(event) {
    const listId = event.target.dataset.listId;
    const index = parseInt(event.target.dataset.index);
    const value = event.target.value.trim();
    
    const entities = getReportEntities(listId);
    entities[index] = value;
    saveReportEntities(listId, entities);
    markAsModified();
  }
  
  function getReportEntities(listId) {
    const report = currentData.options.report || {};
    const entityMappings = {
      'grid-consumption': 'entities grid consumption',
      'grid-production': 'entities grid production',
      'solar-ac': 'entities solar production ac',
      'solar-dc': 'entities solar production dc',
      'ev-consumption': 'entities ev consumption',
      'wp-consumption': 'entities wp consumption',
      'boiler-consumption': 'entities boiler consumption',
      'machine-consumption': 'entities machine consumption',
      'battery-consumption': 'entities battery consumption',
      'battery-production': 'entities battery production',
      'co2-intensity': 'entity co2-intensity'
    };
    
    const reportKey = entityMappings[listId];
    const entities = report[reportKey];
    // Handle single entity (co2-intensity) vs array of entities
    return Array.isArray(entities) ? [...entities] : (entities ? [entities] : []);
  }
  
  function saveReportEntities(listId, entities) {
    if (!currentData.options.report) {
      currentData.options.report = {};
    }
    
    const entityMappings = {
      'grid-consumption': 'entities grid consumption',
      'grid-production': 'entities grid production',
      'solar-ac': 'entities solar production ac',
      'solar-dc': 'entities solar production dc',
      'ev-consumption': 'entities ev consumption',
      'wp-consumption': 'entities wp consumption',
      'boiler-consumption': 'entities boiler consumption',
      'machine-consumption': 'entities machine consumption',
      'battery-consumption': 'entities battery consumption',
      'battery-production': 'entities battery production',
      'co2-intensity': 'entity co2-intensity'
    };
    
    const reportKey = entityMappings[listId];
    const filteredEntities = entities.filter(e => e.trim() !== '');
    
    // For co2-intensity, store as single string if only one entity, otherwise as array
    if (listId === 'co2-intensity') {
      currentData.options.report[reportKey] = filteredEntities.length > 0 ? filteredEntities[0] : '';
    } else {
      currentData.options.report[reportKey] = filteredEntities;
    }
  }
  
  function saveReportConfiguration() {
    // Configuration is saved automatically when entities are added/updated/removed
    // This function exists for compatibility
    markAsModified();
  }

  // ===== SCHEDULER CONFIGURATION FUNCTIONS =====
  
  let schedulerTasks = [];
  
  function loadSchedulerConfiguration() {
    const scheduler = currentData.options.scheduler || {};
    
    // Load active status
    const activeValue = scheduler.active || 'True';
    document.getElementById('scheduler-active').value = activeValue;
    
    // Load scheduled tasks
    schedulerTasks = [];
    for (const [time, task] of Object.entries(scheduler)) {
      if (time !== 'active') {
        schedulerTasks.push({ time, task });
      }
    }
    
    // Sort by time: wildcard times (with 'x') first, then normal times
    schedulerTasks.sort((a, b) => {
      const aHasWildcard = a.time.includes('x');
      const bHasWildcard = b.time.includes('x');
      
      // If one has wildcard and other doesn't, wildcard comes first
      if (aHasWildcard && !bHasWildcard) return -1;
      if (!aHasWildcard && bHasWildcard) return 1;
      
      // Otherwise sort alphabetically
      return a.time.localeCompare(b.time);
    });
    
    renderSchedulerTasks();
  }
  
  function renderSchedulerTasks() {
    const tbody = document.getElementById('scheduler-tasks-tbody');
    tbody.innerHTML = '';
    
    if (schedulerTasks.length === 0) {
      const row = tbody.insertRow();
      const cell = row.insertCell();
      cell.colSpan = 3;
      cell.style.textAlign = 'center';
      cell.style.padding = '20px';
      cell.style.color = '#6c757d';
      cell.textContent = 'No scheduled tasks. Click "+ Add Task" to create one.';
      return;
    }
    
    schedulerTasks.forEach((item, index) => {
      const row = tbody.insertRow();
      
      // Time cell
      const timeCell = row.insertCell();
      const timeInput = document.createElement('input');
      timeInput.type = 'text';
      timeInput.className = 'form-input-small';
      timeInput.value = item.time;
      timeInput.placeholder = 'HHMM';
      timeInput.maxLength = 4;
      timeInput.style.width = '80px';
      timeInput.dataset.index = index;
      timeInput.addEventListener('change', updateSchedulerTaskTime);
      timeCell.appendChild(timeInput);
      
      // Task cell
      const taskCell = row.insertCell();
      const taskSelect = document.createElement('select');
      taskSelect.className = 'form-input-small';
      taskSelect.dataset.index = index;
      taskSelect.innerHTML = `
        <option value="get_meteo_data" ${item.task === 'get_meteo_data' ? 'selected' : ''}>get_meteo_data</option>
        <option value="get_tibber_data" ${item.task === 'get_tibber_data' ? 'selected' : ''}>get_tibber_data</option>
        <option value="get_day_ahead_prices" ${item.task === 'get_day_ahead_prices' ? 'selected' : ''}>get_day_ahead_prices</option>
        <option value="calc_optimum" ${item.task === 'calc_optimum' ? 'selected' : ''}>calc_optimum</option>
        <option value="clean_data" ${item.task === 'clean_data' ? 'selected' : ''}>clean_data</option>
        <option value="calc_baseloads" ${item.task === 'calc_baseloads' ? 'selected' : ''}>calc_baseloads</option>
      `;
      taskSelect.addEventListener('change', updateSchedulerTaskType);
      taskCell.appendChild(taskSelect);
      
      // Delete cell
      const deleteCell = row.insertCell();
      deleteCell.style.textAlign = 'center';
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'btn btn-delete-small';
      deleteBtn.innerHTML = '×';
      deleteBtn.title = 'Delete task';
      deleteBtn.onclick = () => removeSchedulerTask(index);
      deleteCell.appendChild(deleteBtn);
    });
  }
  
  function addSchedulerTask() {
    schedulerTasks.push({ time: 'xx00', task: 'calc_optimum' });
    renderSchedulerTasks();
    markAsModified();
  }
  
  function removeSchedulerTask(index) {
    schedulerTasks.splice(index, 1);
    renderSchedulerTasks();
    markAsModified();
  }
  
  function updateSchedulerTaskTime(event) {
    const index = parseInt(event.target.dataset.index);
    let value = event.target.value.toLowerCase();
    
    // Validate time format (HHMM with xx allowed)
    if (value.length === 4 && /^([0-2x][0-9x])([0-5x][0-9x])$/.test(value)) {
      schedulerTasks[index].time = value;
      // Re-sort and re-render: wildcard times first, then normal times
      schedulerTasks.sort((a, b) => {
        const aHasWildcard = a.time.includes('x');
        const bHasWildcard = b.time.includes('x');
        
        // If one has wildcard and other doesn't, wildcard comes first
        if (aHasWildcard && !bHasWildcard) return -1;
        if (!aHasWildcard && bHasWildcard) return 1;
        
        // Otherwise sort alphabetically
        return a.time.localeCompare(b.time);
      });
      renderSchedulerTasks();
      markAsModified();
    } else {
      alert('Invalid time format. Use HHMM (00-23 for hours, 00-59 for minutes) or "xx" for wildcards.\nExamples: 0955, xx00, 12xx, xxxx');
      event.target.value = schedulerTasks[index].time;
    }
  }
  
  function updateSchedulerTaskType(event) {
    const index = parseInt(event.target.dataset.index);
    schedulerTasks[index].task = event.target.value;
    markAsModified();
  }
  
  function saveSchedulerConfiguration() {
    const scheduler = {
      active: document.getElementById('scheduler-active').value
    };
    
    // Add all scheduled tasks
    schedulerTasks.forEach(item => {
      scheduler[item.time] = item.task;
    });
    
    currentData.options.scheduler = scheduler;
    markAsModified();
  }

  // ===== PRICES CONFIGURATION FUNCTIONS =====
  
  function loadPricesConfiguration() {
    const prices = currentData.options.prices || {};
    
    // Load regular tariffs
    document.getElementById('prices-regular-high').value = prices['regular high'] || '';
    document.getElementById('prices-regular-low').value = prices['regular low'] || '';
    document.getElementById('prices-switch-to-low').value = prices['switch to low'] || '';
    
    // Load energy taxes (convert objects to JSON strings)
    document.getElementById('prices-energy-taxes-consumption').value = 
      prices['energy taxes consumption'] ? JSON.stringify(prices['energy taxes consumption'], null, 2) : '';
    document.getElementById('prices-energy-taxes-production').value = 
      prices['energy taxes production'] ? JSON.stringify(prices['energy taxes production'], null, 2) : '';
    
    // Load supplier costs
    document.getElementById('prices-cost-supplier-consumption').value = 
      prices['cost supplier consumption'] ? JSON.stringify(prices['cost supplier consumption'], null, 2) : '';
    document.getElementById('prices-cost-supplier-production').value = 
      prices['cost supplier production'] ? JSON.stringify(prices['cost supplier production'], null, 2) : '';
    
    // Load VAT rates
    document.getElementById('prices-vat-consumption').value = 
      prices['vat consumption'] ? JSON.stringify(prices['vat consumption'], null, 2) : '';
    document.getElementById('prices-vat-production').value = 
      prices['vat production'] ? JSON.stringify(prices['vat production'], null, 2) : '';
    
    // Load invoice settings
    document.getElementById('prices-last-invoice').value = prices['last invoice'] || '';
    document.getElementById('prices-tax-refund').value = prices['tax refund'] || 'False';
  }
  
  function savePricesConfiguration() {
    // Helper function to parse JSON or return empty object
    const parseJSON = (str) => {
      try {
        return str.trim() ? JSON.parse(str) : {};
      } catch (e) {
        console.error('Invalid JSON:', e);
        return {};
      }
    };
    
    const prices = {
      'regular high': parseFloat(document.getElementById('prices-regular-high').value) || 0,
      'regular low': parseFloat(document.getElementById('prices-regular-low').value) || 0,
      'switch to low': parseInt(document.getElementById('prices-switch-to-low').value) || 0,
      'energy taxes consumption': parseJSON(document.getElementById('prices-energy-taxes-consumption').value),
      'energy taxes production': parseJSON(document.getElementById('prices-energy-taxes-production').value),
      'cost supplier consumption': parseJSON(document.getElementById('prices-cost-supplier-consumption').value),
      'cost supplier production': parseJSON(document.getElementById('prices-cost-supplier-production').value),
      'vat consumption': parseJSON(document.getElementById('prices-vat-consumption').value),
      'vat production': parseJSON(document.getElementById('prices-vat-production').value),
      'last invoice': document.getElementById('prices-last-invoice').value,
      'tax refund': document.getElementById('prices-tax-refund').value
    };
    
    currentData.options.prices = prices;
    markAsModified();
  }

  // ===== JSON EDITOR MODAL FUNCTIONS =====
  
  function openJSONEditor(fieldId, title) {
    jsonEditorTargetField = fieldId;
    const textarea = document.getElementById(fieldId);
    const modal = document.getElementById('json-editor-modal');
    
    // Set title
    document.getElementById('json-editor-modal-title').textContent = 'Edit Date-Value Pairs';
    document.getElementById('json-editor-subtitle').textContent = title;
    
    // Parse existing JSON from textarea
    jsonEditorEntries = [];
    try {
      const jsonStr = textarea.value.trim();
      if (jsonStr) {
        const jsonObj = JSON.parse(jsonStr);
        // Convert object to array of entries
        jsonEditorEntries = Object.entries(jsonObj).map(([date, value]) => ({
          date: date,
          value: parseFloat(value) || 0
        }));
      }
    } catch (e) {
      console.error('Error parsing JSON:', e);
    }
    
    // Sort by date
    jsonEditorEntries.sort((a, b) => a.date.localeCompare(b.date));
    
    // Render entries
    renderJSONEntries();
    
    modal.style.display = 'block';
  }
  
  function closeJSONEditor() {
    document.getElementById('json-editor-modal').style.display = 'none';
    jsonEditorTargetField = null;
    jsonEditorEntries = [];
  }
  
  function renderJSONEntries() {
    const container = document.getElementById('json-entries-container');
    container.innerHTML = '';
    
    jsonEditorEntries.forEach((entry, index) => {
      const entryDiv = document.createElement('div');
      entryDiv.className = 'json-entry';
      
      entryDiv.innerHTML = `
        <div class="json-entry-fields">
          <div class="form-group">
            <label>Date:</label>
            <input type="date" class="form-input json-entry-date" value="${entry.date}" 
                   onchange="updateJSONEntry(${index}, 'date', this.value)">
          </div>
          <div class="form-group">
            <label>Value:</label>
            <input type="number" class="form-input json-entry-value" value="${entry.value}" step="0.00001"
                   onchange="updateJSONEntry(${index}, 'value', this.value)">
          </div>
        </div>
        <div class="json-entry-actions">
          <button class="btn-icon" onclick="deleteJSONEntry(${index})" title="Delete">
            <span class="material-icons">delete</span>
          </button>
        </div>
      `;
      
      container.appendChild(entryDiv);
    });
  }
  
  function addJSONEntry() {
    jsonEditorEntries.push({
      date: new Date().toISOString().split('T')[0],
      value: 0
    });
    renderJSONEntries();
  }
  
  function updateJSONEntry(index, field, value) {
    if (field === 'date') {
      jsonEditorEntries[index].date = value;
    } else if (field === 'value') {
      jsonEditorEntries[index].value = parseFloat(value) || 0;
    }
  }
  
  function deleteJSONEntry(index) {
    if (confirm('Are you sure you want to delete this entry?')) {
      jsonEditorEntries.splice(index, 1);
      renderJSONEntries();
    }
  }
  
  function saveJSONEditor() {
    if (!jsonEditorTargetField) {
      closeJSONEditor();
      return;
    }
    
    // Convert entries array back to object
    const jsonObj = {};
    jsonEditorEntries.forEach(entry => {
      if (entry.date) {
        jsonObj[entry.date] = entry.value;
      }
    });
    
    // Update textarea with formatted JSON
    const textarea = document.getElementById(jsonEditorTargetField);
    textarea.value = Object.keys(jsonObj).length > 0 ? JSON.stringify(jsonObj, null, 2) : '';
    
    // Trigger save
    savePricesConfiguration();
    
    closeJSONEditor();
  }

  // Render General tab options
  function renderGeneralOptions() {
    const container = document.querySelector('#options-general .options-list');
    container.innerHTML = '';
    
    // Day Ahead Group
    const dayAheadGroup = createOptionGroup('Day Ahead', [
      createSelectOption('Strategy', ['strategy'], ['minimize cost', 'minimize production'], 'Optimization strategy'),
      createNumberOption('Grid Max Power (kW)', ['grid', 'max_power'], 'Maximum grid power in kW'),
      createSelectOption('Interval', ['interval'], ['15min', 'hourly'], 'Calculation interval')
    ]);
    
    container.appendChild(dayAheadGroup);
    
    // Baseload Group
    const baseloadGroup = createBaseloadGroup();
    container.appendChild(baseloadGroup);
    
    // External Data Group
    const externalDataGroup = createOptionGroup('External Data', [
      createSelectOption('Source Day Ahead', ['prices', 'source day ahead'], ['nordpool', 'entsoe', 'easyenergy', 'tibber'], 'Day ahead price source'),
      createSecretReferenceOption('ENTSO-E API Key', ['prices', 'entsoe-api-key'], 'Reference to ENTSO-E API key secret'),
      createSecretReferenceOption('Meteoserver Key', ['meteoserver-key'], 'Reference to meteoserver API key secret'),
      createSecretReferenceOption('Tibber API Token', ['tibber', 'api_token'], 'Reference to Tibber API token secret')
    ]);
    
    container.appendChild(externalDataGroup);
  }

  // Render Homeassistant tab options (placeholder)
  function renderDatabaseOptions() {
    const container = document.querySelector('#options-database .options-list');
    container.innerHTML = '';
    
    // Home Assistant Group
    const homeassistantGroup = createOptionGroup('Home Assistant', [
      createTextOption('Host', ['homeassistant', 'host'], 'Home Assistant host address'),
      createNumberOption('IP Port', ['homeassistant', 'ip port'], 'Home Assistant port number'),
      createSelectOption('Protocol API', ['homeassistant', 'protocol api'], ['http', 'https'], 'API protocol'),
      createSecretReferenceOption('Token', ['homeassistant', 'token'], 'Reference to Home Assistant API token secret')
    ]);
    
    container.appendChild(homeassistantGroup);
    
    // Home Assistant Database Group
    const haDatabaseGroup = createDatabaseGroup('Home Assistant Database', 'database ha');
    container.appendChild(haDatabaseGroup);
    
    // DAO Database Group
    const daoDatabaseGroup = createDatabaseGroup('DAO Database', 'database da');
    container.appendChild(daoDatabaseGroup);
  }

  // Create a database configuration group with dynamic fields based on engine
  function createDatabaseGroup(title, pathPrefix) {
    const group = document.createElement('div');
    group.className = 'option-group';
    
    const header = document.createElement('div');
    header.className = 'option-group-header';
    header.textContent = title;
    group.appendChild(header);
    
    const content = document.createElement('div');
    content.className = 'option-group-content';
    
    const currentEngine = getOptionValue([pathPrefix, 'engine']) || 'sqlite';
    
    // Engine selector
    const engineOption = createSelectOption('Engine', [pathPrefix, 'engine'], ['sqlite', 'mysql', 'postgresql'], 'Database engine type');
    content.appendChild(engineOption);
    
    // Container for dynamic fields
    const dynamicFields = document.createElement('div');
    dynamicFields.className = 'dynamic-db-fields';
    dynamicFields.dataset.pathPrefix = pathPrefix;
    
    renderDatabaseFields(dynamicFields, pathPrefix, currentEngine);
    content.appendChild(dynamicFields);
    
    // Add change listener to engine selector
    const engineSelect = engineOption.querySelector('select');
    engineSelect.addEventListener('change', (e) => {
      const newEngine = e.target.value;
      renderDatabaseFields(dynamicFields, pathPrefix, newEngine);
    });
    
    group.appendChild(content);
    return group;
  }

  // Create baseload configuration group with dynamic fields
  function createBaseloadGroup() {
    const group = document.createElement('div');
    group.className = 'option-group';
    
    const header = document.createElement('div');
    header.className = 'option-group-header';
    header.textContent = 'Baseload';
    group.appendChild(header);
    
    const content = document.createElement('div');
    content.className = 'option-group-content';
    
    const useCalcBaseload = getOptionValue(['use_calc_baseload']);
    const isUsingCalc = useCalcBaseload === 'True' || useCalcBaseload === true;
    
    // Toggle for use_calc_baseload
    const toggleOption = createCheckboxOption('Use Calculated Baseload', ['use_calc_baseload'], 'Calculate baseload from historical data');
    content.appendChild(toggleOption);
    
    // Container for dynamic fields
    const dynamicFields = document.createElement('div');
    dynamicFields.className = 'dynamic-baseload-fields';
    
    renderBaseloadFields(dynamicFields, isUsingCalc);
    content.appendChild(dynamicFields);
    
    // Add change listener to toggle
    const checkbox = toggleOption.querySelector('input[type="checkbox"]');
    checkbox.addEventListener('change', (e) => {
      renderBaseloadFields(dynamicFields, e.target.checked);
    });
    
    group.appendChild(content);
    return group;
  }

  // Render baseload fields based on use_calc_baseload value
  function renderBaseloadFields(container, useCalc) {
    container.innerHTML = '';
    
    if (useCalc) {
      // Show calculation period
      container.appendChild(createNumberOption('Baseload Calculation Period (days)', ['baseload calc periode'], 'Number of days to use for calculating baseload'));
    } else {
      // Show 24 hour baseload inputs
      const baseloadArray = getOptionValue(['baseload']) || Array(24).fill(0);
      
      // Ensure we have exactly 24 values
      while (baseloadArray.length < 24) {
        baseloadArray.push(0);
      }
      
      // Create wrapper with caption
      const wrapper = document.createElement('div');
      wrapper.className = 'baseload-grid-wrapper';
      
      // Add caption
      const caption = document.createElement('div');
      caption.className = 'baseload-grid-caption';
      caption.textContent = 'Hour of the day';
      wrapper.appendChild(caption);
      
      // Create a special container for the 24-hour grid
      const gridContainer = document.createElement('div');
      gridContainer.className = 'baseload-grid';
      
      for (let hour = 0; hour < 24; hour++) {
        const hourItem = document.createElement('div');
        hourItem.className = 'baseload-hour-item';
        
        hourItem.innerHTML = `
          <label class="baseload-hour-label">${hour.toString().padStart(2, '0')}:00</label>
          <input type="number" 
                 class="baseload-hour-input" 
                 value="${baseloadArray[hour]}" 
                 step="0.01" 
                 data-hour="${hour}"
                 placeholder="kWh">
        `;
        
        const input = hourItem.querySelector('input');
        input.addEventListener('change', (e) => {
          const currentBaseload = getOptionValue(['baseload']) || Array(24).fill(0);
          currentBaseload[hour] = parseFloat(e.target.value) || 0;
          setOptionValue(['baseload'], currentBaseload);
        });
        
        gridContainer.appendChild(hourItem);
      }
      
      wrapper.appendChild(gridContainer);
      container.appendChild(wrapper);
    }
  }

  // Render database fields based on engine type
  function renderDatabaseFields(container, pathPrefix, engine) {
    container.innerHTML = '';
    
    if (engine === 'sqlite') {
      // SQLite: only needs db_path and optionally database name
      container.appendChild(createTextOption('Database Path', [pathPrefix, 'db_path'], 'Path to database directory'));
      
      // Only show database name if it exists in the config (for HA database)
      const dbName = getOptionValue([pathPrefix, 'database']);
      if (dbName !== undefined) {
        container.appendChild(createTextOption('Database Name', [pathPrefix, 'database'], 'Database filename'));
      }
    } else if (engine === 'mysql' || engine === 'postgresql') {
      // MySQL/PostgreSQL: need host, port, database, user, password
      container.appendChild(createTextOption('Host', [pathPrefix, 'server'], 'Database host address'));
      container.appendChild(createNumberOption('Port', [pathPrefix, 'port'], 'Database port number'));
      container.appendChild(createTextOption('Database', [pathPrefix, 'database'], 'Database name'));
      container.appendChild(createTextOption('User', [pathPrefix, 'username'], 'Database username'));
      container.appendChild(createSecretReferenceOption('Password', [pathPrefix, 'password'], 'Reference to database password secret'));
    }
  }

  // Render Dashboard tab options (placeholder)
  function renderDashboardOptions() {
    const container = document.querySelector('#options-dashboard .options-list');
    container.innerHTML = '';
    
    // Dashboard Group
    const dashboardGroup = createOptionGroup('Dashboard', [
      createNumberOption('Port', ['dashboard', 'port'], 'Dashboard web server port'),
      createSelectOption('Logging Level', ['logging level'], ['debug', 'info', 'warning', 'error'], 'Application logging level'),
      createNumberOption('History Save Days', ['history', 'save days'], 'Number of days to keep history')
    ]);
    
    container.appendChild(dashboardGroup);
    
    // Graphics Group
    const graphicsGroup = createOptionGroup('Graphics', [
      createTextOption('Graphical Backend', ['graphical backend'], 'Matplotlib backend (leave empty for default)'),
      createCheckboxOption('Show Graphics', ['graphics', 'show'], 'Enable or disable graphics generation'),
      createSelectOption('Style', ['graphics', 'style'], ['Solarize_Light2', 'default', 'seaborn', 'ggplot', 'bmh', 'grayscale', 'dark_background'], 'Matplotlib style'),
      createCheckboxOption('Average Consumption', ['graphics', 'average consumption'], 'Show average consumption line'),
      createCheckboxOption('Battery Balance', ['graphics', 'battery balance'], 'Show battery balance graph'),
      createCheckboxOption('Prices Consumption', ['graphics', 'prices consumption'], 'Show consumption prices'),
      createCheckboxOption('Prices Production', ['graphics', 'prices production'], 'Show production prices'),
      createCheckboxOption('Prices Spot', ['graphics', 'prices spot'], 'Show spot prices')
    ]);
    
    container.appendChild(graphicsGroup);
    
    // Notifications Group
    const notificationsGroup = createOptionGroup('Notifications', [
      createCheckboxOption('Opstarten', ['notifications', 'opstarten'], 'Send notification on startup'),
      createCheckboxOption('Berekening', ['notifications', 'berekening'], 'Send notification after calculation'),
      createTextOption('Notification Entity', ['notifications', 'notification entity'], 'Home Assistant notification entity'),
      createTextOption('Last Activity Entity', ['notifications', 'last activity entity'], 'Home Assistant last activity entity')
    ]);
    
    container.appendChild(notificationsGroup);
  }

  // Create an option group
  function createOptionGroup(title, options) {
    const group = document.createElement('div');
    group.className = 'option-group';
    
    const header = document.createElement('div');
    header.className = 'option-group-header';
    header.textContent = title;
    group.appendChild(header);
    
    const content = document.createElement('div');
    content.className = 'option-group-content';
    options.forEach(option => content.appendChild(option));
    group.appendChild(content);
    
    return group;
  }

  // Get nested value from options object
  function getOptionValue(path) {
    let value = currentData.options;
    for (const key of path) {
      value = value?.[key];
    }
    return value;
  }

  // Set nested value in options object
  function setOptionValue(path, value) {
    let obj = currentData.options;
    for (let i = 0; i < path.length - 1; i++) {
      if (!obj[path[i]]) {
        obj[path[i]] = {};
      }
      obj = obj[path[i]];
    }
    obj[path[path.length - 1]] = value;
    checkForUnsavedChanges();
  }

  // Create a number input option
  function createNumberOption(label, path, description = '') {
    const item = document.createElement('div');
    item.className = 'option-item';
    
    const value = getOptionValue(path);
    
    item.innerHTML = `
      <div class="option-info">
        <div class="option-label">${escapeHtml(label)}</div>
        ${description ? `<div class="option-description">${escapeHtml(description)}</div>` : ''}
      </div>
      <div class="option-control">
        <input type="number" class="option-input" value="${value}" step="any" data-path="${path.join('.')}">
      </div>
    `;
    
    const input = item.querySelector('input');
    input.addEventListener('change', (e) => {
      const newValue = parseFloat(e.target.value);
      setOptionValue(path, newValue);
    });
    
    return item;
  }

  // Create a text input option
  function createTextOption(label, path, description = '') {
    const item = document.createElement('div');
    item.className = 'option-item';
    
    const value = getOptionValue(path) || '';
    
    item.innerHTML = `
      <div class="option-info">
        <div class="option-label">${escapeHtml(label)}</div>
        ${description ? `<div class="option-description">${escapeHtml(description)}</div>` : ''}
      </div>
      <div class="option-control">
        <input type="text" class="option-input" value="${escapeHtml(value)}" data-path="${path.join('.')}">
      </div>
    `;
    
    const input = item.querySelector('input');
    input.addEventListener('change', (e) => {
      setOptionValue(path, e.target.value);
    });
    
    return item;
  }

  // Create a checkbox option
  function createCheckboxOption(label, path, description = '') {
    const item = document.createElement('div');
    item.className = 'option-item';
    
    const value = getOptionValue(path);
    // Handle string "True"/"False" or boolean values
    const isChecked = value === 'True' || value === true;
    
    item.innerHTML = `
      <div class="option-info">
        <div class="option-label">${escapeHtml(label)}</div>
        ${description ? `<div class="option-description">${escapeHtml(description)}</div>` : ''}
      </div>
      <div class="option-control">
        <label class="checkbox-container">
          <input type="checkbox" class="option-checkbox" ${isChecked ? 'checked' : ''} data-path="${path.join('.')}">
          <span class="checkbox-label">${isChecked ? 'Enabled' : 'Disabled'}</span>
        </label>
      </div>
    `;
    
    const checkbox = item.querySelector('input[type="checkbox"]');
    const checkboxLabel = item.querySelector('.checkbox-label');
    
    checkbox.addEventListener('change', (e) => {
      // Store as string "True"/"False" to match the existing format
      setOptionValue(path, e.target.checked ? 'True' : 'False');
      checkboxLabel.textContent = e.target.checked ? 'Enabled' : 'Disabled';
    });
    
    return item;
  }

  // Create a select dropdown option
  function createSelectOption(label, path, choices, description = '') {
    const item = document.createElement('div');
    item.className = 'option-item';
    
    const value = getOptionValue(path);
    
    const optionsHtml = choices.map(choice => 
      `<option value="${escapeHtml(choice)}" ${choice === value ? 'selected' : ''}>${escapeHtml(choice)}</option>`
    ).join('');
    
    item.innerHTML = `
      <div class="option-info">
        <div class="option-label">${escapeHtml(label)}</div>
        ${description ? `<div class="option-description">${escapeHtml(description)}</div>` : ''}
      </div>
      <div class="option-control">
        <select class="option-select" data-path="${path.join('.')}">
          ${optionsHtml}
        </select>
      </div>
    `;
    
    const select = item.querySelector('select');
    select.addEventListener('change', (e) => {
      setOptionValue(path, e.target.value);
    });
    
    return item;
  }

  // Create a secret reference option (dropdown with available secrets)
  function createSecretReferenceOption(label, path, description = '') {
    const item = document.createElement('div');
    item.className = 'option-item';
    
    const value = getOptionValue(path);
    
    // Get list of available secrets
    const secrets = Object.keys(currentData.secrets || {});
    
    // Extract secret name from value (handles "!secret secret_name" format)
    let currentSecret = '';
    if (value && typeof value === 'string') {
      if (value.startsWith('!secret ')) {
        currentSecret = value.substring(8); // Remove "!secret " prefix
      } else {
        currentSecret = value;
      }
    }
    
    const optionsHtml = [
      `<option value="">-- Select Secret --</option>`,
      ...secrets.map(secret => 
        `<option value="!secret ${escapeHtml(secret)}" ${currentSecret === secret ? 'selected' : ''}>!secret ${escapeHtml(secret)}</option>`
      )
    ].join('');
    
    item.innerHTML = `
      <div class="option-info">
        <div class="option-label">${escapeHtml(label)}</div>
        ${description ? `<div class="option-description">${escapeHtml(description)}</div>` : ''}
      </div>
      <div class="option-control">
        <select class="option-select secret-ref" data-path="${path.join('.')}">
          ${optionsHtml}
        </select>
      </div>
    `;
    
    const select = item.querySelector('select');
    select.addEventListener('change', (e) => {
      setOptionValue(path, e.target.value || '');
    });
    
    return item;
  }

  // Check if there are unsaved changes
  function checkForUnsavedChanges() {
    let hasChanges = false;
    
    if (currentTab === 'options') {
      hasChanges = JSON.stringify(currentData.options) !== JSON.stringify(originalData.options);
    } else {
      hasChanges = JSON.stringify(currentData.secrets) !== JSON.stringify(originalData.secrets);
    }
    
    if (hasChanges) {
      unsavedWarning.style.display = 'block';
    } else {
      unsavedWarning.style.display = 'none';
    }
  }

  // Switch options sub-tabs
  function switchOptionTab(tabName) {
    currentOptionTab = tabName;
    
    // Update tab buttons
    optionTabButtons.forEach(btn => {
      if (btn.dataset.optionTab === tabName) {
        btn.classList.add('active');
      } else {
        btn.classList.remove('active');
      }
    });
    
    // Update tab content visibility
    const tabContents = document.querySelectorAll('.option-tab-content');
    tabContents.forEach(content => {
      if (content.id === `options-${tabName}`) {
        content.style.display = 'block';
      } else {
        content.style.display = 'none';
      }
    });
    
    // Load data for specific tabs
    if (tabName === 'prices') {
      loadPricesConfiguration();
    } else if (tabName === 'reports') {
      loadReportConfiguration();
    } else if (tabName === 'scheduler') {
      loadSchedulerConfiguration();
    }
  }

  function switchOptimisationTab(tabName) {
    currentOptimisationTab = tabName;
    
    // Update tab buttons
    const optimisationTabButtons = document.querySelectorAll('.optimisation-tab-btn');
    optimisationTabButtons.forEach(btn => {
      if (btn.dataset.optimisationTab === tabName) {
        btn.classList.add('active');
      } else {
        btn.classList.remove('active');
      }
    });
    
    // Update tab content visibility
    const tabContents = document.querySelectorAll('.optimisation-tab-content');
    tabContents.forEach(content => {
      if (content.id === `optimisations-${tabName}`) {
        content.style.display = 'block';
      } else {
        content.style.display = 'none';
      }
    });
  }

  // Render secrets list
  function renderSecretsList() {
    secretsList.innerHTML = '';
    
    if (!currentData.secrets || Object.keys(currentData.secrets).length === 0) {
      secretsList.innerHTML = '<div class="empty-state">No secrets configured. Click "Add New Secret" to create one.</div>';
      return;
    }
    
    Object.keys(currentData.secrets).forEach(key => {
      const secretItem = document.createElement('div');
      secretItem.className = 'secret-item';
      
      const value = currentData.secrets[key];
      const maskedValue = '•'.repeat(Math.min(value.length, 20));
      
      secretItem.innerHTML = `
        <div class="secret-info">
          <div class="secret-key">${escapeHtml(key)}</div>
          <div class="secret-value-masked">${maskedValue}</div>
        </div>
        <div class="secret-actions">
          <button class="btn-icon btn-edit-secret" data-key="${escapeHtml(key)}" title="Edit">
            <span class="material-icons">edit</span>
          </button>
          <button class="btn-icon btn-delete-secret" data-key="${escapeHtml(key)}" title="Delete">
            <span class="material-icons">delete</span>
          </button>
        </div>
      `;
      
      secretsList.appendChild(secretItem);
    });
    
    // Add event listeners to edit and delete buttons
    document.querySelectorAll('.btn-edit-secret').forEach(btn => {
      btn.addEventListener('click', () => openEditSecretModal(btn.dataset.key));
    });
    
    document.querySelectorAll('.btn-delete-secret').forEach(btn => {
      btn.addEventListener('click', () => deleteSecret(btn.dataset.key));
    });
  }

  // Open modal to add new secret
  function openAddSecretModal() {
    editingSecretKey = null;
    modalTitle.textContent = 'Add New Secret';
    secretKeyInput.value = '';
    secretKeyInput.disabled = false;
    secretValueInput.value = '';
    secretValueInput.type = 'password';
    toggleVisibility.checked = false;
    secretModal.style.display = 'flex';
  }

  // Open modal to edit existing secret
  function openEditSecretModal(key) {
    editingSecretKey = key;
    modalTitle.textContent = 'Edit Secret';
    secretKeyInput.value = key;
    secretKeyInput.disabled = true; // Don't allow changing the key
    secretValueInput.value = currentData.secrets[key];
    secretValueInput.type = 'password';
    toggleVisibility.checked = false;
    secretModal.style.display = 'flex';
  }

  // Close modal
  function closeSecretModal() {
    secretModal.style.display = 'none';
    editingSecretKey = null;
  }

  // Save secret from modal
  function saveSecretFromModal() {
    const key = secretKeyInput.value.trim();
    const value = secretValueInput.value;
    
    if (!key) {
      showMessage('Secret key cannot be empty', 'error');
      return;
    }
    
    if (!value) {
      showMessage('Secret value cannot be empty', 'error');
      return;
    }
    
    // Check if key already exists (only when adding new)
    if (!editingSecretKey && currentData.secrets.hasOwnProperty(key)) {
      showMessage('Secret with this key already exists', 'error');
      return;
    }
    
    // If editing and key changed (shouldn't happen, but just in case)
    if (editingSecretKey && editingSecretKey !== key) {
      delete currentData.secrets[editingSecretKey];
    }
    
    currentData.secrets[key] = value;
    renderSecretsList();
    closeSecretModal();
    
    if (editingSecretKey) {
      showMessage(`Secret "${key}" modified successfully`, 'success');
    } else {
      showMessage(`Secret "${key}" added successfully`, 'success');
    }
    
    checkForUnsavedChanges();
  }

  // Delete secret
  function deleteSecret(key) {
    if (confirm(`Are you sure you want to delete the secret "${key}"?`)) {
      delete currentData.secrets[key];
      renderSecretsList();
      showMessage(`Secret "${key}" deleted`, 'info');
      checkForUnsavedChanges();
    }
  }

  // Save data to API
  async function saveData() {
    if (currentTab === 'options') {
      // Handle options save (UI-based)
      try {
        const response = await fetch('/api/settings/options.json', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(currentData.options)
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Failed to save options');
        }

        const result = await response.json();
        originalData.options = JSON.parse(JSON.stringify(currentData.options));
        
        showMessage(result.message || 'Options saved successfully', 'success');
        checkForUnsavedChanges();
      } catch (error) {
        showMessage('Error saving options: ' + error.message, 'error');
      }
    } else {
      // Handle secrets save (UI-based)
      try {
        const response = await fetch('/api/settings/secrets.json', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(currentData.secrets)
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Failed to save secrets');
        }

        const result = await response.json();
        originalData.secrets = JSON.parse(JSON.stringify(currentData.secrets));
        
        showMessage(result.message || 'Secrets saved successfully', 'success');
        checkForUnsavedChanges();
      } catch (error) {
        showMessage('Error saving secrets: ' + error.message, 'error');
      }
    }
  }

  // Cancel changes
  function cancelChanges() {
    if (currentTab === 'options') {
      currentData.options = JSON.parse(JSON.stringify(originalData.options));
      renderOptionsUI();
    } else {
      currentData.secrets = JSON.parse(JSON.stringify(originalData.secrets));
      renderSecretsList();
    }
    
    showMessage('Changes cancelled', 'info');
    checkForUnsavedChanges();
  }

  // Show message
  function showMessage(message, type = 'info') {
    messageArea.textContent = message;
    messageArea.className = 'message message-' + type;
    messageArea.style.display = 'block';
    
    setTimeout(() => {
      messageArea.style.display = 'none';
    }, 5000);
  }

  // Switch tabs
  function switchTab(tab) {
    currentTab = tab;
    
    tabButtons.forEach(btn => {
      if (btn.dataset.tab === tab) {
        btn.classList.add('chosen');
      } else {
        btn.classList.remove('chosen');
      }
    });
    
    if (tab === 'options') {
      editorOptions.style.display = 'block';
      editorSecrets.style.display = 'none';
      // Re-render options in case secrets changed
      renderOptionsUI();
    } else {
      editorOptions.style.display = 'none';
      editorSecrets.style.display = 'block';
    }
    
    checkForUnsavedChanges();
  }

  // Escape HTML to prevent XSS
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Event listeners
  tabButtons.forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      switchTab(btn.dataset.tab);
    });
  });

  btnSave.addEventListener('click', (e) => {
    e.preventDefault();
    saveData();
  });

  btnCancel.addEventListener('click', (e) => {
    e.preventDefault();
    cancelChanges();
  });

  // Secrets UI event listeners
  btnAddSecret.addEventListener('click', () => openAddSecretModal());
  btnSaveSecret.addEventListener('click', () => saveSecretFromModal());
  btnCancelSecret.addEventListener('click', () => closeSecretModal());
  modalClose.addEventListener('click', () => closeSecretModal());
  
  // Toggle password visibility
  toggleVisibility.addEventListener('change', (e) => {
    secretValueInput.type = e.target.checked ? 'text' : 'password';
  });
  
  // Close modal when clicking outside
  window.addEventListener('click', (e) => {
    if (e.target === secretModal) {
      closeSecretModal();
    }
  });

  // Options sub-tabs event listeners
  optionTabButtons.forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      switchOptionTab(btn.dataset.optionTab);
    });
  });

  // Optimisation sub-tabs event listeners
  const optimisationTabButtons = document.querySelectorAll('.optimisation-tab-btn');
  optimisationTabButtons.forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      switchOptimisationTab(btn.dataset.optimisationTab);
    });
  });

  // Solar modal event listeners
  const btnAddSolar = document.getElementById('btn-add-solar');
  const btnSaveSolar = document.getElementById('btn-save-solar');
  const btnCancelSolar = document.getElementById('btn-cancel-solar');
  const btnAddString = document.getElementById('btn-add-string');
  const solarClose = document.querySelector('.solar-close');

  if (btnAddSolar) {
    btnAddSolar.addEventListener('click', () => openSolarModal());
  }

  if (btnSaveSolar) {
    btnSaveSolar.addEventListener('click', saveSolarPanel);
  }

  if (btnCancelSolar) {
    btnCancelSolar.addEventListener('click', closeSolarModal);
  }

  if (btnAddString) {
    btnAddString.addEventListener('click', addSolarString);
  }

  if (solarClose) {
    solarClose.addEventListener('click', closeSolarModal);
  }

  // Close solar modal when clicking outside
  window.addEventListener('click', (e) => {
    const solarModal = document.getElementById('solar-modal');
    if (e.target === solarModal) {
      closeSolarModal();
    }
  });

  // Battery modal event listeners
  const btnAddBattery = document.getElementById('btn-add-battery');
  const btnSaveBattery = document.getElementById('btn-save-battery');
  const btnCancelBattery = document.getElementById('btn-cancel-battery');
  const btnAddChargeStage = document.getElementById('btn-add-charge-stage');
  const btnAddDischargeStage = document.getElementById('btn-add-discharge-stage');
  const btnAddReducedHour = document.getElementById('btn-add-reduced-hour');
  const btnAddBatterySolar = document.getElementById('btn-add-battery-solar');
  const batteryClose = document.querySelector('.battery-close');

  if (btnAddBattery) {
    btnAddBattery.addEventListener('click', () => openBatteryModal());
  }

  if (btnSaveBattery) {
    btnSaveBattery.addEventListener('click', saveBattery);
  }

  if (btnCancelBattery) {
    btnCancelBattery.addEventListener('click', closeBatteryModal);
  }

  if (btnAddChargeStage) {
    btnAddChargeStage.addEventListener('click', addBatteryChargeStage);
  }

  if (btnAddDischargeStage) {
    btnAddDischargeStage.addEventListener('click', addBatteryDischargeStage);
  }

  if (btnAddReducedHour) {
    btnAddReducedHour.addEventListener('click', addBatteryReducedHour);
  }

  if (btnAddBatterySolar) {
    btnAddBatterySolar.addEventListener('click', () => openBatterySolarModal());
  }

  if (batteryClose) {
    batteryClose.addEventListener('click', closeBatteryModal);
  }

  // Battery tab switching
  document.querySelectorAll('.battery-tab-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const tabId = e.currentTarget.dataset.tab;
      switchBatteryTab(tabId);
    });
  });

  // Close battery modal when clicking outside
  window.addEventListener('click', (e) => {
    const batteryModal = document.getElementById('battery-modal');
    if (e.target === batteryModal) {
      closeBatteryModal();
    }
  });

  // EV modal event listeners
  const btnAddEV = document.getElementById('btn-add-ev');
  const btnSaveEV = document.getElementById('btn-save-ev');
  const btnCancelEV = document.getElementById('btn-cancel-ev');
  const btnAddEVChargeStage = document.getElementById('btn-add-ev-charge-stage');
  const evClose = document.querySelector('.ev-close');

  if (btnAddEV) {
    btnAddEV.addEventListener('click', () => openEVModal());
  }

  if (btnSaveEV) {
    btnSaveEV.addEventListener('click', saveEV);
  }

  if (btnCancelEV) {
    btnCancelEV.addEventListener('click', closeEVModal);
  }

  if (btnAddEVChargeStage) {
    btnAddEVChargeStage.addEventListener('click', addEVChargeStage);
  }

  if (evClose) {
    evClose.addEventListener('click', closeEVModal);
  }

  // EV tab switching
  document.querySelectorAll('.ev-tab-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const tabId = e.currentTarget.dataset.tab;
      switchEVTab(tabId);
    });
  });

  // Close EV modal when clicking outside
  window.addEventListener('click', (e) => {
    const evModal = document.getElementById('ev-modal');
    if (e.target === evModal) {
      closeEVModal();
    }
  });

  // Machine modal event listeners
  const btnAddMachine = document.getElementById('btn-add-machine');
  const btnSaveMachine = document.getElementById('btn-save-machine');
  const btnCancelMachine = document.getElementById('btn-cancel-machine');
  const btnAddMachineProgram = document.getElementById('btn-add-machine-program');
  const machineClose = document.querySelector('.machine-close');
  const btnSaveMachineProgram = document.getElementById('btn-save-machine-program');
  const btnCancelMachineProgram = document.getElementById('btn-cancel-machine-program');
  const machineProgramClose = document.querySelector('.machine-program-close');

  if (btnAddMachine) {
    btnAddMachine.addEventListener('click', () => openMachineModal());
  }

  if (btnSaveMachine) {
    btnSaveMachine.addEventListener('click', saveMachine);
  }

  if (btnCancelMachine) {
    btnCancelMachine.addEventListener('click', closeMachineModal);
  }

  if (btnAddMachineProgram) {
    btnAddMachineProgram.addEventListener('click', addMachineProgram);
  }

  if (machineClose) {
    machineClose.addEventListener('click', closeMachineModal);
  }

  if (btnSaveMachineProgram) {
    btnSaveMachineProgram.addEventListener('click', saveMachineProgram);
  }

  if (btnCancelMachineProgram) {
    btnCancelMachineProgram.addEventListener('click', closeMachineProgramModal);
  }

  if (machineProgramClose) {
    machineProgramClose.addEventListener('click', closeMachineProgramModal);
  }

  // Machine tab switching
  document.querySelectorAll('.machine-tab-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const tabId = e.currentTarget.dataset.tab;
      switchMachineTab(tabId);
    });
  });

  // Close machine modal when clicking outside
  window.addEventListener('click', (e) => {
    const machineModal = document.getElementById('machine-modal');
    if (e.target === machineModal) {
      closeMachineModal();
    }
    
    const machineProgramModal = document.getElementById('machine-program-modal');
    if (e.target === machineProgramModal) {
      closeMachineProgramModal();
    }
  });

  // Scheduler event listeners
  const btnAddSchedulerTask = document.getElementById('btn-add-scheduler-task');
  if (btnAddSchedulerTask) {
    btnAddSchedulerTask.addEventListener('click', addSchedulerTask);
  }

  // Scheduler active dropdown listener
  const schedulerActive = document.getElementById('scheduler-active');
  if (schedulerActive) {
    schedulerActive.addEventListener('change', () => {
      saveSchedulerConfiguration();
    });
  }

  // JSON Editor modal event listeners
  const btnAddJSONEntry = document.getElementById('btn-add-json-entry');
  const btnSaveJSONEditor = document.getElementById('btn-save-json-editor');
  const btnCancelJSONEditor = document.getElementById('btn-cancel-json-editor');
  const jsonEditorClose = document.querySelector('.json-editor-close');

  if (btnAddJSONEntry) {
    btnAddJSONEntry.addEventListener('click', addJSONEntry);
  }

  if (btnSaveJSONEditor) {
    btnSaveJSONEditor.addEventListener('click', saveJSONEditor);
  }

  if (btnCancelJSONEditor) {
    btnCancelJSONEditor.addEventListener('click', closeJSONEditor);
  }

  if (jsonEditorClose) {
    jsonEditorClose.addEventListener('click', closeJSONEditor);
  }

  // Close JSON editor modal when clicking outside
  window.addEventListener('click', (e) => {
    const jsonEditorModal = document.getElementById('json-editor-modal');
    if (e.target === jsonEditorModal) {
      closeJSONEditor();
    }
  });

  // Report configuration uses dynamic entity lists - no static event listeners needed

  // Prices configuration event listeners - add change listeners to all prices input fields
  const pricesInputIds = [
    'prices-regular-high',
    'prices-regular-low',
    'prices-switch-to-low',
    'prices-energy-taxes-consumption',
    'prices-energy-taxes-production',
    'prices-cost-supplier-consumption',
    'prices-cost-supplier-production',
    'prices-vat-consumption',
    'prices-vat-production',
    'prices-last-invoice',
    'prices-tax-refund'
  ];

  pricesInputIds.forEach(id => {
    const input = document.getElementById(id);
    if (input) {
      input.addEventListener('change', savePricesConfiguration);
      input.addEventListener('blur', savePricesConfiguration);
    }
  });

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', () => {
    loadData();
  });
</script>

<!-- Help System JavaScript -->
<script src="{{ url_for('static', filename='config_help.js') }}"></script>

<!-- Home Assistant Entity Search JavaScript -->
<script src="{{ url_for('static', filename='config_ha_entities.js') }}"></script>

<script>
  // Initialize Home Assistant entity autocomplete
  document.addEventListener('DOMContentLoaded', async () => {
    try {
      // Pre-fetch entities for faster autocomplete (optional but recommended)
      console.log('Pre-fetching Home Assistant entities...');
      await haEntitySearch.prefetch();
      console.log('Home Assistant entities loaded successfully');
      
      // Attach autocomplete to all entity input fields
      // This will be called whenever modals are opened to ensure dynamic fields get autocomplete
      initializeEntityAutocomplete();
      
    } catch (error) {
      console.warn('Could not load Home Assistant entities:', error);
      // Graceful degradation - forms will still work with manual entry
    }
  });

  /**
   * Initialize autocomplete on all entity input fields
   * Call this function after dynamically creating forms/modals
   */
  function initializeEntityAutocomplete() {
    // Solar entities
    const solarPvSwitch = document.getElementById('solar-entity-pv-switch');
    if (solarPvSwitch && !solarPvSwitch.parentElement?.classList.contains('entity-autocomplete-wrapper')) {
      haEntitySearch.attachAutocomplete(solarPvSwitch, 'input_boolean');
    }
    
    // Battery entities
    const batteryLevel = document.getElementById('battery-entity-level');
    if (batteryLevel && !batteryLevel.parentElement?.classList.contains('entity-autocomplete-wrapper')) {
      haEntitySearch.attachAutocomplete(batteryLevel, 'sensor');
    }
    
    const batteryMinSoc = document.getElementById('battery-entity-min-soc');
    if (batteryMinSoc && !batteryMinSoc.parentElement?.classList.contains('entity-autocomplete-wrapper')) {
      haEntitySearch.attachAutocomplete(batteryMinSoc, 'input_number');
    }
    
    const batteryMaxSoc = document.getElementById('battery-entity-max-soc');
    if (batteryMaxSoc && !batteryMaxSoc.parentElement?.classList.contains('entity-autocomplete-wrapper')) {
      haEntitySearch.attachAutocomplete(batteryMaxSoc, 'input_number');
    }
    
    const batteryPowerFeedin = document.getElementById('battery-entity-power-feedin');
    if (batteryPowerFeedin && !batteryPowerFeedin.parentElement?.classList.contains('entity-autocomplete-wrapper')) {
      haEntitySearch.attachAutocomplete(batteryPowerFeedin, 'number');
    }
    
    const batteryOperatingMode = document.getElementById('battery-entity-operating-mode');
    if (batteryOperatingMode && !batteryOperatingMode.parentElement?.classList.contains('entity-autocomplete-wrapper')) {
      haEntitySearch.attachAutocomplete(batteryOperatingMode, 'select');
    }
    
    const batteryStopInverter = document.getElementById('battery-entity-stop-inverter');
    if (batteryStopInverter && !batteryStopInverter.parentElement?.classList.contains('entity-autocomplete-wrapper')) {
      haEntitySearch.attachAutocomplete(batteryStopInverter, '');
    }
    
    const batteryBalanceSwitch = document.getElementById('battery-entity-balance-switch');
    if (batteryBalanceSwitch && !batteryBalanceSwitch.parentElement?.classList.contains('entity-autocomplete-wrapper')) {
      haEntitySearch.attachAutocomplete(batteryBalanceSwitch, 'input_boolean');
    }
    
    const batteryFromBattery = document.getElementById('battery-entity-from-battery');
    if (batteryFromBattery && !batteryFromBattery.parentElement?.classList.contains('entity-autocomplete-wrapper')) {
      haEntitySearch.attachAutocomplete(batteryFromBattery, 'input_number');
    }
    
    const batteryFromPv = document.getElementById('battery-entity-from-pv');
    if (batteryFromPv && !batteryFromPv.parentElement?.classList.contains('entity-autocomplete-wrapper')) {
      haEntitySearch.attachAutocomplete(batteryFromPv, 'input_number');
    }
    
    const batteryFromAc = document.getElementById('battery-entity-from-ac');
    if (batteryFromAc && !batteryFromAc.parentElement?.classList.contains('entity-autocomplete-wrapper')) {
      haEntitySearch.attachAutocomplete(batteryFromAc, 'input_number');
    }
    
    const batteryCalculatedSoc = document.getElementById('battery-entity-calculated-soc');
    if (batteryCalculatedSoc && !batteryCalculatedSoc.parentElement?.classList.contains('entity-autocomplete-wrapper')) {
      haEntitySearch.attachAutocomplete(batteryCalculatedSoc, 'input_number');
    }
    
    // EV entities
    const evPosition = document.getElementById('ev-entity-position');
    if (evPosition && !evPosition.parentElement?.classList.contains('entity-autocomplete-wrapper')) {
      haEntitySearch.attachAutocomplete(evPosition, 'device_tracker');
    }
    
    const evMaxAmperage = document.getElementById('ev-entity-max-amperage');
    if (evMaxAmperage && !evMaxAmperage.parentElement?.classList.contains('entity-autocomplete-wrapper')) {
      haEntitySearch.attachAutocomplete(evMaxAmperage, 'sensor');
    }
    
    const evActualLevel = document.getElementById('ev-entity-actual-level');
    if (evActualLevel && !evActualLevel.parentElement?.classList.contains('entity-autocomplete-wrapper')) {
      haEntitySearch.attachAutocomplete(evActualLevel, 'sensor');
    }
    
    const evPluggedIn = document.getElementById('ev-entity-plugged-in');
    if (evPluggedIn && !evPluggedIn.parentElement?.classList.contains('entity-autocomplete-wrapper')) {
      haEntitySearch.attachAutocomplete(evPluggedIn, 'binary_sensor');
    }
    
    const evChargeSwitch = document.getElementById('ev-charge-switch');
    if (evChargeSwitch && !evChargeSwitch.parentElement?.classList.contains('entity-autocomplete-wrapper')) {
      haEntitySearch.attachAutocomplete(evChargeSwitch, 'switch');
    }
    
    const evChargingAmpere = document.getElementById('ev-entity-set-charging-ampere');
    if (evChargingAmpere && !evChargingAmpere.parentElement?.classList.contains('entity-autocomplete-wrapper')) {
      haEntitySearch.attachAutocomplete(evChargingAmpere, 'input_number');
    }
    
    const evStopCharging = document.getElementById('ev-entity-stop-charging');
    if (evStopCharging && !evStopCharging.parentElement?.classList.contains('entity-autocomplete-wrapper')) {
      haEntitySearch.attachAutocomplete(evStopCharging, 'input_datetime');
    }
    
    const evSetLevel = document.getElementById('ev-scheduler-entity-set-level');
    if (evSetLevel && !evSetLevel.parentElement?.classList.contains('entity-autocomplete-wrapper')) {
      haEntitySearch.attachAutocomplete(evSetLevel, 'input_number');
    }
    
    const evReadyDatetime = document.getElementById('ev-scheduler-entity-ready-datetime');
    if (evReadyDatetime && !evReadyDatetime.parentElement?.classList.contains('entity-autocomplete-wrapper')) {
      haEntitySearch.attachAutocomplete(evReadyDatetime, 'input_datetime');
    }
    
    // Machine entities
    const machineStartWindow = document.getElementById('machine-entity-start-window');
    if (machineStartWindow && !machineStartWindow.parentElement?.classList.contains('entity-autocomplete-wrapper')) {
      haEntitySearch.attachAutocomplete(machineStartWindow, 'input_datetime');
    }
    
    const machineEndWindow = document.getElementById('machine-entity-end-window');
    if (machineEndWindow && !machineEndWindow.parentElement?.classList.contains('entity-autocomplete-wrapper')) {
      haEntitySearch.attachAutocomplete(machineEndWindow, 'input_datetime');
    }
    
    const machineSelectedProgram = document.getElementById('machine-entity-selected-program');
    if (machineSelectedProgram && !machineSelectedProgram.parentElement?.classList.contains('entity-autocomplete-wrapper')) {
      haEntitySearch.attachAutocomplete(machineSelectedProgram, 'input_select');
    }
    
    const machineCalculatedStart = document.getElementById('machine-entity-calculated-start');
    if (machineCalculatedStart && !machineCalculatedStart.parentElement?.classList.contains('entity-autocomplete-wrapper')) {
      haEntitySearch.attachAutocomplete(machineCalculatedStart, 'input_datetime');
    }
    
    const machineCalculatedEnd = document.getElementById('machine-entity-calculated-end');
    if (machineCalculatedEnd && !machineCalculatedEnd.parentElement?.classList.contains('entity-autocomplete-wrapper')) {
      haEntitySearch.attachAutocomplete(machineCalculatedEnd, 'input_datetime');
    }
  }
  
  // Re-initialize autocomplete when modals are opened
  // Hook into existing modal open functions
  const originalOpenSolarModal = window.openSolarModal;
  if (typeof originalOpenSolarModal === 'function') {
    window.openSolarModal = function() {
      originalOpenSolarModal.apply(this, arguments);
      setTimeout(initializeEntityAutocomplete, 100);
    };
  }
  
  const originalOpenBatteryModal = window.openBatteryModal;
  if (typeof originalOpenBatteryModal === 'function') {
    window.openBatteryModal = function() {
      originalOpenBatteryModal.apply(this, arguments);
      setTimeout(initializeEntityAutocomplete, 100);
    };
  }
  
  const originalOpenEvModal = window.openEvModal;
  if (typeof originalOpenEvModal === 'function') {
    window.openEvModal = function() {
      originalOpenEvModal.apply(this, arguments);
      setTimeout(initializeEntityAutocomplete, 100);
    };
  }
  
  const originalOpenMachineModal = window.openMachineModal;
  if (typeof originalOpenMachineModal === 'function') {
    window.openMachineModal = function() {
      originalOpenMachineModal.apply(this, arguments);
      setTimeout(initializeEntityAutocomplete, 100);
    };
  }
</script>

<style>
  .config-container {
    width: 100%;
  }

  .editor-panel {
    width: 100%;
    margin-top: 20px;
  }

  .message {
    padding: 10px;
    margin: 10px 0;
    border-radius: 4px;
    font-weight: bold;
  }

  .message-success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }

  .message-error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
  }

  .message-info {
    background-color: #d1ecf1;
    color: #0c5460;
    border: 1px solid #bee5eb;
  }

  .warning-banner {
    padding: 12px 15px;
    margin: 10px 0;
    background-color: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
    border-radius: 4px;
    font-weight: bold;
    text-align: center;
    animation: fadeIn 0.3s ease-in;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Options UI Styles */
  .options-ui {
    width: 100%;
  }

  .options-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid #ddd;
  }

  .options-header h3 {
    margin: 0;
    font-size: 1.5em;
  }

  .options-tabs {
    display: flex;
    gap: 5px;
    margin-bottom: 20px;
    border-bottom: 2px solid #dee2e6;
    padding-bottom: 0;
  }

  .option-tab-btn {
    padding: 10px 20px;
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-bottom: none;
    border-radius: 4px 4px 0 0;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    color: #6c757d;
    transition: all 0.2s;
    position: relative;
    bottom: -2px;
  }

  .option-tab-btn:hover {
    color: #007bff;
    background-color: #e9ecef;
    border-color: #007bff;
  }

  .option-tab-btn.active {
    color: #007bff;
    background-color: white;
    border-color: #007bff;
    border-bottom: 2px solid white;
    font-weight: bold;
    box-shadow: 0 -2px 4px rgba(0, 123, 255, 0.1);
  }

  .option-tab-content {
    width: 100%;
  }

  /* Optimisation Sub-tabs */
  .optimisation-tabs {
    display: flex;
    gap: 5px;
    margin: 15px 0 20px 0;
    border-bottom: 2px solid #dee2e6;
    padding-bottom: 0;
  }

  .optimisation-tab-btn {
    padding: 8px 16px;
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-bottom: none;
    border-radius: 4px 4px 0 0;
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
    color: #6c757d;
    transition: all 0.2s;
    position: relative;
    bottom: -2px;
  }

  .optimisation-tab-btn:hover {
    color: #28a745;
    background-color: #e9ecef;
    border-color: #28a745;
  }

  .optimisation-tab-btn.active {
    color: #28a745;
    background-color: white;
    border-color: #28a745;
    border-bottom: 2px solid white;
    font-weight: bold;
    box-shadow: 0 -2px 4px rgba(40, 167, 69, 0.1);
  }

  .optimisation-tab-content {
    width: 100%;
  }

  /* Battery Modal Tabs */
  .battery-tabs {
    display: flex;
    gap: 5px;
    margin-bottom: 20px;
    border-bottom: 2px solid #dee2e6;
    padding-bottom: 0;
  }

  .battery-tab-btn {
    padding: 10px 20px;
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-bottom: none;
    border-radius: 4px 4px 0 0;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    color: #6c757d;
    transition: all 0.2s;
    position: relative;
    bottom: -2px;
  }

  .battery-tab-btn:hover {
    color: #007bff;
    background-color: #e9ecef;
    border-color: #007bff;
  }

  .battery-tab-btn.active {
    color: #007bff;
    background-color: white;
    border-color: #007bff;
    border-bottom: 2px solid white;
    font-weight: bold;
    box-shadow: 0 -2px 4px rgba(0, 123, 255, 0.1);
  }

  .battery-tab-content {
    display: none;
    width: 100%;
    padding-top: 10px;
    max-height: 400px;
    overflow-y: auto;
    overflow-x: hidden;
    padding-right: 10px;
  }

  .battery-tab-content.active {
    display: block;
  }

  /* EV Modal Tabs */
  .ev-tabs {
    display: flex;
    gap: 5px;
    margin-bottom: 20px;
    border-bottom: 2px solid #dee2e6;
    padding-bottom: 0;
  }

  .ev-tab-btn {
    padding: 10px 20px;
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-bottom: none;
    border-radius: 4px 4px 0 0;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    color: #6c757d;
    transition: all 0.2s;
    position: relative;
    bottom: -2px;
  }

  .ev-tab-btn:hover {
    color: #007bff;
    background-color: #e9ecef;
    border-color: #007bff;
  }

  .ev-tab-btn.active {
    color: #007bff;
    background-color: white;
    border-color: #007bff;
    border-bottom: 2px solid white;
    font-weight: bold;
    box-shadow: 0 -2px 4px rgba(0, 123, 255, 0.1);
  }

  .ev-tab-content {
    display: none;
    width: 100%;
    padding-top: 10px;
  }

  .ev-tab-content.active {
    display: block;
  }

  /* Machine Modal Tabs */
  .machine-tabs {
    display: flex;
    gap: 5px;
    margin-bottom: 20px;
    border-bottom: 2px solid #dee2e6;
    padding-bottom: 0;
  }

  .machine-tab-btn {
    padding: 10px 20px;
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-bottom: none;
    border-radius: 4px 4px 0 0;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    color: #6c757d;
    transition: all 0.2s;
    position: relative;
    bottom: -2px;
  }

  .machine-tab-btn:hover {
    color: #28a745;
    background-color: #e9ecef;
    border-color: #28a745;
  }

  .machine-tab-btn.active {
    color: #28a745;
    background-color: white;
    border-color: #28a745;
    border-bottom: 2px solid white;
    font-weight: bold;
    box-shadow: 0 -2px 4px rgba(40, 167, 69, 0.1);
  }

  .machine-tab-content {
    display: none;
    width: 100%;
    padding-top: 10px;
  }

  .machine-tab-content.active {
    display: block;
  }

  .programs-container {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 20px;
  }

  /* Report Configuration */
  .report-section {
    margin-bottom: 30px;
    padding: 20px;
    background-color: #f8f9fa;
    border-radius: 5px;
    border-left: 4px solid #007bff;
  }

  .report-section h5 {
    margin: 0 0 15px 0;
    color: #495057;
    font-size: 16px;
    font-weight: 600;
  }

  .report-entity-group {
    margin-bottom: 20px;
  }

  .report-entity-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #495057;
  }

  .report-entity-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 10px;
    min-height: 20px;
  }

  .report-entity-item {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .report-entity-item input {
    flex: 1;
  }

  .report-entity-item .entity-autocomplete-wrapper {
    flex: 1;
    display: flex;
  }

  .report-entity-empty {
    padding: 15px;
    text-align: center;
    color: #6c757d;
    font-style: italic;
    background-color: white;
    border: 1px dashed #dee2e6;
    border-radius: 4px;
  }

  .btn-add-small {
    padding: 6px 12px;
    font-size: 13px;
    border-radius: 4px;
    background-color: #28a745;
    color: white;
    border: none;
    cursor: pointer;
    transition: background-color 0.2s;
  }

  .btn-add-small:hover {
    background-color: #218838;
  }

  /* Prices Configuration */
  .prices-section {
    margin-bottom: 30px;
    padding: 20px;
    background-color: #f8f9fa;
    border-radius: 5px;
    border-left: 4px solid #28a745;
  }

  /* Scheduler Configuration */
  .scheduler-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    background-color: white;
    border-radius: 5px;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }

  .scheduler-table thead {
    background-color: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
  }

  .scheduler-table th {
    padding: 12px;
    text-align: left;
    font-weight: 600;
    color: #495057;
    font-size: 14px;
  }

  .scheduler-table tbody tr {
    border-bottom: 1px solid #dee2e6;
    transition: background-color 0.2s;
  }

  .scheduler-table tbody tr:hover {
    background-color: #f8f9fa;
  }

  .scheduler-table tbody tr:last-child {
    border-bottom: none;
  }

  .scheduler-table td {
    padding: 10px 12px;
  }

  .form-input-small {
    width: 100%;
    padding: 6px 10px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 14px;
    transition: border-color 0.2s;
  }

  .form-input-small:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
  }

  .btn-delete-small {
    background-color: #dc3545;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 4px 10px;
    font-size: 18px;
    line-height: 1;
    cursor: pointer;
    transition: background-color 0.2s;
  }

  .btn-delete-small:hover {
    background-color: #c82333;
  }

  .prices-section h5 {
    margin: 0 0 15px 0;
    color: #495057;
    font-size: 16px;
    font-weight: 600;
  }

  /* JSON Field Container */
  .json-field-container {
    display: flex;
    gap: 10px;
    align-items: flex-start;
  }

  .json-textarea {
    flex: 1;
    font-family: 'Courier New', monospace;
    font-size: 13px;
  }

  .btn-json-edit {
    display: flex;
    align-items: center;
    gap: 5px;
    white-space: nowrap;
    padding: 8px 15px;
    margin-top: 0;
  }

  .btn-json-edit .material-icons {
    font-size: 18px;
  }

  /* JSON Editor Modal */
  .json-entries-container {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-bottom: 20px;
    max-height: 400px;
    overflow-y: auto;
  }

  .json-entry {
    display: flex;
    gap: 10px;
    align-items: flex-start;
    padding: 15px;
    background-color: #f8f9fa;
    border-radius: 5px;
    border-left: 3px solid #6c757d;
  }

  .json-entry-fields {
    display: flex;
    gap: 15px;
    flex: 1;
  }

  .json-entry-fields .form-group {
    flex: 1;
    margin-bottom: 0;
  }

  .json-entry-fields label {
    font-size: 12px;
    font-weight: 600;
    color: #6c757d;
    margin-bottom: 5px;
  }

  .json-entry-date,
  .json-entry-value {
    width: 100%;
  }

  .json-entry-actions {
    display: flex;
    align-items: center;
    padding-top: 24px;
  }

  .form-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #dee2e6;
  }

  /* Optimisations List */
  .optimisations-header {
    display: flex;
    justify-content: flex-end;
    margin-bottom: 15px;
  }

  .optimisation-note {
    font-size: 14px;
    color: #6c757d;
    font-style: italic;
  }

  .optimisations-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .optimisation-item {
    background-color: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
    transition: box-shadow 0.2s;
  }

  .optimisation-item:hover {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .optimisation-item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .optimisation-item-title {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .optimisation-name {
    font-size: 16px;
    font-weight: 600;
    color: #212529;
  }

  .optimisation-status {
    font-size: 12px;
    font-weight: 500;
    padding: 4px 10px;
    border-radius: 12px;
    text-transform: uppercase;
  }

  .optimisation-status.enabled {
    background-color: #d4edda;
    color: #155724;
  }

  .optimisation-status.disabled {
    background-color: #f8d7da;
    color: #721c24;
  }

  .optimisation-item-actions {
    display: flex;
    gap: 8px;
  }

  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #6c757d;
    font-style: italic;
  }

  .option-section {
    margin-bottom: 20px;
  }

  .option-section h4 {
    margin: 0 0 15px 0;
    font-size: 1.2em;
    color: #333;
  }

  .options-list {
    display: flex;
    flex-direction: column;
    gap: 5px;
  }

  .option-group {
    margin-bottom: 20px;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    overflow: hidden;
  }

  .option-group-header {
    background-color: #f8f9fa;
    padding: 10px 15px;
    font-weight: bold;
    font-size: 14px;
    color: #333;
    border-bottom: 1px solid #dee2e6;
  }

  .option-group-content {
    background-color: white;
  }

  .option-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 15px;
    border-bottom: 1px solid #f0f0f0;
    transition: background-color 0.2s;
  }

  .option-item:last-child {
    border-bottom: none;
  }

  .option-item:hover {
    background-color: #f8f9fa;
  }

  .option-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 3px;
  }

  .option-label {
    font-weight: 500;
    font-size: 14px;
    color: #333;
  }

  .option-description {
    font-size: 12px;
    color: #6c757d;
    font-style: italic;
  }

  .option-control {
    display: flex;
    align-items: center;
    min-width: 200px;
    justify-content: flex-end;
  }

  .option-input,
  .option-select {
    width: 100%;
    max-width: 200px;
    padding: 6px 10px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 14px;
    background-color: white;
  }

  .option-input:focus,
  .option-select:focus {
    outline: none;
    border-color: #80bdff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
  }

  .option-select.secret-ref {
    font-family: monospace;
    color: #6f42c1;
  }

  .checkbox-container {
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
  }

  .option-checkbox {
    width: 20px;
    height: 20px;
    cursor: pointer;
  }

  .checkbox-label {
    font-size: 14px;
    color: #495057;
    user-select: none;
  }

  /* Secrets UI Styles */
  .secrets-ui {
    width: 100%;
  }

  .secrets-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid #ddd;
  }

  .secrets-header h3 {
    margin: 0;
    font-size: 1.5em;
  }

  .btn-add {
    background-color: #28a745;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
  }

  .btn-add:hover {
    background-color: #218838;
  }

  .secrets-list {
    display: flex;
    flex-direction: column;
    gap: 5px;
  }

  .secret-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    transition: background-color 0.2s;
  }

  .secret-item:hover {
    background-color: #e9ecef;
  }

  .secret-info {
    flex: 1;
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .secret-key {
    font-weight: bold;
    font-size: 14px;
    color: #333;
    min-width: 150px;
  }

  .secret-value-masked {
    font-family: monospace;
    color: #999;
    font-size: 12px;
  }

  .secret-actions {
    display: flex;
    gap: 5px;
  }

  .btn-icon {
    background: none;
    border: none;
    cursor: pointer;
    padding: 4px;
    border-radius: 3px;
    transition: background-color 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .btn-icon:hover {
    background-color: rgba(0, 0, 0, 0.1);
  }

  .btn-edit .material-icons {
    color: #007bff;
    font-size: 18px;
  }

  .btn-delete .material-icons {
    color: #dc3545;
    font-size: 18px;
  }

  .empty-state {
    text-align: center;
    padding: 40px;
    color: #6c757d;
    font-style: italic;
  }

  /* Modal Styles */
  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    align-items: center;
    justify-content: center;
  }

  /* Higher z-index for nested modals */
  .modal.modal-nested {
    z-index: 1100;
  }

  .modal-content {
    background-color: white;
    border-radius: 8px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid #dee2e6;
  }

  .modal-header h3 {
    margin: 0;
    font-size: 1.3em;
  }

  .close {
    font-size: 28px;
    font-weight: bold;
    color: #aaa;
    cursor: pointer;
    line-height: 1;
  }

  .close:hover {
    color: #000;
  }

  .modal-body {
    padding: 20px;
  }

  .form-group {
    margin-bottom: 20px;
  }

  .form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
    color: #333;
  }

  .form-input {
    width: 100%;
    padding: 10px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 14px;
    box-sizing: border-box;
  }

  .form-input:focus {
    outline: none;
    border-color: #80bdff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
  }

  .form-input:disabled {
    background-color: #e9ecef;
    cursor: not-allowed;
  }

  .toggle-visibility {
    margin-top: 8px;
    display: flex;
    align-items: center;
    gap: 5px;
  }

  .toggle-visibility input[type="checkbox"] {
    cursor: pointer;
  }

  .toggle-visibility label {
    margin: 0;
    font-weight: normal;
    cursor: pointer;
  }

  .modal-footer {
    padding: 15px 20px;
    border-top: 1px solid #dee2e6;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
  }

  .btn-primary {
    background-color: #007bff;
    color: white;
    padding: 8px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
  }

  .btn-primary:hover {
    background-color: #0056b3;
  }

  .btn-secondary {
    background-color: #6c757d;
    color: white;
    padding: 8px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
  }

  .btn-secondary:hover {
    background-color: #5a6268;
  }

  /* Baseload Grid Styles */
  .dynamic-baseload-fields {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .baseload-grid-wrapper {
    margin-top: 10px;
  }

  .baseload-grid-caption {
    font-size: 0.9em;
    font-weight: 600;
    color: #495057;
    margin-bottom: 8px;
    padding-left: 2px;
  }

  .baseload-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 10px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #dee2e6;
  }

  .baseload-hour-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .baseload-hour-label {
    font-size: 0.85em;
    font-weight: 500;
    color: #495057;
  }

  .baseload-hour-input {
    padding: 6px 8px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 0.9em;
    font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
  }

  .baseload-hour-input:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
  }

  .baseload-hour-input:hover {
    border-color: #adb5bd;
  }

  /* Heating Stages Styles */
  .heating-stages-container {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 15px;
  }

  .heating-stage-item {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
  }

  .stage-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }

  .stage-number {
    font-size: 14px;
    font-weight: 600;
    color: #495057;
  }

  .btn-delete-stage {
    background: none;
    border: none;
    cursor: pointer;
    padding: 4px;
    color: #dc3545;
    display: flex;
    align-items: center;
    transition: color 0.2s;
  }

  .btn-delete-stage:hover {
    color: #c82333;
  }

  /* Put header and fields on one row */
.stage-row {
  display: flex;
  align-items: center;
  gap: 20px;
  flex-wrap: nowrap;
  margin-bottom: 10px;
}

/* Stage number + delete button */
.stage-header {
  display: flex;
  align-items: center;
  gap: 8px;
  min-width: 20px; /* optional — ensures consistent spacing */
}

/* Fields container — now inline instead of grid */
.stage-fields {
  display: flex;
  align-items: center;
  gap: 15px;
  flex: 1; /* take remaining space */
}

/* Each field remains vertical (label + input) */
.stage-field {
  display: flex;
  flex-direction: column;
  gap: 5px;
}

/* Label styling */
.stage-field label {
  font-size: 13px;
  font-weight: 500;
  color: #495057;
}

/* Input styling */
.stage-input {
  padding: 8px 10px;
  border: 1px solid #ced4da;
  border-radius: 4px;
  font-size: 14px;
  font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
  transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.stage-input:focus {
  outline: none;
  border-color: #007bff;
  box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
}

.stage-input:hover {
  border-color: #adb5bd;
}


  /* Solar Modal Styles */
  .modal-large {
    max-width: 800px;
    width: 90%;
  }

  .form-section-header {
    margin-top: 20px;
    margin-bottom: 15px;
  }

  .form-section-header h4 {
    margin: 0 0 5px 0;
    font-size: 16px;
    color: #495057;
  }

  .form-help {
    margin: 0;
    font-size: 13px;
    color: #6c757d;
    font-style: italic;
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
  }

  .strings-container {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 15px;
  }

  .empty-state-small {
    text-align: center;
    padding: 20px;
    color: #6c757d;
    font-style: italic;
    font-size: 14px;
  }

  .strings-container-scrollable {
    max-height: 400px;
    overflow-x: auto;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 12px;
    margin-bottom: 15px;
    background-color: white;
  }

  .strings-container-scrollable .empty-state-small {
    margin: 0;
  }

  .string-item {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 12px;
  }

  .string-item:last-child {
    margin-bottom: 0;
  }

  .string-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }

  .string-number {
    font-size: 14px;
    font-weight: 600;
    color: #495057;
  }

  .btn-delete-string {
    background: none;
    border: none;
    cursor: pointer;
    padding: 4px;
    color: #dc3545;
    display: flex;
    align-items: center;
    transition: color 0.2s;
  }

  .btn-delete-string:hover {
    color: #c82333;
  }

  .string-fields {
    display: grid;
    grid-template-columns: repeat(4, minmax(120px, 1fr));
    gap: 10px;
    min-width: 550px;
  }

  .string-field {
    display: flex;
    flex-direction: column;
    gap: 5px;
  }

  .string-field label {
    font-size: 12px;
    font-weight: 500;
    color: #495057;
  }

  .string-input {
    padding: 6px 8px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 13px;
    font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
  }

  .string-input:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
  }

  .string-input:hover {
    border-color: #adb5bd;
  }

  /* Validation Error Styles */
  .field-error {
    border-color: #dc3545 !important;
    background-color: #fff5f5;
  }

  .field-error:focus {
    border-color: #dc3545 !important;
    box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1) !important;
  }


  .error-message {
    color: #dc3545;
    font-size: 12px;
    margin-top: 4px;
    font-weight: 500;
  }

  /* Battery Stages Styles */
  .stages-container {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 15px;
  }

  .stage-item {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
  }

  .stage-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }

  .stage-number {
    font-size: 14px;
    font-weight: 600;
    color: #495057;
  }

  .btn-delete-stage {
    background: none;
    border: none;
    cursor: pointer;
    padding: 4px;
    color: #dc3545;
    display: flex;
    align-items: center;
    transition: color 0.2s;
  }

  .btn-delete-stage:hover {
    color: #c82333;
  }

  .stage-fields {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
  }

  .stage-field {
    display: flex;
    flex-direction: column;
    gap: 5px;
  }

  .stage-field label {
    font-size: 12px;
    font-weight: 500;
    color: #495057;
  }

  .stage-input {
    padding: 6px 8px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 13px;
    font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
  }

  .stage-input:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
  }

  .stage-input:hover {
    border-color: #adb5bd;
  }

  /* Reduced Hours Styles */
  .reduced-hours-container {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 15px;
  }

  .reduced-hour-item {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
  }

  .reduced-hour-fields {
    display: grid;
    grid-template-columns: 1fr 1fr auto;
    gap: 10px;
    align-items: end;
  }

  .reduced-hour-field {
    display: flex;
    flex-direction: column;
    gap: 5px;
  }

  .reduced-hour-field label {
    font-size: 12px;
    font-weight: 500;
    color: #495057;
  }

  .hour-input,
  .power-input {
    padding: 6px 8px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 13px;
    font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
  }

  .hour-input:focus,
  .power-input:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
  }

  .hour-input:hover,
  .power-input:hover {
    border-color: #adb5bd;
  }

  .btn-delete-hour {
    background: none;
    border: none;
    cursor: pointer;
    padding: 4px;
    color: #dc3545;
    display: flex;
    align-items: center;
    transition: color 0.2s;
    height: fit-content;
  }

  .btn-delete-hour:hover {
    color: #c82333;
  }

  /* Compact stage item styles */
  .stages-container-scrollable {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 10px;
    margin-bottom: 10px;
    background-color: #f8f9fa;
  }

  .stage-item-compact {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 10px;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    margin-bottom: 6px;
    font-size: 13px;
  }

  .stage-item-compact:last-child {
    margin-bottom: 0;
  }

  .stage-label {
    font-weight: 600;
    min-width: 60px;
    color: #495057;
  }

  .stage-inline-label {
    font-weight: 500;
    color: #6c757d;
    white-space: nowrap;
    margin: 0;
  }

  .stage-inline-input {
    width: 100px;
    padding: 4px 8px;
    border: 1px solid #ced4da;
    border-radius: 3px;
    font-size: 13px;
    font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
  }

  .stage-inline-input:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.1);
  }

  .btn-icon-small {
    background: none;
    border: none;
    cursor: pointer;
    padding: 2px 8px;
    color: #dc3545;
    font-size: 20px;
    font-weight: bold;
    line-height: 1;
    margin-left: auto;
    transition: color 0.2s;
  }

  .btn-icon-small:hover {
    color: #c82333;
  }
</style>

{% endblock %}

