{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Day Ahead Optimizer Configuration",
  "description": "Configuration schema for the Day Ahead Optimizer (DAO) Home Assistant add-on",
  "type": "object",
  "properties": {
    "homeassistant": {
      "type": "object",
      "description": "Home Assistant connection settings (can be empty for add-on installation)",
      "properties": {
        "protocol api": {
          "type": "string",
          "enum": ["http", "https"],
          "default": "http",
          "description": "Protocol to use for Home Assistant API"
        },
        "host": {
          "type": "string",
          "default": "supervisor",
          "description": "Hostname or IP address of Home Assistant"
        },
        "ip port": {
          "type": "integer",
          "description": "Port number for Home Assistant API"
        },
        "token": {
          "type": "string",
          "description": "Long-lived access token for Home Assistant",
          "format": "password",
          "haSecret": true,
          "haSecretAllowValue": true
        }
      }
    },
    "database ha": {
      "type": "object",
      "description": "Home Assistant database connection settings",
      "properties": {
        "engine": {
          "type": "string",
          "enum": ["mysql", "sqlite", "postgresql"],
          "default": "mysql",
          "description": "Database engine type"
        },
        "server": {
          "type": "string",
          "default": "core-mariadb",
          "description": "Database server hostname (not used for sqlite)"
        },
        "port": {
          "type": "integer",
          "default": 3306,
          "description": "Database server port (not used for sqlite)"
        },
        "database": {
          "type": "string",
          "default": "homeassistant",
          "description": "Database name or filename"
        },
        "username": {
          "type": "string",
          "default": "homeassistant",
          "description": "Database username (not used for sqlite)"
        },
        "password": {
          "type": "string",
          "description": "Database password (not used for sqlite)",
          "format": "password",
          "haSecret": true,
          "haSecretAllowValue": true
        },
        "db_path": {
          "type": "string",
          "description": "Path to database file (only for sqlite)"
        }
      },
      "required": ["engine"]
    },
    "database da": {
      "type": "object",
      "description": "Day Ahead Optimizer database connection settings",
      "properties": {
        "engine": {
          "type": "string",
          "enum": ["mysql", "sqlite", "postgresql"],
          "default": "mysql",
          "description": "Database engine type"
        },
        "server": {
          "type": "string",
          "default": "core-mariadb",
          "description": "Database server hostname (not used for sqlite)"
        },
        "port": {
          "type": "integer",
          "default": 3306,
          "description": "Database server port (not used for sqlite)"
        },
        "database": {
          "type": "string",
          "default": "day_ahead",
          "description": "Database name or filename"
        },
        "username": {
          "type": "string",
          "default": "day_ahead",
          "description": "Database username (not used for sqlite)"
        },
        "password": {
          "type": "string",
          "description": "Database password (not used for sqlite)",
          "format": "password",
          "haSecret": true,
          "haSecretAllowValue": true
        },
        "db_path": {
          "type": "string",
          "default": "../data",
          "description": "Path to database file (only for sqlite)"
        }
      },
      "required": ["engine"]
    },
    "meteoserver-key": {
      "type": "string",
      "description": "API key for Meteoserver weather data",
      "format": "password",
      "haSecret": true,
      "haSecretAllowValue": true
    },
    "meteoserver-model": {
      "type": "string",
      "enum": ["harmonie", "gfs"],
      "default": "harmonie",
      "description": "Weather data model: harmonie (40h, 1x1km) or gfs (96h, 10x10km)"
    },
    "meteoserver-attempts": {
      "type": "integer",
      "default": 2,
      "minimum": 1,
      "description": "Maximum number of attempts to fetch weather data"
    },
    "prices": {
      "type": "object",
      "description": "Energy pricing configuration",
      "properties": {
        "source day ahead": {
          "type": "string",
          "enum": ["nordpool", "entsoe", "easyenergy", "tibber"],
          "default": "nordpool",
          "description": "Source for day-ahead electricity prices"
        },
        "entsoe-api-key": {
          "type": "string",
          "description": "API key for ENTSO-E (required if source is entsoe)",
          "format": "password",
          "haSecret": true,
          "haSecretAllowValue": true
        },
        "regular high": {
          "type": "number",
          "description": "Regular high tariff (EUR/kWh, excl. VAT)"
        },
        "regular low": {
          "type": "number",
          "description": "Regular low tariff (EUR/kWh, excl. VAT)"
        },
        "switch to low": {
          "type": "integer",
          "default": 23,
          "minimum": 0,
          "maximum": 23,
          "description": "Hour when switching to low tariff"
        },
        "energy taxes consumption": {
          "type": "object",
          "description": "Energy tax on consumption by date (YYYY-MM-DD: EUR/kWh excl. VAT)",
          "patternProperties": {
            "^\\d{4}-\\d{2}-\\d{2}$": {
              "type": "number"
            }
          }
        },
        "energy taxes production": {
          "type": "object",
          "description": "Energy tax on production/feed-in by date (YYYY-MM-DD: EUR/kWh excl. VAT)",
          "patternProperties": {
            "^\\d{4}-\\d{2}-\\d{2}$": {
              "type": "number"
            }
          }
        },
        "cost supplier consumption": {
          "type": "object",
          "description": "Supplier markup for consumption by date (YYYY-MM-DD: EUR/kWh excl. VAT)",
          "patternProperties": {
            "^\\d{4}-\\d{2}-\\d{2}$": {
              "type": "number"
            }
          }
        },
        "cost supplier production": {
          "type": "object",
          "description": "Supplier compensation for production by date (YYYY-MM-DD: EUR/kWh excl. VAT)",
          "patternProperties": {
            "^\\d{4}-\\d{2}-\\d{2}$": {
              "type": "number"
            }
          }
        },
        "vat consumption": {
          "type": "object",
          "description": "VAT percentage for consumption by date (YYYY-MM-DD: percentage)",
          "patternProperties": {
            "^\\d{4}-\\d{2}-\\d{2}$": {
              "type": "number"
            }
          }
        },
        "vat production": {
          "type": "object",
          "description": "VAT percentage for production by date (YYYY-MM-DD: percentage)",
          "patternProperties": {
            "^\\d{4}-\\d{2}-\\d{2}$": {
              "type": "number"
            }
          }
        },
        "last invoice": {
          "type": "string",
          "pattern": "^\\d{4}-\\d{2}-\\d{2}$",
          "description": "Date of last invoice or contract start date (YYYY-MM-DD)"
        },
        "tax refund": {
          "type": "string",
          "enum": ["True", "False"],
          "description": "Whether tax refund applies"
        }
      },
      "required": ["source day ahead"]
    },
    "logging level": {
      "type": "string",
      "enum": ["debug", "info", "warning", "error"],
      "default": "info",
      "description": "Logging verbosity level"
    },
    "use_calc_baseload": {
      "type": "string",
      "enum": ["True", "False"],
      "default": "False",
      "description": "Whether to calculate baseload automatically"
    },
    "baseload calc periode": {
      "type": "integer",
      "default": 56,
      "minimum": 1,
      "description": "Number of days to calculate baseload over (if use_calc_baseload is True)"
    },
    "baseload": {
      "type": "array",
      "description": "Hourly baseload consumption in kWh (24 values, one per hour)",
      "items": {
        "type": "number",
        "minimum": 0
      },
      "minItems": 24,
      "maxItems": 24
    },
    "graphical backend": {
      "type": "string",
      "enum": ["", "MacOSX", "QtAgg", "GTK4Agg", "Gtk3Agg", "TkAgg", "WxAgg", "Agg"],
      "default": "",
      "description": "Matplotlib backend for graphics rendering"
    },
    "graphics": {
      "type": "object",
      "description": "Graphics display settings",
      "properties": {
        "style": {
          "type": "string",
          "enum": ["default", "dark_background", "bmh", "fivethirtyeight", "ggplot", "grayscale", "Solarize_Light2"],
          "default": "default",
          "description": "Matplotlib style for graphs"
        },
        "show": {
          "type": "string",
          "enum": ["true", "false"],
          "default": "false",
          "description": "Whether to show graph after calculation"
        },
        "battery balance": {
          "type": "string",
          "enum": ["True", "False"],
          "default": "True",
          "description": "Show battery balance graph"
        },
        "prices consumption": {
          "type": "string",
          "enum": ["True", "False"],
          "default": "True",
          "description": "Show consumption prices in graph"
        },
        "prices production": {
          "type": "string",
          "enum": ["True", "False"],
          "default": "False",
          "description": "Show production prices in graph"
        },
        "prices spot": {
          "type": "string",
          "enum": ["True", "False"],
          "default": "True",
          "description": "Show spot prices in graph"
        },
        "average consumption": {
          "type": "string",
          "enum": ["True", "False"],
          "default": "True",
          "description": "Show average consumption price in graph"
        }
      }
    },
    "interval": {
      "type": "string",
      "enum": ["1hour", "15min"],
      "default": "1hour",
      "description": "Calculation interval"
    },
    "strategy": {
      "oneOf": [
        {
          "type": "string",
          "enum": ["minimize cost", "minimize consumption"]
        },
        {
          "type": "string",
          "pattern": "^(input_select|input_text|sensor)\\."
        }
      ],
      "default": "minimize cost",
      "haEntityDomains": "input_select",
      "haEntityAllowValue": true,
      "description": "Optimization strategy: minimize cost or minimize consumption. Can be a fixed value or HA entity name"
    },
    "max_gap": {
      "type": ["number", "string"],
      "default": 0.005,
      "description": "Maximum gap between iterations for optimization convergence. Can be a numeric value or HA entity name for dynamic setting",
      "haEntityDomains": "input_number,sensor,number",
      "haEntityAllowValue": true,
      "minimum": 0.00001,
      "maximum": 1.0
    },
    "notifications": {
      "type": "object",
      "description": "Notification settings",
      "properties": {
        "notification_entity": {
          "type": "string",
          "default": "",
          "description": "HA entity (input_text) for notifications",
          "haEntityDomains": "input_text"
        },
        "opstarten": {
          "type": "string",
          "enum": ["True", "False"],
          "default": "False",
          "description": "Send notification on startup"
        },
        "berekening": {
          "type": "string",
          "enum": ["True", "False"],
          "default": "False",
          "description": "Send notification on calculation"
        },
        "last activity entity": {
          "type": "string",
          "default": "",
          "description": "HA entity (input_datetime) for last activity timestamp"
        }
      }
    },
    "grid": {
      "type": "object",
      "description": "Grid connection settings",
      "properties": {
        "max_power": {
          "type": "number",
          "default": 17,
          "description": "Maximum grid power in kW (e.g., 3x25A = 17kW)"
        }
      }
    },
    "history": {
      "type": "object",
      "description": "History retention settings",
      "properties": {
        "save days": {
          "type": "integer",
          "default": 7,
          "minimum": 1,
          "description": "Number of days to keep history data"
        }
      }
    },
    "dashboard": {
      "type": "object",
      "description": "Dashboard web UI settings",
      "properties": {
        "port": {
          "type": "integer",
          "default": 5000,
          "minimum": 1,
          "maximum": 65535,
          "description": "Port number for dashboard web interface"
        }
      }
    },
    "boiler": {
      "type": "object",
      "description": "Hot water boiler settings",
      "properties": {
        "boiler present": {
          "type": "string",
          "enum": ["True", "False"],
          "default": "False",
          "description": "Whether a boiler is present"
        },
        "entity boiler enabled": {
          "type": "string",
          "description": "HA entity indicating if boiler is enabled"
        },
        "entity actual temp.": {
          "type": "string",
          "description": "HA entity with actual boiler temperature (°C)"
        },
        "entity setpoint": {
          "type": ["number", "string"],
          "default": 55,
          "minimum": 0,
          "maximum": 100,
          "description": "Boiler setpoint temperature in °C. Can be a numeric value or HA entity name for dynamic setting",
          "haEntityDomains": "input_number,sensor,number",
          "haEntityAllowValue": true
        },
        "entity hysterese": {
          "type": ["number", "string"],
          "default": 5,
          "minimum": 0,
          "maximum": 50,
          "description": "Boiler hysteresis in K (Kelvin). Can be a numeric value or HA entity name for dynamic setting",
          "haEntityDomains": "input_number,sensor,number",
          "haEntityAllowValue": true
        },
        "cop": {
          "type": "number",
          "minimum": 1,
          "description": "Coefficient of Performance (kWh heat / kWh electricity)"
        },
        "cooling rate": {
          "type": "number",
          "minimum": 0,
          "description": "Average cooling rate (K/hour)"
        },
        "volume": {
          "type": "number",
          "minimum": 0,
          "description": "Boiler volume in liters"
        },
        "heating allowed below": {
          "type": "number",
          "description": "Temperature limit below which heating is allowed (°C)"
        },
        "elec. power": {
          "type": "number",
          "minimum": 0,
          "description": "Electric power consumption in Watts"
        },
        "boiler heated by heatpump": {
          "type": "string",
          "enum": ["True", "False"],
          "default": "True",
          "description": "Whether boiler is heated by heat pump"
        },
        "activate service": {
          "type": "string",
          "enum": ["press", "turn_on"],
          "description": "Service to activate boiler heating"
        },
        "activate entity": {
          "type": "string",
          "description": "HA entity to activate boiler heating"
        },
        "switch entity": {
          "type": "string",
          "description": "HA input_boolean entity to control boiler"
        },
        "entity instant start": {
          "type": "string",
          "description": "HA input_boolean entity for instant start"
        }
      }
    },
    "heating": {
      "type": "object",
      "description": "Heat pump settings",
      "properties": {
        "heater present": {
          "type": "string",
          "enum": ["True", "False"],
          "default": "False",
          "description": "Whether a heat pump is present"
        },
        "entity hp enabled": {
          "type": "string",
          "description": "HA binary_sensor indicating if heat pump is enabled"
        },
        "entity hp heat demand": {
          "type": "string",
          "description": "HA binary_sensor indicating heat demand"
        },
        "degree days factor": {
          "type": ["number", "string"],
          "default": 0,
          "minimum": 0,
          "description": "Degree days factor (kWh/K.day). Can be a numeric value or HA entity name for dynamic setting",
          "haEntityDomains": "input_number,sensor,number",
          "haEntityAllowValue": true
        },
        "adjustment": {
          "type": "string",
          "enum": ["on/off", "power", "heating curve"],
          "default": "power",
          "description": "Heat pump control type"
        },
        "entity hp heat produced": {
          "type": "string",
          "description": "HA sensor with thermal energy produced today (kWh)"
        },
        "entity hp switch": {
          "type": "string",
          "description": "HA input_boolean to control heat pump on/off"
        },
        "entity avg outside temp": {
          "type": "string",
          "description": "HA input_number with average outside temperature (°C)"
        },
        "entity hp cop": {
          "type": "string",
          "description": "HA sensor with heat pump COP"
        },
        "entity hp power": {
          "type": "string",
          "description": "HA sensor or input_number with heat pump power (kW)"
        },
        "min run length": {
          "type": "integer",
          "minimum": 1,
          "maximum": 5,
          "default": 1,
          "description": "Minimum consecutive hours heat pump must run (on/off only)"
        },
        "stages": {
          "type": "array",
          "description": "Power stages with corresponding COP values",
          "items": {
            "type": "object",
            "properties": {
              "max_power": {
                "type": "number",
                "minimum": 0,
                "description": "Maximum electric power for this stage (W)"
              },
              "cop": {
                "type": "number",
                "minimum": 1,
                "description": "Coefficient of Performance for this stage"
              }
            },
            "required": ["max_power", "cop"]
          }
        },
        "entity adjust heating curve": {
          "type": "string",
          "description": "HA input_number for heating curve adjustment"
        },
        "adjustment factor": {
          "type": "number",
          "description": "Heating curve adjustment factor (K per 10% price deviation)"
        }
      }
    },
    "battery": {
      "type": "array",
      "description": "List of battery systems (0 or more)",
      "items": {
        "type": "object",
        "properties": {
          "name": {
            "type": "string",
            "description": "Battery name"
          },
          "entity actual level": {
            "type": "string",
            "description": "HA entity with actual State of Charge (%)"
          },
          "capacity": {
            "type": "number",
            "minimum": 0,
            "description": "Battery capacity in kWh"
          },
          "upper limit": {
            "type": "number",
            "minimum": 0,
            "maximum": 100,
            "description": "Upper SoC limit (%)"
          },
          "lower limit": {
            "type": "number",
            "minimum": 0,
            "maximum": 100,
            "description": "Lower SoC limit (temporary) (%)"
          },
          "optimal lower level": {
            "type": "number",
            "minimum": 0,
            "maximum": 100,
            "description": "Optimal lower SoC limit (long-term) (%)"
          },
          "entity min soc end opt": {
            "type": "string",
            "default": "0",
            "description": "HA input_number for minimum SoC at end of optimization (%)"
          },
          "entity max soc end opt": {
            "type": "string",
            "default": "100",
            "description": "HA input_number for maximum SoC at end of optimization (%)"
          },
          "charge stages": {
            "type": "array",
            "description": "Charging power stages with efficiencies",
            "items": {
              "type": "object",
              "properties": {
                "power": {
                  "type": "number",
                  "minimum": 0,
                  "description": "Maximum power for this stage (W)"
                },
                "efficiency": {
                  "type": "number",
                  "minimum": 0,
                  "maximum": 1,
                  "description": "Inverter efficiency (AC to DC)"
                }
              },
              "required": ["power", "efficiency"]
            },
            "minItems": 1
          },
          "discharge stages": {
            "type": "array",
            "description": "Discharging power stages with efficiencies",
            "items": {
              "type": "object",
              "properties": {
                "power": {
                  "type": "number",
                  "minimum": 0,
                  "description": "Maximum power for this stage (W)"
                },
                "efficiency": {
                  "type": "number",
                  "minimum": 0,
                  "maximum": 1,
                  "description": "Inverter efficiency (DC to AC)"
                }
              },
              "required": ["power", "efficiency"]
            },
            "minItems": 1
          },
          "reduced hours": {
            "type": "object",
            "description": "Hours with reduced power limits (hour: power in W)",
            "patternProperties": {
              "^([0-9]|1[0-9]|2[0-3])$": {
                "type": "number",
                "minimum": 0
              }
            }
          },
          "minimum power": {
            "type": "number",
            "minimum": 0,
            "description": "Minimum charge/discharge power (W)"
          },
          "dc_to_bat efficiency": {
            "type": "number",
            "minimum": 0,
            "maximum": 1,
            "description": "Efficiency DC to battery (charge)"
          },
          "dc_to_bat max power": {
            "type": "number",
            "minimum": 0,
            "description": "Maximum DC power to battery (W)"
          },
          "bat_to_dc efficiency": {
            "type": "number",
            "minimum": 0,
            "maximum": 1,
            "description": "Efficiency battery to DC (discharge)"
          },
          "bat_to_dc max power": {
            "type": "number",
            "minimum": 0,
            "description": "Maximum DC power from battery (W)"
          },
          "cycle cost": {
            "type": "number",
            "minimum": 0,
            "description": "Depreciation cost per kWh cycled (EUR/kWh for half-cycle)"
          },
          "entity set power feedin": {
            "type": "string",
            "description": "HA input_number entity for charge/discharge power setpoint"
          },
          "entity set operating mode": {
            "type": "string",
            "description": "HA input_select entity for operating mode"
          },
          "entity set operating mode on": {
            "type": "string",
            "default": "Aan",
            "description": "Value to turn battery on"
          },
          "entity set operating mode off": {
            "type": "string",
            "default": "Uit",
            "description": "Value to turn battery off"
          },
          "entity stop inverter": {
            "type": "string",
            "description": "HA input_datetime entity for stop time"
          },
          "entity balance switch": {
            "type": "string",
            "description": "HA input_boolean entity for grid balancing mode"
          },
          "entity from battery": {
            "type": "string",
            "description": "HA input_number for calculated DC power from battery (W)"
          },
          "entity from pv": {
            "type": "string",
            "description": "HA input_number for calculated DC power from PV (W)"
          },
          "entity from ac": {
            "type": "string",
            "description": "HA input_number for calculated AC power (W)"
          },
          "entity calculated soc": {
            "type": "string",
            "description": "HA input_number for calculated SoC at end of hour (%)"
          },
          "solar": {
            "type": "array",
            "description": "PV installations feeding DC to battery (MPPT)",
            "items": {
              "$ref": "#/$defs/solarInstallation"
            }
          }
        },
        "required": ["name", "capacity"]
      }
    },
    "solar": {
      "type": "array",
      "description": "PV installations feeding AC to grid (0 or more)",
      "items": {
        "$ref": "#/$defs/solarInstallation"
      }
    },
    "electric vehicle": {
      "type": "array",
      "description": "Electric vehicles (0 or more)",
      "items": {
        "type": "object",
        "properties": {
          "name": {
            "type": "string",
            "description": "Vehicle name"
          },
          "capacity": {
            "type": "number",
            "minimum": 0,
            "description": "Battery capacity in kWh"
          },
          "entity position": {
            "type": "string",
            "description": "HA device_tracker entity for vehicle location"
          },
          "entity max amperage": {
            "type": "string",
            "description": "HA sensor with maximum charging amperage"
          },
          "charge three phase": {
            "type": "string",
            "enum": ["True", "False"],
            "default": "True",
            "description": "Whether vehicle charges on three phases"
          },
          "charge stages": {
            "type": "array",
            "description": "Charging stages with amperage and efficiency",
            "items": {
              "type": "object",
              "properties": {
                "ampere": {
                  "type": "number",
                  "minimum": 0,
                  "description": "Charging current per phase (A)"
                },
                "efficiency": {
                  "type": "number",
                  "minimum": 0,
                  "maximum": 1,
                  "default": 1,
                  "description": "Charging efficiency"
                }
              },
              "required": ["ampere"]
            },
            "minItems": 2
          },
          "entity actual level": {
            "type": "string",
            "description": "HA sensor with battery level (%)"
          },
          "entity plugged in": {
            "type": "string",
            "description": "HA binary_sensor indicating if vehicle is plugged in"
          },
          "charge scheduler": {
            "type": "object",
            "description": "Charging scheduler settings",
            "properties": {
              "entity set level": {
                "type": "string",
                "description": "HA input_number for desired charge level (%)"
              },
              "level margin": {
                "type": "number",
                "minimum": 0,
                "default": 0,
                "description": "Margin below desired level before charging starts (%)"
              },
              "entity ready datetime": {
                "type": "string",
                "description": "HA input_datetime for when vehicle should be ready"
              }
            }
          },
          "charge switch": {
            "type": "string",
            "description": "HA switch to enable/disable charging"
          },
          "entity set charging ampere": {
            "type": "string",
            "description": "HA input_number to set charging amperage"
          },
          "entity stop charging": {
            "type": "string",
            "description": "HA input_datetime for charging stop time"
          },
          "entity instant start": {
            "type": "string",
            "description": "HA input_boolean for instant charging start"
          },
          "entity instant level": {
            "type": "string",
            "description": "HA input_number for instant charging target level"
          }
        },
        "required": ["name", "capacity"]
      }
    },
    "machines": {
      "type": "array",
      "description": "Household appliances (washing machine, dishwasher, etc.)",
      "items": {
        "type": "object",
        "properties": {
          "name": {
            "type": "string",
            "description": "Machine name"
          },
          "programs": {
            "type": "array",
            "description": "Available programs",
            "items": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string",
                  "description": "Program name"
                },
                "power": {
                  "type": "array",
                  "description": "Power consumption per time interval (W)",
                  "items": {
                    "type": "number",
                    "minimum": 0
                  }
                }
              },
              "required": ["name", "power"]
            },
            "minItems": 1
          },
          "entity start window": {
            "type": "string",
            "description": "HA input_datetime for earliest start time"
          },
          "entity end window": {
            "type": "string",
            "description": "HA input_datetime for latest end time"
          },
          "entity selected program": {
            "type": "string",
            "description": "HA input_select for program selection"
          },
          "entity calculated start": {
            "type": "string",
            "description": "HA input_datetime where calculated start time is stored"
          },
          "entity calculated end": {
            "type": "string",
            "description": "HA input_datetime where calculated end time is stored"
          },
          "entity instant start": {
            "type": "string",
            "description": "HA input_boolean for instant start"
          }
        },
        "required": ["name", "programs"]
      }
    },
    "tibber": {
      "type": "object",
      "description": "Tibber API settings (for price source)",
      "properties": {
        "api url": {
          "type": "string",
          "format": "uri",
          "default": "https://api.tibber.com/v1-beta/gql",
          "description": "Tibber API endpoint URL"
        },
        "api_token": {
          "type": "string",
          "description": "Tibber API token",
          "format": "password",
          "haSecret": true,
          "haSecretAllowValue": true
        }
      }
    },
    "report": {
      "type": "object",
      "description": "Reporting configuration with HA entities for energy data",
      "properties": {
        "entities grid consumption": {
          "type": "array",
          "description": "HA sensors for grid consumption (cumulative kWh)",
          "items": {
            "type": "string"
          },
          "default": []
        },
        "entities grid production": {
          "type": "array",
          "description": "HA sensors for grid production/feed-in (cumulative kWh)",
          "items": {
            "type": "string"
          },
          "default": []
        },
        "entities solar production ac": {
          "type": "array",
          "description": "HA sensors for solar production AC (cumulative kWh)",
          "items": {
            "type": "string"
          },
          "default": []
        },
        "entities solar production dc": {
          "type": "array",
          "description": "HA sensors for solar production DC (cumulative kWh)",
          "items": {
            "type": "string"
          },
          "default": []
        },
        "entities ev consumption": {
          "type": "array",
          "description": "HA sensors for EV charging consumption (cumulative kWh)",
          "items": {
            "type": "string"
          },
          "default": []
        },
        "entities wp consumption": {
          "type": "array",
          "description": "HA sensors for heat pump consumption (cumulative kWh)",
          "items": {
            "type": "string"
          },
          "default": []
        },
        "entities boiler consumption": {
          "type": "array",
          "description": "HA sensors for boiler consumption (cumulative kWh)",
          "items": {
            "type": "string"
          },
          "default": []
        },
        "entities machine consumption": {
          "type": "array",
          "description": "HA sensors for machine consumption (cumulative kWh)",
          "items": {
            "type": "string"
          },
          "default": []
        },
        "entities battery consumption": {
          "type": "array",
          "description": "HA sensors for battery charging (cumulative kWh)",
          "items": {
            "type": "string"
          },
          "default": []
        },
        "entities battery production": {
          "type": "array",
          "description": "HA sensors for battery discharging (cumulative kWh)",
          "items": {
            "type": "string"
          },
          "default": []
        },
        "entity co2-intensity": {
          "type": "array",
          "description": "HA sensors for CO2 intensity",
          "items": {
            "type": "string"
          },
          "default": []
        }
      }
    },
    "scheduler": {
      "type": "object",
      "description": "Task scheduler configuration",
      "properties": {
        "active": {
          "type": "string",
          "enum": ["True", "False"],
          "default": "True",
          "description": "Whether scheduler is active"
        }
      },
      "patternProperties": {
        "^(xx|[0-2][0-9])[0-5][0-9]$": {
          "type": "string",
          "enum": [
            "get_meteo_data",
            "get_day_ahead_prices",
            "get_tibber_data",
            "calc_optimum",
            "clean_data",
            "calc_baseloads"
          ],
          "description": "Task to execute at specified time (HHmm or xxmm for every hour)"
        }
      },
      "additionalProperties": false
    }
  },
  "$defs": {
    "solarInstallation": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "description": "Installation name"
        },
        "entity pv switch": {
          "type": "string",
          "default": "",
          "description": "HA input_boolean to enable/disable PV installation"
        },
        "max power": {
          "type": "number",
          "minimum": 0,
          "description": "Maximum power in kW (if MPPT limits below panel capacity)"
        },
        "strings": {
          "type": "array",
          "description": "PV strings configuration (one or more)",
          "items": {
            "type": "object",
            "properties": {
              "tilt": {
                "type": "number",
                "minimum": 0,
                "maximum": 90,
                "description": "Panel tilt angle in degrees (0=flat, 90=vertical)"
              },
              "orientation": {
                "type": "number",
                "minimum": -180,
                "maximum": 180,
                "description": "Panel orientation in degrees (0=south, -90=east, 90=west)"
              },
              "capacity": {
                "type": "number",
                "minimum": 0,
                "description": "Peak capacity in kWp"
              },
              "yield": {
                "type": "number",
                "minimum": 0,
                "description": "Yield factor kWh/J/cm² (annual kWh / 400000)"
              }
            },
            "required": ["tilt", "orientation", "capacity", "yield"]
          },
          "minItems": 1
        },
        "tilt": {
          "type": "number",
          "minimum": 0,
          "maximum": 90,
          "description": "Panel tilt (for single-string shorthand)"
        },
        "orientation": {
          "type": "number",
          "minimum": -180,
          "maximum": 180,
          "description": "Panel orientation (for single-string shorthand)"
        },
        "capacity": {
          "type": "number",
          "minimum": 0,
          "description": "Peak capacity (for single-string shorthand)"
        },
        "yield": {
          "type": "number",
          "minimum": 0,
          "description": "Yield factor (for single-string shorthand)"
        }
      },
      "required": ["name"],
      "oneOf": [
        {
          "required": ["strings"]
        },
        {
          "required": ["tilt", "orientation", "capacity", "yield"]
        }
      ]
    }
  }
}
